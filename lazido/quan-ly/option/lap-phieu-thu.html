<!DOCTYPE html>
<html lang="vi" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="geo.region" content="vi">
    <meta name="language" content="vi">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>LOZIDO - Tất cả phiếu thu tiền nhà(hóa đơn)</title>
    <meta name="keywords" content="Phần mềm nhà trọ, phần mềm phòng trọ, phần mềm quản lý nhà trọ, phần mềm quản lý nhà trọ, quản lý nhà trọ, quản lý trọ, quản lý phòng trọ">
    <meta name="description" content="Phần mềm quản lý nhà  trọ trên điện thoại, máy tính, máy tính bảng, iPad hỗ trợ chủ nhà quản lý nhà trọ, phòng trọ, ký túc xá dễ dàng và tiện lợi mọi lúc mọi nơi, tiết kiệm thời gian và công sức">

    <meta name="robots" content="noindex, nofollow" />
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="csrf-token" content="CZqXP04OzKEuLEt01gkxMY2DrN3sCqnCK8eSZ2o4">

    <meta name="author" content="LOZIDO - Quản lý nhà cho thuê">
    <meta name="copyright" content="LOZIDO - Quản lý nhà cho thuê - Platform Quan ly nha tro, phong tro">
    <meta name="abstract" content="Phần mềm quản lý nhà trọ, phòng trọ, ký túc xá, chung cư tốt nhất hiện nay">

    <meta property="og:image" content="https://quanlytro.me/householder-admin/images/lozido_facebook-recovered.jpg">
    <meta property="og:image:secure_url" content="https://quanlytro.me/householder-admin/images/lozido_facebook-recovered.jpg">
    <meta property="og:image:width" content="800">
    <meta property="og:image:height" content="370">
    <meta property="og:image:type" content="image/webp">

    <link rel="shortcut icon" href="https://quanlytro.me/images/favicon.ico" type="image/x-icon">
    <link rel="alternate" href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu" hreflang="vi-vn" />

    <script type="text/javascript">
        var recaptcha_site_key = '6Ld0LAYeAAAAABA67PAls5DpnkfNJ-rkgHbsSilR';
        var __environment = 'production';
    </script>

    <script src="https://quanlytro.me/plugins/jquery-3.6.0/jquery.min.js"></script>
    <script src="https://quanlytro.me/plugins/jquery-3.6.0/jquery-ui-1.8.13.min.js"></script>
    <script src="https://quanlytro.me/plugins/feather.min.js"></script>
    <!-- <script src="https://quanlytro.me/plugins/sweetalert2@11"></script>
    <script src="https://quanlytro.me/bootstrap-5.0/js/popper.min.js"></script> -->
    <script src="https://quanlytro.me/bootstrap-5.0/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/helper.js?version=1.3.8"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/format.js?version=1.3.8"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/route-api.js?version=1.3.8"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/index.js?version=1.3.8"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/transporter.js?version=1.3.8"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/upload-image.js?version=1.3.8"></script>
    <style>
        .modal.show .btn-close {
            outline: 0;
            box-shadow: 0 0 0 .25rem rgb(255 87 34 / 9%);
            opacity: 1;
            border-radius: 100%;
            padding: 10px;
        }
        .btn{
            font-size: 14px!important;
            font-weight: 600!important;
        }
    </style>
    <script type="text/javascript">
        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        var __current_block = JSON.parse(JSON.stringify({"id":7081,"name":"ASUS","name_full":"Nh\u00e0 tr\u1ecd ASUS","user_id":8151,"category":0,"category_name":"Nh\u00e0 tr\u1ecd","category_name_short":"Nh\u00e0 tr\u1ecd","room_type":"room","room_type_name":"ph\u00f2ng","type":"floors","room_total":6,"count_floor":2,"area":15,"room_amount":36,"ele_amount":0,"water_amount":0,"price_items_cache":[{"id":23351,"name":"Ti\u1ec1n \u0111i\u1ec7n","type":"constant","unit":"kwh","price":1700,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"ele","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"KWh","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1},{"id":23352,"name":"Ti\u1ec1n n\u01b0\u1edbc","type":"constant","unit":"khoi","price":18000,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"water","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"Kh\u1ed1i","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1}],"circle_order":6,"deadline_bill":10,"bill_setting":{"note":{"content":null},"enable_qr":1,"payment_default":"cash","show_circle_day":0,"single_send_zalo":0,"template_bill_zalo":1,"enable_rounding_money":1,"extract_receipt_expense":0},"app_renter_setting":{"allow_update_car":1,"default_password":123456789,"allow_close_clock":0,"auto_create_account":0,"allow_ticket_contract":1,"allow_update_customer":1},"room_group":[{"id":1,"name":"T\u1ea7ng tr\u1ec7t","index":0,"label":"T\u1ea7ng tr\u1ec7t","value":1},{"id":2,"name":"T\u1ea7ng 1","index":1,"label":"T\u1ea7ng 1","value":2}],"max_member":1,"open_door":null,"close_door":null,"rule":null,"extension":null,"data_log":{"menu_label":{"pay_bill":0,"room_list":"0\/6","new_session":6,"deposit_request":6,"terminate_contract":0}},"setting":{"car_function":1,"post_function":1,"agent_function":1,"asset_function":1,"price_item_ele":3,"price_item_wifi":0,"price_item_trash":0,"price_item_water":3,"task_job_function":1,"send_sms_when_create_bill":1,"contract_document_function":0},"province_id":72,"district_id":712,"ward_id":25732,"address_component":{"address":"63, An T\u1ecbnh, Tr\u1ea3ng B\u00e0ng, T\u00e2y Ninh","ward_id":"25732","position":{"latitude":"10.7829132","longitude":"106.6961898"},"district_id":"712","province_id":"72","address_detail":"63"},"address":"63, An T\u1ecbnh, Tr\u1ea3ng B\u00e0ng, T\u00e2y Ninh","latitude":10.7829132,"longitude":106.6961898,"auto_create_room":1,"post_ids":[]}));

        var __permission_block = JSON.parse(JSON.stringify(null));

        let user = JSON.parse(JSON.stringify({"staff":false,"free":false,"trial":true,"fee":false}));
       
    </script>
    <link href="/bootstrap-5.0/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
                        <link href="/householder-admin/css/common.cssversion=1.3.8.css"
                rel="stylesheet">
                    <link href="/householder-admin/css/block.cssversion=1.3.8.css"
                rel="stylesheet">
            </head>

<body>
    <div id="app_loading" class="text-center" style="padding:40vh 10px">
        <div class="inner-loading">
            <img style="margin: auto" src="/images/icons/loading.gif" alt="Đang tải..." width="50px"/>
            <i class="loading_text" style="font-size: 13px; margin-top: -10px;">Đang tải dữ liệu...</i>
        </div>
    </div>
    <header>
    <div class="header-inner">
                <div class="header-sticky">
            <nav class="navbar navbar-expand-lg navbar-light">
                <div class="container-fluid">
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                            data-bs-target="#lozido-main-menu" aria-controls="lozido-main-menu" aria-expanded="false"
                            aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"> </span>
                    </button>
                    <nav class="collapse navbar-collapse lozido-main-menu">
                        <ul class="navbar-nav main-menu-left  me-auto mb-2 mb-lg-0">
                            <li class="nav-item menu-item active">
                                <a href="/" class="nav-link ">
                                    <i data-feather="arrow-left"></i>
                                                                            <img width="180px" src="/images/logo-lozido-quan-ly-tro-white.png"/>
                                                                    </a>
                            </li>
                        </ul>

                        <ul class="topbar-items main-menu-right navbar-nav">
                                                                                                <li class="nav-item menu-item active">
                                        <a href="/quan-ly.html" class="nav-link ">
                                            <i data-feather="home"></i>
                                            <span style="margin-top: 5px" class="text">Quản lý nhà</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/bao-cao.html" class="nav-link ">
                                            <i data-feather="pie-chart"></i>
                                            <span style="margin-top: 5px" class="text">Tổng báo cáo</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/dang-tin.html" class="nav-link ">
                                            <i data-feather="plus"></i>
                                            <span style="margin-top: 5px" class="text">Đăng tin</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/moi-gioi.html" class="nav-link ">
                                            <i data-feather="users"></i>
                                            <span style="margin-top: 5px" class="text">Môi giới</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/phan-quyen.html" class="nav-link ">
                                            <i data-feather="box"></i>
                                            <span style="margin-top: 5px" class="text">Công ty/nhóm</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/cai-dat.html" class="nav-link ">
                                            <i data-feather="settings"></i>
                                            <span style="margin-top: 5px" class="text">Cài đặt chung</span>
                                        </a>
                                    </li>
                                                                                                                                                                                                                                                                                            <li class="nav-item btn-group menu-item ">
                                        <a href="javascript:;" class="nav-link" data-bs-toggle="dropdown" aria-expanded="false">
                                            <span class="count-notification badge">0</span>
                                            <i data-feather="bell"></i>
                                            <span style="margin-top: 5px" class="text">Thông báo</span>
                                        </a>
                                        <ul class="dropdown-menu notication-dropdown dropdown-menu-lg-end">
                                            <div class="text-center" style="padding: 20px">
                                                <img style="margin: auto" src="/images/icons/loading.gif" alt="Đang tải..." width="50px"/>
                                                <div>
                                                    <i class="loading_text" style="font-size: 13px; margin-top: -10px;">Đang tải thông báo...</i>
                                                </div>
                                            </div>
                                        </ul>
                                    </li>

                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/tai-khoan.html" class="nav-link ">
                                            <i data-feather="user"></i>
                                            <span style="margin-top: 5px" class="text">Tài khoản</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/dang-xuat" class="nav-link ">
                                            <i data-feather="log-out"></i>
                                            <span style="margin-top: 5px" class="text">Đăng xuất</span>
                                        </a>
                                    </li>
                                                                                                                    </ul>
                    </nav>
                </div>
            </nav>
        </div>
    </div>
</header>
    <div>
                    <div>
                <style type="text/css">
    .scrollable-content {
        overflow-x: auto;
        white-space: nowrap;
        flex: 1;
        position: relative;
        scroll-behavior: smooth; /* Thêm hiệu ứng cuộn mượt */
    }
    .scrollable-content-container button {
        color: #fff;
        border: none;
        cursor: pointer;
        transition: opacity 0.3s ease;
        position: absolute;
        top: 50%;
        height: 96%;
        width: 50px;
        transform: translateY(-50%);
        z-index: 1;
    }
    .scrollable-content-container button::before{
        content: "";
        position: absolute;
        top: 50%;
        left: 10px;
        transform: translateY(-50%);
        width: 30px;
        height: 30px;
        border-radius: 100%;
        background: #000;
        z-index: -1;
    }
    .scrollable-content-container button:hover::before {
        background-color: #2f8932;
    }

    .scrollable-content-container button.hidden {
        opacity: 0;
        pointer-events: none; /* Ngăn chặn sự kiện chuột khi ẩn */
    }

    .scrollable-content-container .scroll-left{
        left: 0px;
        flex: 0 0 auto;
        background: linear-gradient(to right, rgb(255 255 255), rgb(255 255 255 / 0%));
    }
    .scrollable-content-container .scroll-right {
        right: 0px;
        flex: 0 0 auto;
        background: linear-gradient(to left, rgb(255 255 255), rgb(255 255 255 / 0%));
    }
</style>

<div style="min-height: 125px;display: flex;padding: 0px 10px 0px 0px;">
    <div class="col-md-2 d-flex align-items-center justify-content-center" style="margin-right: 10px;">
        <div class="current-block d-flex align-items-center" style="position: relative" data-bs-toggle="modal" data-bs-target="#manageBlock">
            <div class="d-flex align-items-center" style="flex-direction: row; flex:1">
                <div class="icon-blocks">
                    <span class="count-block">1</span>
                    <i data-feather="home" class="feather-size-18"> </i>
                </div>

                <div style="padding: 20px 0px 20px 5px; flex:1">
                    <span style="font-size: 12px;">Đang quản lý</span>
                    <h4 style="font-size: 14px; color: #15a05c; padding:0px; margin:0px; white-space: nowrap;max-width: 150px; overflow: hidden; text-overflow: ellipsis; ">
                        <span>Nhà trọ ASUS</span>
                    </h4>
                </div>
            </div>
                            <button class="shadow" id="add-block"
                        style="position: absolute;
                        right: -14px;
                        top: 29px;
                        border-radius: 100%;
                        height: 35px;
                        width: 35px;
                        text-align: center;
                        padding: 0px;
                        background-color: #7dc343;
                        color: #fff;
                        border: 1px solid #7dc443;
                        z-index: 10;"
                        data-bs-toggle="modal" data-bs-target="#addBlock">
                    <span data-bs-toggle="tooltip" data-bs-placement="top" title="Thêm mới nhà cho thuê">
                        <i data-feather="plus"> </i>
                    </span>
                </button>
                    </div>
    </div>
    <div class="col-md-10" style="align-items: center; justify-content: space-between; display: flex;">
        <div class=" scrollable-content-container" style="position: relative; align-items: center; justify-content: space-between; display: flex;overflow: hidden;">
            <button class="scroll-left">←</button>
            <div style="display: flex; flex-wrap: nowrap; overflow-x: auto; position: relative;" class="scrollable-content">    
                                                                                        <a href="/quan-ly.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/thu_tien.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý phòng</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/lap-phieu-thu.html" class="item-menu active">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/thu_tien.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý hóa đơn</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/quan-ly-dich-vu.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/ghi_chu.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý dịch vụ</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/quan-ly-tai-san.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/ghi_chu.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý tài sản</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/tat-ca-hop-dong.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/report_customer_use.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý hợp đồng</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/tat-ca-khach-thue.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/danh_sach_lien_he.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý khách thuê</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/thu-chi-tong-ket.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/thu_tien.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Thu/Chi - Tổng kết</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/cai-dat-nha-tro.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/setting.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Cài đặt</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/lich-su-gui-zalo.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=45px src="/images/icons/icon-zalo.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Lịch sử gửi zalo</b></span>
                                </div>
                            </a>
                                                </div>
            <button class="scroll-right">→</button> 
        </div>       
    </div>
</div>

<script type="text/javascript">
    const $scrollableContent = $('.scrollable-content');
    const $scrollLeft = $('.scroll-left');
    const $scrollRight = $('.scroll-right');

    function updateButtonVisibility() {
        const scrollLeft = $scrollableContent.scrollLeft();
        const scrollWidth = $scrollableContent[0].scrollWidth-10;
        const clientWidth = $scrollableContent[0].clientWidth;

        $scrollLeft.toggleClass('hidden', scrollLeft === 0);
        $scrollRight.toggleClass('hidden', scrollLeft + clientWidth >= scrollWidth);
    }

    $scrollLeft.click(function() {
        $scrollableContent.animate({ scrollLeft: 0 }, 100); // Hiệu ứng cuộn mượt
    });

    $scrollRight.click(function() {
        const scrollWidth = $scrollableContent[0].scrollWidth-10;
        $scrollableContent.animate({ scrollLeft: scrollWidth }, 100); // Hiệu ứng cuộn mượt
    });

    $scrollableContent.on('scroll', updateButtonVisibility);

    updateButtonVisibility(); // Cập nhật trạng thái nút khi trang được tải
</script>
                <div style="padding:15px 15px 15px 15px; background-color: #fff; border-radius: 10px; margin: 0 10px 10px 10px">
                    <style>
    .item-month {
        text-align: center;
        padding: 5px;
        cursor: pointer;
        font-size: 14px;
        line-height: 130%;
    }

    .item-month.active,.item-month:hover {
        background-color: #ecfff6;
        color: #198754;
        /* max-height: 52px; */
        border-radius: 5px;
        border: 1px solid #a0d7bd;
        box-shadow: 0 0 0 .16rem rgb(37 160 92 / 22%);
    }

    .white-space-break {
        white-space: break-spaces !important;
    }

    .tabulator-row.done-background{
        background-color: #4caf5029!important
    }

    .tabulator-row.cancel-background{
        background-color: #eeeeee82!important
    }
    .tabulator-row.enable-background{
        background-color: #ff57220f!important
    }
    .tabulator-row .tabulator-frozen.tabulator-frozen-right{
        background-color: #fff4e4!important
    }
    .item-month {
    position: relative;
}

.item-month .red-dot {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 8px;
    height: 8px;
    background-color: red;
    border-radius: 50%;
    display: inline-block;
}
</style>
<div class="page-bills">
    <div class="month-container d-flex"
         style="align-items: center; justify-content: space-between;border: 1px solid #ebeced;background-color: #f7f7f7;border-radius: 10px;padding: 5px 10px;">
        <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=12&year=2023" class="pre-year text-start"
           style="width: 7.1428571428571%">
            <i data-feather="arrow-left"></i>
            Năm trước
        </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=1&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 1/2024">
                <div class="month-text">
                    <b class="10">T.1</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=2&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 2/2024">
                <div class="month-text">
                    <b class="10">T.2</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=3&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 3/2024">
                <div class="month-text">
                    <b class="10">T.3</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=4&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 4/2024">
                <div class="month-text">
                    <b class="10">T.4</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=5&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 5/2024">
                <div class="month-text">
                    <b class="10">T.5</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=6&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 6/2024">
                <div class="month-text">
                    <b class="10">T.6</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=7&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 7/2024">
                <div class="month-text">
                    <b class="10">T.7</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=8&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 8/2024">
                <div class="month-text">
                    <b class="10">T.8</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=9&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 9/2024">
                <div class="month-text">
                    <b class="10">T.9</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=10&year=2024"
               class="item-month active" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 10/2024">
                <div class="month-text">
                    <b class="10">T.10</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=11&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 11/2024">
                <div class="month-text">
                    <b class="10">T.11</b>
                </div>
                <span>2024</span>
                            </a>
                    <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=12&year=2024"
               class="item-month" style="width: 6.1428571428571%"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Xem hóa đơn tháng 12/2024">
                <div class="month-text">
                    <b class="10">T.12</b>
                </div>
                <span>2024</span>
                            </a>
        
        <a href="https://quanlytro.me/quan-ly/7081/lap-phieu-thu?month=1&year=2025" class="next-year text-end"
           style="width: 7.1428571428571%">
            Năm tới
            <i data-feather="arrow-right"></i>
        </a>
    </div>

    <div class="header-item">
        <h4 class="title-item">
            Tất cả hóa đơn - 10/2024
            <i style="font-size: 14px;
                font-weight: normal;">Tất cả hóa đơn thu tiền nhà xuất hiện ở đây</i>
        </h4>
        <div style="display: flex; justify-content: center; align-items: center;">
                            <div data-bs-toggle="modal" data-bs-target="#billSeries">
                    <div class="add-round" data-bs-toggle="tooltip" data-bs-placement="left" title="Tạo hóa đơn mới">
                        <i data-feather="plus"> </i>
                    </div>
                </div>
                                        <a href="/quan-ly/7081/cai-dat-nha-tro#bill_setting" class="btn btn-primary" data-bs-toggle="tooltip" data-bs-placement="left" title="Cài đặt hiển thị hóa đơn. Xuất, gửi hóa đơn tự động..." style="box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, .15) !important;margin-left: 25px;padding: 11px 20px;">
                    <i data-feather="settings"> </i>
                    <span>Cài đặt hóa đơn</span>
                </a>
                
                <div class="d-flex">
                    <div style="width: 2px;border-left: 2px solid #ccc; margin: 3px 0px; margin-left: 10px">  </div>
                    <button style="margin-left: 10px" id="print" class="btn btn-primary">
                        <i data-feather="printer"></i>
                        In h.đơn
                    </button>
                    <button style="margin: 0 10px; padding: 11px 20px;" id="download-excel-template-2" class="btn btn-primary">
                        <i data-feather="file-text"></i>
                        Xuất excel(Rút gọn)
                    </button>
                    <button id="download-excel-template-1" style="padding: 11px 20px;" class="btn btn-primary">
                        <i data-feather="file-text"></i>
                        Xuất excel(Đầy đủ)
                    </button>
                </div>
                    </div>
    </div>

    <script type="text/javascript" src="https://quanlytro.me/tabulator-5.5/dist/js/tabulator.js"></script>
    <script type="text/javascript" src="https://quanlytro.me/tabulator-5.5/dist/js/jquery_wrapper.js"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/tabulator-setting.js?version=1.3.8"></script>

    <script type="text/javascript" src="https://quanlytro.me/householder-admin/plugins/flatpickr/js/flatpickr-4.6.9.min.js"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/plugins/flatpickr/js/month-select-4.6.9.min.js"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/plugins/flatpickr/js/vn.js"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/plugins/xlsx.full.min.js"></script>

    <link href="https://quanlytro.me/householder-admin/plugins/flatpickr/css/flatpickr.min.css" rel="stylesheet">
    <link href="https://quanlytro.me/householder-admin/plugins/flatpickr/css/month-select.min.css" rel="stylesheet">
    <link href="https://quanlytro.me/tabulator-5.5/dist/css/tabulator_semanticui.min.css" rel="stylesheet">

    <script type="text/javascript">
        Tabulator.extendModule("edit", "editors", common_editors);
        Tabulator.extendModule("format", "formatters", {
                ...common_formatters,
                roomNameOfBill: function(cell, formatterParams){
                    return `<div style="line-height: 115%;width: 100%;"><strong>${cell.getData().room.name}</strong><div style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;color: #15a05c;"><i style="font-size: 12px;">${cell.getData().reason}</i></div><span style="font-size: 11px;">(${cell.getData().date_format})</span></div>`;
                },
                total_bill: function (cell, formatterParams){
                    return `
                    <div style="line-height: 115%;width: 100%;">
                        <strong>${__format.currency(cell.getData().total)}</strong>
                        ${cell.getData().paid_total > 0 ? '<div><div style="font-size: 10px"><i>Số tiền đã thu</i></div><b style="color: #15a05c;">'+ __format.currency(cell.getData().paid_total) +'</b></div>' : ""}
                    </div>`;
                },
                status_bill: function (cell, formatterParams){
                    var data = cell.getData();
                    return `<div><span class="badge" style="background-color: ${data.status_color}">${cell.getValue()}</span><br><span style="color:${cell.getData().send_to_customer_status_color};font-size: 9px;">${cell.getData().send_to_customer_status_text}</span></div>`;
                },
                remain_total: function (cell, formatterParams) {
                    if (cell.getValue() < 0) {
                        cell.getElement().classList.add("warning-text");
                    } else {
                        cell.getElement().classList.remove("warning-text");
                    }
                    return `
                    <div style="line-height: 115%;width: 100%;">
                        <b>
                            ${__format.currency(cell.getValue())}
                        </b>
                        ${cell.getData().bill_request > 0 ? '<div style="font-size: 10px"><i style="color: #ff0404;">'+cell.getData().bill_request_text+'</i></div>' : ""}
                    </div>`;
                },
                price_item_subtraction:function (cell, formatterParams) {
                    var data = cell.getData();
                    let amount = text = cell.getValue() >= 0 ? `<b>${__format.currency(cell.getValue())}</b>` : `<b>0 }</b>`;
                    let use_description = data.price_items[formatterParams['key_price_item']]?.use_description ? `(${data.price_items[formatterParams['key_price_item']].use_description})` : '';
                    let total_description = data.price_items[formatterParams['key_price_item']]?.total_description ? `${data.price_items[formatterParams['key_price_item']].total_description}` : '';
                    if(data?.price_items)
                        text = `<div>${amount}</div><div style="font-size: 10px;">${use_description}</div><div style="font-size: 10px; color: #238f2f">${total_description}</div>`;

                    return `<div>${text}</div>`;
                },
            });
        Tabulator.extendModule("validate", "validators", common_validators);
        Tabulator.extendModule("accessor", "accessors", common_accessor);
    </script>

    <div class="header-table header-item">
        <div class="d-flex">
            <div class="icon">
                <i data-feather="filter"> </i>
                <span id="filter-count">0</span>
            </div>
            <div class="d-flex">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="filter_done" data-value="status" value="done">
                    <label class="form-check-label" for="filter_done">Hóa đơn đã thu</label>
                    <span class="count-filter done success">0</span>
                </div>

                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="filter_new" data-value="status" value="new">
                    <label class="form-check-label" for="filter_new">Hóa đơn chưa thu</label>
                    <span class="count-filter new warning">0</span>
                </div>

                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="filter_customer_debt" data-value="status"
                           value="customer_debt">
                    <label class="form-check-label" for="filter_customer_debt">Hóa đơn đang nợ</label>
                    <span class="count-filter debt error">0</span>
                </div>

                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="filter_cancel" data-value="status"
                           value="cancel">
                    <label class="form-check-label" for="filter_cancel">Hóa đơn đã hủy</label>
                    <span class="count-filter cancel disable">0</span>
                </div>
            </div>
        </div>
        <div class="d-flex" style="align-items: center;">
            <select class="sort-bill" style="height: 35px; border-radius: 7px; margin-right: 10px;">
                <option value="room-asc">Thứ tự phòng tăng dần</option>
                <option value="room-desc">Thứ tự phòng giảm dần</option>

                <option value="date-desc">Sắp xếp theo ngày giảm dần</option>
                <option value="date-asc">Sắp xếp theo ngày tăng dần</option>
            </select>
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
        </div>
    </div>
    <div id="table" class="table_bills celled"></div>

    <div id="buttom-save-container">
        <div style="margin-right: 10px">Bạn có <span id="count-edit">5</span> mục thay đổi bạn có muốn lưu ?
        </div>
        <div class="btn btn-danger" id="clear-change" style="margin-right: 10px"><i data-feather="x"></i> Xóa tất cả
            thay đổi
        </div>
        <div class="btn btn-primary" id="save-change"><i data-feather="save"></i> Lưu thay đổi</div>
    </div>
    <script type="text/javascript">
        $(document).ready(function () {
            var __el = {
                table: $("#table"),
                filter_check: $(".header-table .form-check-input"),
                count_filter: $("#filter-count"),
                count_edit: $("#count-edit"),
                button_save_container: $("#buttom-save-container"),
                save_change: $("#save-change"),
                clear_change: $("#clear-change"),
                download_1: $("#download-excel-template-1"),
                download_2: $("#download-excel-template-2"),
                print_list: $("#print")
            };

            let block_bill_setting = JSON.parse(JSON.stringify({"note":{"content":null},"enable_qr":1,"payment_default":"cash","show_circle_day":0,"single_send_zalo":0,"template_bill_zalo":1,"enable_rounding_money":1,"extract_receipt_expense":0}));

            var dataEdited = {};
            var dataTemp = 0;
            var tableDataNewSession = {};
            var tableDataInit = [];
            var tableData = {};
            let columns = {};
            let columnsInit = {};
            let errorPriceItem = {};
            var groupValues = [];
            let filters = {
                status: [],
                month: parseInt(`10`),
                year: parseInt(`2024`)
            };
            let additionModal = new __modalEditCell(
                $("#additionModal").get(0),
                $('#addition-form').get(0),
                $('#submit-addition-form').get(0)
            );

            let depositModal = new __modalEditCell(
                $("#depositModal").get(0),
                $('#deposit-form').get(0),
                $('#submit-deposit-form').get(0)
            );

            let editBillModal = new __modalEditCell(
                $("#editBill").get(0),
                $('#edit-bill-form').get(0),
                $('#submit-edit-bill').get(0)
            );

            //Build Tabulator
            var table = new Tabulator(__el.table.get(0), {
                index: 'id',
                layout:"fitColumns",
                reactiveData: true,
                height: false,
                columnHeaderVertAlign: 'middle',
                movableRows: false,
                selectable: false,
                minHeight: 200,
                groupHeader: function (value, count, data, group) {
                    let findGroupDetail = __helper.array.findObjectInArray(value, 'id', __current_block?.room_group);
                    
                    if(count === 0){
                        return "<span style='color:red;'>Không có hóa đơn</span>";
                    }

                    return `${findGroupDetail?.name ?? value}<span style='color:#d00; margin-left:10px;'>(${count} hóa đơn)</span>`;
                },
                groupHeaderDownload: function(value, count, data, group){
                    let findGroupDetail = __helper.array.findObjectInArray(value, 'id', __current_block?.room_group);
                    return findGroupDetail?.name ?? value;
                },
                rowFormatter:function(row){
                    var data = row.getData();
                    
                    if(['done'].includes(row.getData().status)){
                        row.getElement().classList.add("done-background");
                    }else if(['cancel'].includes(row.getData().status)){
                        row.getElement().classList.add("cancel-background");
                    }else{
                        row.getElement().classList.add("enable-background");
                    }
                },
                placeholder: `<div class="empty-table" style="margin: auto; display: inline-grid;"><img width="300px" src="https://quanlytro.me/images/empty-box-4085812-3385481.webp" />Không tìm thấy dữ liệu!</div>`,
            });

            table.on("cellEdited", function (cell) {
                // console.log('cell edit: ', cell.getValue(), cell.getInitialValue(), cell.getValue()!=='', cell.getInitialValue(), cell.getInitialValue()===undefined);
                if (true || cell.getValue() !== cell.getInitialValue() && (cell.getValue()!=='' || (cell.getInitialValue() && cell.getInitialValue()===undefined))) {
                    //@TODO: nếu chỉnh sửa các mục không liên quan thì không cập nhật
                    let priceItemsTotal = 0;
                    cell.getData().is_edited = true;
                    cell.getData().price_items &&
                    cell.getData().price_items.map((item) => {
                        if (item?.subtraction) {
                            item.total = (parseInt(item?.value[1] ?? 0) - parseInt(item?.value[0] ?? 0)) * item.price;
                            if (parseInt(item?.value[1] ?? 0) - parseInt(item?.value[0] ?? 0) > 0) {
                                item.is_check = 1;
                            } else {
                                item.is_check = 0;
                            }
                        } else {
                            let total = item?.value ? (parseInt(item?.value[0] ?? 0) * item.price) : 0;
                            if(['nguoi', 'chiec', 'thang'].includes(item.unit)){
                                total = cell.getData().month_amount * total + __helper.roundingMoney(cell.getData().day_amount * total / 30);
                            }
                            item.total = total;

                            let path = cell.getField().split(".");
                            if (path && path[0] === 'price_items') {
                                if (item?.value && parseInt(item?.value[0])) {
                                    item.is_check = 1;
                                } else {
                                    item.is_check = 0;
                                }
                            }
                        }

                        priceItemsTotal += item.total;

                        return item;
                    });
                    let room_amount_per_day = (cell.getData().room_amount_unit / 30);
                    let total_room_by_month = room_amount_per_day * parseInt(cell.getData().month_amount) * 30;
                    let total_room_by_day = room_amount_per_day * parseInt(cell.getData().day_amount);
                    
                    let deposit_contract_amount = parseInt(cell.getData().deposit_contract_amount ?? 0);
                    let addition_value = parseInt(cell.getData().addition_value);

                    cell.getData().total_room_amount = total_room_by_month + total_room_by_day;
                    let total = total_room_by_month + total_room_by_day + deposit_contract_amount+ priceItemsTotal + addition_value;
                    if(block_bill_setting?.enable_rounding_money){
                       total = __helper.roundingMoney(total);
                    };

                    cell.getData().total = total;
                    cell.getData().remain_total = cell.getData().total;
                  
                    // Cập nhật data
                    cell.getRow().update(cell.getData());
                    
                    dataEdited[cell.getData().id] = cell.getData();
                    $(cell.getRow().getCell('id').getElement()).find('div').addClass("edited");
                    checkShowEdit();
                    __el.count_edit.text(Object.keys(dataEdited).length);
                }
            });

            function renderCount(){
                __el.count_filter.text(table.getData().length);
                if(tableDataInit?.length >=1 ){
                    $(".count-filter.done").text(__countStatus(tableDataInit, 'done'));
                    $(".count-filter.new").text(__countStatus(tableDataInit, 'new'));
                    $(".count-filter.debt").text(__countStatus(tableDataInit, 'customer_debt'));
                    $(".count-filter.cancel").text(__countStatus(tableDataInit, 'cancel'));
                }
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                });
            }

            window.billTable = table;

            const preventEditCell = (cell) =>{
                let reason_id = cell.getData().reason_id;
                        
                let isShowRoomAmount = Boolean(reason_id === 1 || reason_id === 2 || reason_id === 4);
                let isShowPriceItem = Boolean((reason_id === 1 || reason_id === 2 || reason_id === 3 || reason_id === 4 || reason_id === 5));
                
                let isShowDepositContractAdd = Boolean(reason_id === 2 || reason_id === 6);
                let isShowDepositContractReturn = Boolean(reason_id === 3 || reason_id === 7);
                let isShowDepositContract = Boolean(isShowDepositContractAdd || isShowDepositContractReturn);
                
                if(!isShowRoomAmount && (cell.getField()==='month_amount' || cell.getField()==='day_amount')){
                    Swal.fire({
                        title: 'Thông báo!',
                        text: `Bạn không thể chỉnh sửa tiền phòng/giường với lý do hóa đơn là: "${cell.getData().reason}"`,
                        icon: 'error',
                        confirmButtonColor: '#3c9e47',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                if(!isShowDepositContract && cell.getField()==='deposit_contract_amount'){
                    Swal.fire({
                        title: 'Thông báo!',
                        text: `Bạn không thể chỉnh sửa tiền cọc với lý do hóa đơn là: "${cell.getData().reason}"`,
                        icon: 'error',
                        confirmButtonColor: '#3c9e47',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                if(!isShowPriceItem && cell.getField().includes("price_items")){
                    Swal.fire({
                        title: 'Thông báo!',
                        text: `Bạn không thể chỉnh sửa dịch vụ với lý do hóa đơn là: "${cell.getData().reason}"`,
                        icon: 'error',
                        confirmButtonColor: '#3c9e47',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }
                
                if (['done', 'cancel','customer_debt'].includes(cell.getData().status)) {
                    let textAlert = '';
                    if(cell.getData().status === 'cancel')
                        textAlert = "Bạn không thể chỉnh sửa khi hóa đơn đã bị hủy";
                    else if(cell.getData().status === 'done')
                        textAlert = "Hóa đơn đã hoàn thành bạn không thể chỉnh sửa. Nếu có sai sót vui lòng xóa hóa đơn này và tạo hóa đơn mới";
                    else
                        textAlert = "Hóa đơn đang thu dở không thể chỉnh sửa. Nếu có sau sót vui lòng hủy hóa đơn này và tạo lại hóa đơn mới";
                    Swal.fire({
                        title: 'Thông báo!',
                        text: textAlert,
                        icon: 'error',
                        confirmButtonColor: '#3c9e47',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }
                return true;
            }

            const billCellClick = {
                alertDisableEditOfBill: function (e, cell) {
                    return preventEditCell(cell);
                },
                editAddition: function (e, cell) {
                    if(!preventEditCell(cell))
                        return false;                   

                    additionModal.showModal(cell, {
                        __submitModalForm: function (e) {
                            let data = $(this.form).getObjectOfForm();
                            if (parseInt(data?.addition_value) && data?.addition_reason?.length === 0) {
                                Swal.fire({
                                    title: 'Thông báo lỗi!',
                                    text: `Vui lòng nhập lý do ${data.addition === 1 ? 'cộng thêm' : 'giảm trừ'} khi áp dụng. Nếu không hãy xóa bỏ số tiền muốn ${data.addition === 1 ? 'cộng thêm' : 'giảm trừ'}`,
                                    icon: 'error',
                                    confirmButtonText: 'Đã hiểu'
                                });
                                return false;
                            }

                            this.cell.getData().addition = parseInt(data.addition);
                            this.cell.getData().addition_reason = data.addition_reason;
                            this.cell.setValue(parseInt(data.addition) * parseInt(__helper.convertStringToNumber(data.addition_value)));

                            this.modalInstance.hide();
                        },
                        __openModalForm: function (e) {
                            this.cell.getData().addition = this.cell.getData().addition_value < 0 ? -1 : 1;
                            $(this.form).setObjectToForm({
                                addition: this.cell.getData().addition,
                                addition_value: Math.abs(this.cell.getData().addition_value) ?? null,
                                addition_reason: this.cell.getData().addition_reason,
                            });

                            if (!parseInt(this.cell.getData().addition) || parseInt(this.cell.getData().addition) === 1) {
                                $(this.modal).find('.modal-title').text(`Cộng thêm cho hóa đơn`);
                                $(this.submit).text('Cộng thêm');
                            } else {
                                $(this.modal).find('.modal-title').text(`Giảm trừ cho hóa đơn`);
                                $(this.submit).text('Giảm trừ');
                            }
                        }
                    });
                },
                editDeposit: function (e, cell) {
                    if(!preventEditCell(cell))
                        return false; 

                    depositModal.showModal(cell, {
                        __submitModalForm: function (e) {
                            let data = $(this.form).getObjectOfForm();
                            if(parseInt(data.deposit) < 0){
                                if(parseInt(data.deposit_contract_amount) > parseInt(dataTemp)){
                                    Swal.fire({
                                        title: 'Thông báo!',
                                        text: 'Số tiền hoàn cọc phải nhỏ hơn số tiền cọc đã thu !',
                                        icon: 'warning',
                                        confirmButtonText: 'Đã hiểu'
                                    });
                                }else{
                                    this.cell.setValue(parseInt(data.deposit) * parseInt(__helper.convertStringToNumber(data.deposit_contract_amount)));
                                    this.modalInstance.hide();
                                }
                            }else{
                                this.cell.setValue(parseInt(data.deposit) * parseInt(__helper.convertStringToNumber(data.deposit_contract_amount)));
                                this.modalInstance.hide();
                            }   
                        },
                        __openModalForm: function (e) {
                            $.transferData({
                                method: "GET",
                                url: __helper.url.urlPattern(__routeApi.contract.show, {
                                    id : parseInt(this.cell.getData().contract_id)
                                }),
                                loadingEle:false,
                                success: (res) => {
                                    $(this.modal).find('.deposit-contact-paid').text(`${__format.currencyInput(res.data.deposit_contract_amount)}đ`);
                                    dataTemp = res.data.deposit_contract_amount
                                },
                                fail: (res) => {
                                    Swal.fire({
                                        title: 'Thông báo!',
                                        text: 'Đã xảy ra lỗi, vui long thử lại sau',
                                        icon: 'warning',
                                        confirmButtonText: 'Đã hiểu'
                                    });
                                }
                            });
                            let reason_id = this.cell.getData().reason_id;
                            let deposit = 0;
                            if(reason_id === 2 || reason_id === 6)
                                deposit = 1;
                            else if(reason_id === 3 || reason_id === 7)
                                deposit = -1;
                            
                            $(this.form).setObjectToForm({
                                deposit: deposit,
                                deposit_contract_amount: Math.abs(this.cell.getData().deposit_contract_amount) ?? null,
                            });

                            if (deposit === 1) {
                                $(this.modal).find('.modal-title').text(`Thu tiền cọc`);
                                
                                $(this.submit).text('Thu thêm');
                            } else {
                                $(this.modal).find('.modal-title').text(`Hoàn tiền cọc`);
        
                                $(this.submit).text('Hoàn trả');
                            }
                        },
                        __closeModalForm: function () {
                            $(this.modal).find('.deposit-contact-paid').text(`0đ`);
                            dataTemp = 0
                        },
                    });
                }
            };

            const prepareColumns = function (column) {
                if (column?.clickMenu && typeof commonClickMenu[column?.clickMenu] !== "undefined")
                    column.clickMenu = commonClickMenu[column?.clickMenu];

                if(__permission_block === null || __permission_block.bill.update){
                    if (column?.cellClick && typeof billCellClick[column?.cellClick] !== "undefined")
                        column.cellClick = billCellClick[column?.cellClick];

                    if(column?.validator && column?.validator === 'checkValuePriceItem'){
                        column.validator =  function (cell, value, parameters) {
                                // Luôn pass qua validate nhưng để cảnh báo cho khách hàng biết.
                                !!__getProperty(cell.getData().price_items, cell.getField(), 'price_items.');
                                let path = cell.getField().split(".");

                                let priceItem = cell.getData().price_items[path[1]];
                                if (priceItem) {
                                    let oldValue = [...priceItem[path[2]]];
                                    let index = parseInt(path.slice(-1)[0]);
                                    oldValue[index] = value;
                                    if ((parseInt(oldValue[1] ?? 0) - parseInt(oldValue[0] ?? 0)) < 0) {
                                        setTimeout(() => {
                                            let eleOther = index === 0 ? $(cell.getElement()).nextAll(".tabulator-cell").first() : $(cell.getElement()).prevAll(".tabulator-cell").first();
                                            eleOther.addClass("tabulator-validation-fail");
                                            $(cell.getElement()).addClass("tabulator-validation-fail");
                                        }, 200);
                                        errorPriceItem[priceItem.id] = {
                                            data: cell.getData(),
                                            price_item: priceItem,
                                            message: "Số mới phải lớn hơn số cũ"
                                        };
                                    } else {
                                        let eleOther = index === 0 ? $(cell.getElement()).nextAll('.tabulator-cell').first() : $(cell.getElement()).prevAll('.tabulator-cell');
                                        eleOther.removeClass("tabulator-validation-fail");
                                        $(cell.getElement()).removeClass("tabulator-validation-fail");

                                        if(typeof errorPriceItem[priceItem.id]!=='undefined'){
                                            delete errorPriceItem[priceItem.id];
                                        }
                                    }
                                } else {
                                    return (value > 0);
                                }

                                return true;
                            }
                    }

                    if (!column?.cssClass) {
                        if (column?.editor) {
                            column.cssClass = "edit_enable"
                        } else {
                            column.cssClass = "edit_disable";
                        }
                    }
                    
                    if (column?.editor && column?.editable === 'bill') {
                        column.editable = function (cell) {
                            let reason_id = cell.getData().reason_id;

                            let isShowRoomAmount = Boolean(reason_id === 1 || reason_id === 2 || reason_id === 4);
                            let isShowPriceItem = Boolean((reason_id === 1 || reason_id === 2 || reason_id === 3 || reason_id === 4 || reason_id === 5));
                            
                            let isShowDepositContractAdd = Boolean(reason_id === 2 || reason_id === 6);
                            let isShowDepositContractReturn = Boolean(reason_id === 3 || reason_id === 7);
                            let isShowDepositContract = Boolean(isShowDepositContractAdd || isShowDepositContractReturn);

                            let checkEdit = (
                                // Kiểm tra tiền phòng
                                (!isShowRoomAmount && (cell.getField()==='month_amount' || cell.getField()==='day_amount')) || 
                                // Kiểm tra tiền cọc
                                (!isShowDepositContract && cell.getField()==='deposit_contract_amount') ||
                                // Kiểm tra tiền dịch vụ
                                (!isShowPriceItem && cell.getField().includes("price_items"))
                            );

                            if(checkEdit){
                                return false;
                            }
                            
                            return !['done', 'cancel','customer_debt'].includes(cell.getData().status);
                        };
                    }
                }else{
                    column.editable = function (cell) {
                        return false;
                    } 
                }
                // tabulator-field
              
                return column;
            };

            const checkShowEdit = function () {
                dataEdited && Object.keys(dataEdited).length > 0 ?
                    __el.button_save_container.addClass('show') :
                    __el.button_save_container.removeClass('show');
            };

            const loadData = (filter = null) => $.transferData({
                method: "POST",
                url: __helper.url.urlPattern(__routeApi.bill.listByBlock, {
                    block_id: parseInt(7081)
                }),
                data: {
                    filter: filter ?? null
                },
                success: (res) => {
                    if (res?.data?.table_data?.columns && res?.data?.payload) {
                        columns = res?.data?.table_data?.columns;
                        tableData = res?.data?.payload;
                        let price_items_of_block = res?.data?.meta?.price_items_of_block;

                        columns.map((column) => {
                            prepareColumns(column);
                            if (column?.columns && column.columns.length > 0) {
                                column.columns.map((col, index_col) => {
                                    column.columns[index_col] = prepareColumns(col);
                                });
                            }
                            return column;
                        });

                        price_items_of_block &&
                        tableData.map((data) => {
                            let price_items_of_block_clone = JSON.parse(JSON.stringify(price_items_of_block));
                            // Thực hiển check các price có sử dụng cho bills
                            price_items_of_block_clone.map((item, key) => {
                                price_items_of_block_clone[key].is_check = 0;
                                price_items_of_block_clone[key].total = 0;
                                price_items_of_block_clone[key].value = [];

                                data.price_items &&
                                data.price_items.map((price_item) => {
                                    if (price_item.id === item.id) {
                                        price_items_of_block_clone[key].is_check = 1;
                                        price_items_of_block_clone[key].total               = price_item['total'];
                                        price_items_of_block_clone[key].value               = price_item['value'];
                                        price_items_of_block_clone[key].use_description     = price_item['use_description'];
                                        price_items_of_block_clone[key].use                 = price_item['use'];
                                        price_items_of_block_clone[key].total_description   = price_item['total_description'];
                                    }
                                });
                            });

                            data.price_items = price_items_of_block_clone;
                            return data;
                        });

                        tableDataNewSession = JSON.parse(JSON.stringify(tableData));
                        if(!tableDataInit || Object.keys(tableDataInit).length === 0){
                            tableDataInit = [...(res?.data?.payload ?? [])];
                        }
                        console.log(tableData);
                        
                        table.setColumns(columns);
                        table.setData(tableData);
                        table.setSort("room.sort", "asc");

                        if(__current_block?.room_group.length > 1){

                            __current_block?.room_group.map((item)=>{
                                groupValues.push(item.value);
                            });

                            groupValues = [...new Set(groupValues)];
                            table.setGroupBy(function(data) {
                                return data.room.group_id;
                            });
                            table.setGroupValues([groupValues]);
                        }
                    } else {
                        tableDataNewSession = null;
                        table.setData(null);
                        table.setSort("room.sort", "asc");
                    }
                    renderCount();
                },
                fail: (res) => {
                    tableDataNewSession = null;
                    table.setData(null);
                },
                error: (e) => {
                    console.log(e);
                }
            });

            loadData(filters);

            __el.filter_check.on('change', (e) => {
                let value = e.target.value.split(',');
                if (value.length > 1) {
                    let newData = [...filters[e.target.dataset.value]];
                    value.map((item) => {
                        __togglePresent(newData, item);
                    });

                    filters[e.target.dataset.value] = newData;
                } else {
                    let newData = [...filters[e.target.dataset.value]];
                    __togglePresent(newData, value[0]);
                    filters[e.target.dataset.value] = newData;
                }
                loadData(filters);
            });

            __el.clear_change.click(() => {
                dataEdited = {};
                checkShowEdit();

                table.setData(JSON.parse(JSON.stringify(tableDataNewSession)));
            });

            __el.save_change.click(() => {
                if (Object.keys(dataEdited).length === 0) {
                    Swal.fire({
                        title: 'Thông báo!',
                        text: 'Không có gì thay đổi!',
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });

                    return false;
                }

                if(errorPriceItem &&  Object.keys(errorPriceItem)?.length > 0){
                    for (const [index, itemError] of Object.keys(errorPriceItem).entries()) {
                        Swal.fire({
                            title: 'Thông báo!',
                            text: `${errorPriceItem[itemError]?.message}`,
                            icon: 'error',
                            confirmButtonText: 'Đã hiểu'
                        });
                        break;
                    }
                    return false;
                }
                
                let dataSend = JSON.parse(JSON.stringify(dataEdited));
                Object.keys(dataSend).map((itemEdit) => {
                    let price_items = [];
                    dataSend[itemEdit]?.price_items?.length > 0 &&
                    dataSend[itemEdit].price_items.map((item) => {
                        if (item.is_check){
                            price_items.push(item);
                        }
                    });
                    dataSend[itemEdit].price_items = price_items;
                });

                $.transferData({
                    method: 'POST',
                    url: __helper.url.urlPattern(__routeApi.bill.updateSeries, {
                        block_id: parseInt(7081)
                    }),
                    data: {
                        data_edited: dataSend
                    },
                    success: (res) => {
                        let price_items_of_block = res?.data?.price_items_of_block;
                        Swal.fire({
                            title: 'Thao tác thành công!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonText: 'Đã hiểu'
                        });
                        dataEdited = {};
                        checkShowEdit();

                        table.getRows().map((row)=>{
                            $(row.getCell('id').getElement()).find('div').removeClass("edited");
                        });

                        table.setData(table.getData().map((item) => {
                            item.is_edited = false;
                            return item;
                        }));

                        price_items_of_block &&
                        res?.data?.bills.map((data) => {
                            let price_items_of_block_clone = JSON.parse(JSON.stringify(price_items_of_block));
                            // Thực hiển check các price có sử dụng cho bills
                            price_items_of_block_clone.map((item, key) => {
                                price_items_of_block_clone[key].is_check = 0;
                                price_items_of_block_clone[key].total = 0;
                                price_items_of_block_clone[key].value = [];

                                data.price_items &&
                                data.price_items.map((price_item) => {
                                    if (price_item.id === item.id) {
                                        price_items_of_block_clone[key].is_check = 1;
                                        price_items_of_block_clone[key].total = price_item['total'];
                                        price_items_of_block_clone[key].value = price_item['value'];
                                    }
                                });
                            });

                            data.price_items = price_items_of_block_clone;
                            return data;
                        });

                        table.updateData(res?.data?.bills);
                    },
                    fail: (res) => {
                        console.log(res);
                    }
                });
            });

            __el.download_1.click((e) => {
                let sheetName = __current_block?.name.slice(0, 30).replace(/[:\.\/?*\[\]]/g, '_');
                table.download("xlsx", "hoa_don_thu_tien.xlsx", {sheetName:sheetName});
            });

            __el.download_2.click((e) => {
                let sheetName = __current_block?.name.slice(0, 30).replace(/[:\.\/?*\[\]]/g, '_');
                //lấy column short để download
                $.transferData({
                    method: "POST",
                    url: __helper.url.urlPattern(__routeApi.bill.shortColumn, {
                        block_id: parseInt(7081)
                    }),
                    data: {
                        filter: filters ?? null
                    },
                    success: (res) => {
                        var cols = table.getColumnDefinitions();
                        table.setColumns(res.data);// set column mới để download
                        table.download("xlsx", "hoa_don_thu_tien.xlsx", {sheetName:sheetName});
                        table.setColumns(cols); // sau khi download trả về lại colum ban đầu
                    },
                    fail: (res) => {
                        console.log(e);
                    },
                    error: (e) => {
                        console.log(e);
                    }
                });

                
            });

            __el.print_list.click((e) => {
                $.transferData({
                    method: "POST",
                    url: __helper.url.urlPattern(__routeApi.bill.showHtmlList),
                    data: {
                        filter: filters ?? null
                    },
                    success: (res) => {
                        w = window.open();
                        w.document.write(res.data);
                        w.print();
                        w.close();
                    },  
                    fail: (res) => {
                        console.log(res);
                    },
                    error: (e) => {
                        console.log(e);
                    }
                });
            })

            $('select.sort-bill').change((e)=>{
                let criteria = $(e.target).val();
                switch (criteria) {
                    case 'date-desc':
                        return table.setSort("date", "desc");
                    case 'date-asc':
                        return table.setSort("date", "asc");
                    case 'room-desc':
                        return table.setSort("room.sort", "desc");
                    case 'room-asc':
                        return table.setSort("room.sort", "asc");
                    default:
                        return table.setSort("room.sort", "asc");
                }
            });

            __settingSaveChangeContainer(__el.table);
        });
    </script>
</div>

<!-- Modal deposit temp -->
<div class="modal fade" data-bs-backdrop="static"  id="additionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                    <i data-feather="gift"> </i>
                </div>
                <h5 class="modal-title">Cộng thêm / giả trừ hóa đơn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="addition-form" novalidate>
                    <div class="row mt-2 change-addition">
                        <div class="col-6">
                            <div class="item">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="input_addition_add" checked
                                           name="addition" value="1">
                                    <label class="form-check-label" for="input_addition_add">
                                        <b>Cộng thêm</b>
                                        <p>Cộng thêm vào cho hóa đơn</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="item">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="input_addition_sub" name="addition"
                                           value="-1">
                                    <label class="form-check-label" for="input_addition_sub">
                                        <b>Giảm trừ</b>
                                        <p>Giảm trừ cho hóa đơn</p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mt-2">
                        <div class="form-floating">
                            <input data-format="numeric" type="text" class="form-control" name="addition_value"
                                   id="input_addition_value" placeholder="Số tiền cộng thêm / giảm trừ (đ)" required>
                            <label for="input_addition_value">Số tiền cộng thêm / giảm trừ (đ)</label>
                        </div>
                    </div>
                    <div class="col-12 mt-2">
                        <div class="form-floating">
                                <textarea type="text" rows="10" style="min-height: 100px" class="form-control"
                                          name="addition_reason"
                                          id="input_addition_reason" placeholder="Nhập lý do" required></textarea>
                            <label for="input_addition_reason">Lý do cộng hoặc giảm trừ</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="submit-addition-form" class="btn btn-primary">
                    Công thêm
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $("#additionModal").on('change', 'input[name="addition"]', function (e) {

        if (parseInt($(this).val()) === 1) {
            $("#additionModal").find('.modal-title').text(`Cộng thêm cho hóa đơn`);
            $("#additionModal").find('#submit-addition-form').text('Cộng thêm');
        } else {
            $("#additionModal").find('.modal-title').text(`Giảm trừ cho hóa đơn`);
            $("#additionModal").find('#submit-addition-form').text('Giảm trừ');
        }
    });
</script>
<!-- Modal deposit temp -->
<div class="modal fade" data-bs-backdrop="static"  id="depositModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                <i data-feather="gift"> </i>
                </div>
                <h5 class="modal-title">Thu/Hoàn tiền cọc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="deposit-form" novalidate>
                    <div class="row mt-2 change-deposit">
                        <div class="col-6" style="display: none">
                            <div class="item">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="input_deposit_add" checked
                                           name="deposit" value="1">
                                    <label class="form-check-label" for="input_deposit_add">
                                        <b>Thu tiền cọc</b>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-6" style="display: none">
                            <div class="item">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="input_deposit_return" name="deposit"
                                           value="-1">
                                    <label class="form-check-label" for="input_deposit_return">
                                        <b>Trả tiền cọc</b>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mt-2">
                        <div class="form-floating">
                            <input data-format="numeric" type="text" class="form-control" name="deposit_contract_amount"
                                   id="input_deposit_value" placeholder="Số tiền cọc (đ)" required>
                            <label for="input_deposit_value">Số tiền cọc (đ)</label>
                        </div>
                    </div>
                    <div class="col-12 mt-2">
                        <p>
                            - Số tiền cọc đã thu của phòng này: <b class="deposit-contact-paid">0đ</b><br>
                            *Lưu ý: số tiền cọc hoàn trả không thể lớn hơn số tiền cọc đã thu
                        </p>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="submit-deposit-form" class="btn btn-primary">
                    Thêm
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $("#depositModal").on('change', 'input[name="deposit"]', function (e) {
        if (parseInt($(this).val()) === 1) {
            $("#depositModal").find('.modal-title').text(`Thu tiền cọc`);
            $("#depositModal").find('#submit-deposit-form').text('Thu thêm');
        } else {
            $("#depositModal").find('.modal-title').text(`Hoàn tiền cọc`);
            $("#depositModal").find('#submit-deposit-form').text('Hoàn trả');
        }
    });
</script>
<style type="text/css">
    .show-total-remain {
        color: #3c9e47;
    }

    .show-total-remain.warning {
        color: #ee3a4e;
    }
</style>
<!-- Modal deposit temp -->
<div class="modal fade" data-bs-backdrop="static"  id="billPay" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                <i data-feather="dollar-sign"> </i>
                </div>
                <h5 class="modal-title">Thu tiền <span class="room-name">P.012</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="bill-pay-form" novalidate>
                    <div class="col-12 mt-2">
                        <div class="form-floating">
                            <input type="hidden"class="form-control" name="type" value="bill_collect" required/>
                            <input data-format="numeric" type="text" style="font-weight: bold;font-size: 18px;color: #3c9e46;" class="form-control" name="paid_amount"
                                   id="input_paid_amount" placeholder="Nhập số tiền khách thanh toán (đ)" required>
                            <label for="input_paid_amount">Nhập số tiền khách thanh toán (đ)</label>
                        </div>
                    </div>

                    <div class="col-12 mt-2">
                        <div class="form-floating">
                            <select id="input_payment_method" name="payment_method"
                                    class="form-select form-control">
                                <option value="cash">Trả tiền mặt</option>
                                <option value="transfer_by_bank">Chuyển khoản</option>
                            </select>
                            <label for="input_payment_method">Phương thức thanh toán</label>
                        </div>
                    </div>

                    <div class="col-12 mt-2">
                        <div class="form-floating">
                                <textarea type="text" rows="10" style="min-height: 70px" class="form-control"
                                          name="note"
                                          id="pay_bill_note" placeholder="Nhập lý do"></textarea>
                            <label for="pay_bill_note">Ghi chú</label>
                        </div>
                    </div>

                    <div class="col-12 mt-2">
                        <div class="input-group">
                            <div class="form-floating">
                                <input type="text" class="form-control date-flat-picker" name="date_receipt_expense"
                                       id="date_receipt_expense" data-format="date"
                                       placeholder="Ngày ghi nhận thu chi" pattern="\d{1,2}\/\d{1,2}\/\d{4}">
                                <label for="date_receipt_expense">Ngày ghi nhận thu chi</label>
                            </div>
                            <label class="input-group-text" for="date_receipt_expense"><i data-feather="calendar"> </i></label>
                        </div>
                        <div class="invalid-feedback">
                            Vui lòng nhập ngày ghi nhận thu chi và phải đúng định dạng
                        </div>
                        <div class="loz-alert warning mt-2 mb-2">
                            <div class="icon flex-0">
                                <i data-feather="info" size="20"> </i>
                            </div>
                            <div class="des flex-1">
                                <b>Chú thích:</b> <b>"Ngày ghi nhận thu chi"</b> giúp chuyển thời gian phiếu thu tới ngày bạn mong muốn.
                            </div>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                                <div class="row g-0" style="width: 100%">
                    <div class="col-6 container-total-remain">
                        <div><span class="title-total-remain">Số tiền khách còn nợ</span></div>
                        <b class="show-total-remain">2.400.000 đ</b>
                    </div>
                    <div class="col-6 text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" id="submit-bill-pay-form" class="btn btn-primary">
                            Thu tiền
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        let __el = {
            form: $('#bill-pay-form'),
            modal: $("#billPay"),
            submit: $('#submit-bill-pay-form')
        };

        let billData = null;

        const reRenderPayBill = function () {
            let data = __el.form.getObjectOfForm();
            let paidAmount = data?.paid_amount ?? 0;

            let newRemainAmount = (billData?.remain_total ?? 0) - paidAmount;

            if (newRemainAmount >= 0) {
                __el.modal.find('.title-total-remain').text("Số tiền khách còn nợ");
                __el.modal.find('.show-total-remain').removeClass('warning').text(__format.currency(newRemainAmount));
                __el.modal.find('.container-total-remain #container_is_refund_amount')?.remove();
            } else {
                __el.modal.find('.title-total-remain').text("Số tiền nợ lại khách");
                __el.modal.find('.show-total-remain').addClass('warning').text(__format.currency(newRemainAmount));
                __el.modal.find('.container-total-remain #container_is_refund_amount')?.remove();
                __el.modal.find('.container-total-remain').append(`
                    <div id="container_is_refund_amount" class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" value="1" id="is_refund_amount" name="is_refund_amount"
                               checked>
                            <label class="form-check-label" for="is_refund_amount">
                                Đã trả lại tiền thừa cho khách thuê
                            </label>
                    </div>
                `);
            }

        };

        __el.form.find('input[name="paid_amount"]').keyup((e) => {
            reRenderPayBill();
        });

        new __modalForm(
            __el.modal.get(0),
            __el.form.get(0),
            __el.submit.get(0)
        ).start(null, {
            __openModalForm: function ({relatedTarget}) {
                cell = relatedTarget?.cell ?? null;
                billData = relatedTarget?.cell?.getData() ?? null;
                
                __el.form.find('input[name="paid_amount"]').val(__format.currencyInput(billData.remain_total));
                __el.modal.find(".room-name").text(`"${billData?.room?.name ?? ''}"`);
                
                flatpickr(__el.form.find('input[name="date_receipt_expense"]'), {
                    defaultDate: new Date(billData?.date ?? null).toLocaleDateString('vi', {
                        year: "numeric",
                        month: "2-digit",
                        day: "numeric"
                    }),
                    allowInput: true,
                    enableTime: false,
                    dateFormat: "d/m/Y",
                    locale: 'vn'
                });
                
                reRenderPayBill();
            },
            __submitModalForm: function (e) {
                let data = __el.form.getObjectOfForm();
                if (!__el.form.get(0).checkValidity()) {
                    __el.form.get(0).classList.add('was-validated');
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Vui lòng nhập đầy đủ thông tin trước khi thực hiện",
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                if(__el.modal.find('#send_to_zalo').is(":checked")) {
                    var value = __el.modal.find('#send_to_zalo').val()
                    data.send_to_zalo = parseInt(value)
                } 

                $.transferData({
                    method:'POST',
                    url: __helper.url.urlPattern(__routeApi.billPay.store,{
                    bill_id:  billData.id
                    }),
                    data: data,
                    textLoading:'Đang thu tiền...',
                    success: function (res) {
                        Swal.fire({
                            title: 'Thành công!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đóng'
                        }).then((result)=>{
                            bootstrap.Modal.getInstance(__el.modal.get(0)).hide();
                            res?.data && cell &&
                            cell.getRow().update(res.data);
                        });
                    },
                    fail: (res)=>{
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            }
        });
    });
</script>
<!-- Modal add block -->
<style type="text/css">
    .nav-tabs.progressbar{
        border-bottom: 0;
        margin-top: 10px;
        margin-bottom: 10px;
        background-color: #fff;
        width: 50%;
    }

    .progressbar {
        counter-reset: step;
        width: 100%
    }
    .progressbar li{
        width: 50%;
    }
    .progressbar li a{
        list-style: none;
        display: inline-block;
        width: 100%;
        position: relative;
        text-align: center;
        cursor: pointer;
    }
    .progressbar li a::before {
        content: counter(step);
        counter-increment: step;
        width: 30px;
        height: 30px;
        line-height : 30px;
        border: 1px solid #ddd;
        border-radius: 100%;
        display: block;
        text-align: center;
        margin: 0 auto 10px auto;
        background-color: #fff;
        position: relative;
        z-index : 2;
    }

    .progressbar a:after{
        content: "";
        position: absolute;
        width: 100%;
        height: 2px;
        background-color: #ddd;
        top: 15px;
        left: -50%;
        z-index: 1;
    }
    .progressbar li:first-child a::after {
        content: none;
    }
    .progressbar li a.active {
        color: green;
        font-weight: 700
    }
    .progressbar li a.active:before {
        border-color: green;
        border-color: green;
        border-width: 2px;
        width: 32px;
        height: 32px;
    } 
    .progressbar a.active + a:after {
        background-color: green;
    }
    .buttom-list {
        display: flex;
        position: absolute;
        right: 20px;
        top: 35%;
    }
    .room-item .buttom-list .deal-price-item{
        display: block;
    }

    .room-item.is_lock .buttom-list .deal-price-item{
        display: none;
    }

    .room-item .buttom-list .cancel-price-item, .room-item .buttom-list .view-price-item{
        display: none;
    }

    .room-item.is_lock .buttom-list .cancel-price-item, .room-item.is_lock .buttom-list .view-price-item{
        display: block;
    }

    .is-deal {
        position: absolute;
        top: 5px;
        right: 20px;
    }

    .room-list .room-item.is_lock .room-item-inner {
        border: 1px solid #7dc242;
    }

    .room-list .room-item.is_lock .icon-room {
        background-color: #7dc242;
    }

    .room-item.col-12 {
        border: 1px solid #eee;
        background-color: #eee;
        border-radius: 10px;
    }
    .price-items-checkout-layout .item{
        background-color: #fff;
    }

    .room-list .room-item.active .room-item-inner {
        border: 1px solid #7dc242;
        background-color: #ebffec;
    }
</style>
<div class="modal fade" data-bs-backdrop="static"  id="billSeries" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <form method="POST" class="needs-validation" id="bill-series-form" novalidate>
            <div class="modal-content">
                <div class="modal-header--sticky">
                    <div class="modal-header">
                        <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                        <i data-feather="dollar-sign"> </i>
                        </div>
                        <h5 class="modal-title">
                            Lập hóa đơn nhiều phòng (Lập hóa đơn nhanh) 
                            <p style="font-size: 14px; font-weight: normal; font-style: italic; margin: 0">Chốt dịch vụ & lập hóa đớn cho phòng</b></p>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="tab" id="bill-series-tab" style="display: flex;justify-content: center;">
                        <ul  class="nav nav-tabs progressbar" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link-item active" data-bs-toggle="tab" href="#list-room" id="tab-list-room">
                                    Bước 1: Chốt dịch vụ
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link-item" data-bs-toggle="tab" href="#create-bill" id="tab-create-bill">
                                   Bước 2: Lập hóa đơn
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="tab-content">
                        <div id="list-room" class="tab-pane active">
                            <div class="row g-3">
                                <div class=" col-7">
                                    <div class="room-list row g-2">
                                        <div class="text-center">Không có đơn vị nào để lập hóa đơn</div>
                                    </div>
                                </div>
                                <div class="price-items-layout-container col-5">
                                    <h5 class="text-center room-name-lock-price-item" style="display: none"></h5>
                                    <div class="price-item-content" style="background-color: #ebffec;border: 1px solid #c3f2c5;padding:0 10px;border-radius: 10px;">
                                        <div class="text-center" style="margin: 20px 0">
                                            <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>
                                            <h6>Thực hiện chốt dịch vụ</h6>
                                            Vui lòng chọn một "Chốt dịch vụ" từ danh sách phòng để thực hiện chốt dịch vụ
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="create-bill" class="container tab-pane fade">
                            <div class="row">
                                <div class="col-5 text-center" style="display: flex;justify-content: center;align-items: center;background-color: #f2fffe;border: 1px solid #dff8e0;border-radius: 10px;">
                                    <div>
                                        <div style="color: #4CAF50;">
                                            <svg viewBox="0 0 24 24" width="32" height="32" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                        </div>
                                        <div style="color: #4CAF50;font-weight: 700;font-size: 18px;">Đã chốt <span class="count-deal-price-item">0</span> phòng</div>
                                        <div>Nhập các thông tin bên phải để thực hiện tạo hóa đơn!</div>
                                    </div>
                                </div>
                                <div class="col-7">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="input-group">
                                                <div class="form-floating">
                                                    <input type="text" class="form-control month-flat-picker" name="month"
                                                        id="month-series"
                                                        placeholder="Nhập tháng" pattern="\d{1,2}\/\d{4}" required>
                                                    <label for="month-series">Tháng lập phiếu</label>
                                                </div>
                                                <label class="input-group-text" for="month"><i
                                                        data-feather="calendar"> </i></label>
                                            </div>
                                        </div> 
                                        <div class="col-6">   
                                            <div class="form-floating">
                                                <select id="reason_id" name="reason_id" class="form-select form-control" data-format="numeric" readonly required>
                                                                                                                                                                        <option
                                                                value="1">Thu tiền hàng tháng
                                                            </option>
                                                                                                                                                                </select>
                                                <label for="reason_id">Lý do thu tiền</label>
                                            </div>
                                        </div>
                                    </div>
    
                                    <div class="row g-2 mt-2">
                                        <div class="col-6">
                                            <div class="input-group">
                                                <div class="form-floating">
                                                    <input type="text" class="form-control date-flat-picker" name="date"
                                                            data-format="date"
                                                            id="date-add-bill"
                                                            placeholder="Ngày lập hóa đơn" pattern="\d{1,2}\/\d{1,2}\/\d{4}"
                                                            required>
                                                    <label for="date-add-bill">Ngày lập hóa đơn</label>
                                                </div>
                                                <label class="input-group-text" for="date-add-bill">
                                                    <i data-feather="calendar"> </i>
                                                </label>
                                            </div>
                                            <div class="invalid-feedback">
                                                Vui lòng nhập Ngày lập hóa đơn
                                            </div>
                                        </div>
    
                                        <div class="col-6">
                                            <div class="input-group">
                                                <div class="form-floating">
                                                    <input type="text" class="form-control date-flat-picker"
                                                            name="deadline_bill_date"
                                                            id="deadline_bill_date"
                                                            data-format="date"
                                                            placeholder="Nhập hạn đóng tiền cho hóa đơn"
                                                            pattern="\d{1,2}\/\d{1,2}\/\d{4}" readonly required>
                                                    <label for="deadline_bill_date">Hạn đóng tiền</label>
                                                </div>
                                                <label class="input-group-text" for="deadline_bill_date">
                                                    <i data-feather="calendar"> </i>
                                                </label>
                                            </div>
                                            <div class="invalid-feedback">
                                                Vui lòng nhập hạn đóng tiền hóa đơn
                                            </div>
                                        </div>
                                    </div>
    
                                    <div class="col-12 calculate-spent-time-layout">
                                        <div class="col-12 mb-2">
                                            <div class="title-item-small">
                                                <b>Thông tin ngày ở</b>
                                                <i class="des">Nhập thông tin từ ngày đến ngày</i>
                                            </div>
                                        </div>   
            
                                        <!-- Số tháng, ngày  layout -->
                                        <div class="row g-2 month-amount-layout" style="margin-top: 5px; display:none">
                                            <div class="col-6 mt-2">
                                                <div class="form-floating">
                                                    <input data-format="numeric" type="text" min="0" class="form-control" value="1" name="month_amount" id="month_amount"
                                                        placeholder="Nhập số tháng" readonly required>
                                                    <label for="month_amount">Số tháng</label>
                                                    <div class="invalid-feedback">
                                                        Vui lòng nhập số tháng tính tiền
                                                    </div>
                                                </div>
                                            </div>
                    
                                            <div class="col-6 mt-2">
                                                <div class="form-floating">
                                                    <input data-format="numeric" type="text" min="0" class="form-control" value="0" name="day_amount" id="day_amount"
                                                        placeholder="Nhập số tháng" readonly required>
                                                    <label for="day_amount">Số ngày lẻ</label>
                                                    <div class="invalid-feedback">
                                                        Vui lòng nhập số ngày lẻ
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
            
                                        <!-- Từ ngày, đến ngày  layout -->
                                        <div class="row g-2 circle-month-layout" style="margin-top: 5px">
                                            <div class="col-6 mt-2">
                                                <div class="form-floating">
                                                    <input type="text" class="form-control date-flat-picker" name="date_from"
                                                        id="date_from"
                                                        data-format="date"
                                                        placeholder="Từ ngày" pattern="\d{1,2}\/\d{1,2}\/\d{4}" required>
                                                    <label for="date_from">Từ ngày</label>
                                                </div>
                                            </div>
                    
                                            <div class="col-6 mt-2">
                                                <div class="form-floating">
                                                    <input type="text" class="form-control date-flat-picker" name="date_to"
                                                        id="date_to"
                                                        data-format="date"
                                                        placeholder="Đến ngày" pattern="\d{1,2}\/\d{1,2}\/\d{4}" required>
                                                    <label for="date_to">Đến ngày</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
    
                                    <div class="loz-alert info mt-2 mb-2">
                                        <div class="icon flex-0">
                                            <i data-feather="info" size="20"> </i>
                                        </div>
                                        <div class="des flex-1">
                                            <b>Thông tin:</b> Các phòng/giường lập hóa đơn mặc định tính <strong>tròn 1 tháng</strong>
                                        </div>
                                    </div>
    
                                    <div class="addition-layount">
                                        <div class="col-12 mt-2 mb-2">
                                            <div class="title-item-small">
                                                <b>Cộng thêm / Giảm trừ:</b>
                                                <i class="des">Ví dụ cộng thêm ngày tết, giảm trừ covid...</i>
                                            </div>
                                        </div>
    
                                        <style type="text/css">
                                            #addition-item .item{
                                                border-radius: 5px;
                                                border: 1px solid #ced4da;
                                            }
                                            #addition-item .form-control{
                                                border:0px;
                                                border-radius: 0;
                                            }
                                            #addition-item .middle-item, .addition-suggestion-layout .middle-item{
                                                display: flex;
                                                flex-direction: column;
                                                justify-content: center;
                                                align-items: center;
                                            }
                                            #addition-item .center-item{
                                                display: flex;
                                                flex-direction: column; 
                                                justify-content: center;
                                            }
                                            #addition-item .border-top{
                                                border-top: 1px solid #ced4da;
                                            }
                                            #addition-item .border-bottom{
                                                border-bottom: 1px solid #ced4da;
                                            }
                                            #addition-item .border-left{
                                                border-left: 1px solid #ced4da;
                                            }
                                            #addition-item .border-right{
                                                border-right: 1px solid #ced4da;
                                            }
                                            #addition-item .full{
                                                height: 100%;width: 100%;
                                            }
                                        </style>
    
                                        <div class="addition-item" id="addition-item">
                                            <div class="loz-alert warning" style="margin-bottom: 10px; margin-top: 10px;">
                                                <div class="icon flex-0">
                                                    <i data-feather="info"> </i>
                                                </div>
                                                <div class="des flex-1">
                                                    Chú ý: Cộng thêm / giảm trừ không nên là tiền cọc. Hãy chọn lý do có tiền cọc để nếu cần
                                                </div>
                                            </div>
                                        </div> 
    
                                        <div class="col-12">
                                            <div style="border-top: 1px solid #eee; padding-top: 10px; text-align: end;">
                                                <button type="button" id="addition-add" class="btn btn-secondary" style="width: 100%;">
                                                    <i data-feather="plus"> </i>
                                                    Thêm mục cộng thêm / giảm trừ
                                                </button>
                                            </div>
                                        </div>
                                    </div>
    
                                    <div style="display: none">
                                        <div class="col-12">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="addition" id="addition_a_bill" checked value="1" data-format="numeric">
                                                <label class="form-check-label" for="addition_a_bill">Cộng thêm</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="addition" id="addition_b_bill" value="-1" data-format="numeric">
                                                <label class="form-check-label" for="addition_b_bill">Giảm trừ</label>
                                            </div>
                                        </div>
    
                                        <div class="col-12 mt-2">
                                            <div class="form-floating">
                                                <input data-format="numeric" type="text" min="0" class="form-control" name="addition_value" id="addition_value"
                                                    placeholder="Số tiền cộng thêm hoặc giảm trừ">
                                                <label for="addition_value">Số tiền (đ)</label>
                                            </div>
                                        </div>
    
                                        <div class="col-12 mt-2">
                                            <div class="form-floating">
                                        <textarea type="text" rows="10" style="min-height: 70px" class="form-control" name="addition_reason"
                                                id="addition_reason" placeholder="Nhập lý do"></textarea>
                                                <label for="addition_reason">Lý do</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer--sticky mt-3">
                    <div class="modal-footer">
                        <div class="row g-0" style="width: 100%">
                            <div class="col-12">
                                <div class="loz-alert warning" style="margin-bottom: 10px; margin-top: 0px;">
                                    <div class="icon flex-0">
                                        <i data-feather="info"> </i>
                                    </div>
                                    <div class="des flex-1">
                                        Để gửi hóa đơn tự đơn qua Zalo cho khách bạn phải tạo từng hóa đơn một. Việc gửi tự động cho khách khi lập hóa đơn nhanh chỉ áp dụng khi khách thuê đang dùng app LOZIDO
                                    </div>
                                </div>
                            </div> 
                            <div class="col-6">
                                <div>
                                    <span style="font-size: 16px;color: #1a8754;"><b class="count-deal-price-item badge bg-success">0</b> phòng đã được chốt dịch vụ và sẵn sàng lập hóa đơn</span>
                                </div>
                            </div>
                            <div class="col-6 text-end">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i data-feather="x"> </i>
                                    Đóng
                                </button>
                                <button type="button" id="pre-step-1" class="btn btn-primary">
                                    <i data-feather="chevrons-left"> </i>
                                    Bước 1: Chốt dịch vụ
                                </button>
                                <button type="button" id="next-step-2" class="btn btn-primary">
                                    Bước 2: Lập hóa đơn
                                    <i data-feather="chevrons-right"> </i>
                                </button>
                                <button type="button" id="submit-bill-series" class="btn btn-primary">
                                    <i data-feather="plus"> </i>
                                    Lập hóa đơn
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        var __el = {
            form: $('#bill-series-form'),
            modal: $("#billSeries"),
            submit: $('#submit-bill-series'),
        };

        let filters = {
            status: [],
            month: parseInt(`10`),
            year: parseInt(`2024`)
        };
        let room_price_item_save = null;

        let roomSend = {};
        let roomList = [];
        let sugget_addition_items = [];

        let block_price_item = JSON.parse(JSON.stringify([{"id":23351,"name":"Ti\u1ec1n \u0111i\u1ec7n","type":"constant","unit":"kwh","price":1700,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"ele","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"KWh","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1},{"id":23352,"name":"Ti\u1ec1n n\u01b0\u1edbc","type":"constant","unit":"khoi","price":18000,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"water","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"Kh\u1ed1i","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1}]));

        flatpickr(__el.form.find('input[name="month"]'), {
            allowInput: true,
            enableTime: false,
            dateFormat: "m/Y",
            locale: 'vn',
            defaultDate: 'today',
            plugins: [
                new monthSelectPlugin({
                    shorthand: true, //defaults to false
                    dateFormat: "m/Y", //defaults to "F Y"
                    altFormat: "F Y", //defaults to "F Y"
                    theme: "light" // defaults to "light"
                })
            ]
        });

        flatpickr(__el.form.find('input[name="date"]'), {
            defaultDate: 'today',
            allowInput: true,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn'
        });

        flatpickr(__el.form.find('input[name="deadline_bill_date"]'), {
            defaultDate: new Date().fp_incr(__current_block?.deadline_bill ?? 0).toLocaleDateString('vi', {
                year: "numeric",
                month: "2-digit",
                day: "numeric"
            }),
            allowInput: true,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn'
        });

        flatpickr(__el.form.find('input[name="date_from"]'), {
            defaultDate: 'today',
            allowInput: true,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn',
            onChange: function(selectedDates, dateStr, instance) {
                // Khi 'date_from' thay đổi, cập nhật 'date_to'
                if (selectedDates.length > 0) {
                    var newDate = new Date(selectedDates[0]);
                    newDate.setMonth(newDate.getMonth() + 1);
                    __el.form.find('input[name="date_to"]').get(0)._flatpickr.setDate(newDate);
                }
            }
        });

        flatpickr(__el.form.find('input[name="date_to"]'), {
            defaultDate: new Date((new Date()).setMonth((new Date()).getMonth() + 1)),
            allowInput: false,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn',
            clickOpens:false
        });

        const getAdditionFromItem = () =>{
            let data = __el.form.getObjectOfForm();

            let addition_amount = 0;
            let addition_reason = [];
            
            if(Object.keys(data?.addition_items ?? {}).length !== 0){
                Object.keys(data.addition_items).map((index)=>{
                    let item = data.addition_items[index];
                    addition_amount += item.addition * item.addition_value;

                    if(item.addition_reason)
                        addition_reason.push(item.addition_reason);
                });
                if(addition_amount > 0)
                    __el.form.find('input[name="addition"][value="1"]').prop("checked", true);

                if(addition_amount < 0)
                    __el.form.find('input[name="addition"][value="-1"]').prop("checked", true);

                __el.form.find('input[name="addition_value"]').val(Math.abs(addition_amount));
                __el.form.find('textarea[name="addition_reason"]').val(addition_reason.join(', '));
            }else{
                __el.form.find('input[name="addition"][value="1"]').prop("checked", true);
                __el.form.find('input[name="addition_value"]').val('');
                __el.form.find('textarea[name="addition_reason"]').val('');
            }
        }

        const additionAdd = (index=null, dataDefault=null) => {
            if(!index){
                index = __el.form.find('#addition-item .item').length;
            }

            // Tạo phần tử mới
            const newItem = `
                <div class="row g-0 item mt-1 mb-1">
                    <div class="col-3">
                        <div class="middle-item border-right full">
                            <div class="border-bottom center-item full p-2">
                                <div class="form-check">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="addition_items[${index}]['addition']" id="addition_a_bill_${index}" checked="${dataDefault?.addition && dataDefault?.addition===1}" value="1">
                                    <label class="form-check-label" for="addition_a_bill_${index}">Cộng [+]</label>
                                </div>
                            </div>
                            <div class="center-item full p-2">
                                <div class="form-check">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="addition_items[${index}]['addition']" id="addition_b_bill_${index}" checked="${dataDefault?.addition && dataDefault?.addition===-1}" value="-1">
                                    <label class="form-check-label" for="addition_b_bill_${index}">Giảm [-]</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-8 border-right">
                        <div class="row">
                            <div class="col-12">
                                <div class="form-floating">
                                    <input data-format="numeric" type="text" min="0" class="border-bottom form-control" name="addition_items[${index}]['addition_value']" placeholder="Số tiền cộng thêm hoặc giảm trừ" value="${dataDefault?.addition_value ? __format.currencyInput(dataDefault?.addition_value): ''}" required>
                                    <label for="addition_value_${index}">Số tiền (đ)</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea type="text" rows="10" style="min-height: 60px" class="form-control" name="addition_items[${index}]['addition_reason']" placeholder="Nhập lý do" value="${dataDefault?.addition_reason ? dataDefault?.addition_reason: ''}" required>${dataDefault?.addition_reason ? dataDefault?.addition_reason: ''}</textarea>
                                    <label for="addition_reason_${index}">Lý do</label>
                                </div>
                            </div>
                        </div>    
                    </div>  
                    <div class="col-1" style="border-radius: 0 5px 5px 0;display: flex;flex-direction: column;justify-content: center;align-items: center;background-color: #ffeee9;">
                        <button class="btn delete" type="button" style="color:red; height: 100%;">Xóa</button>
                    </div>  
                </div>`;
            
            // Thêm phần tử mới vào addition-item
            __el.form.find('#addition-item').append(newItem);

            __el.form.find('input[data-format="numeric"][type="text"]').on('input', function() {
                let value = $(this).val();
                
                let number = __helper.convertStringToNumber(value);
                let newVal = __format.currencyInput(number);

                $(this).val(value ==='' ? '': isNaN(number) ? '': newVal);
            });

            getAdditionFromItem();

            // Cật nhật là thuộc tính sử dụng của đề nghị;
            if(dataDefault && dataDefault.length !== 0){
                sugget_addition_items = sugget_addition_items.map((item)=>{
                    if(item.id === dataDefault.id){
                        item.has_use = 1;
                    }
                    return item;
                });
                renderAdditionSuggestion(sugget_addition_items);
            }
        };

        // Renter các price item
        const renderRoomPriceItems = (room) =>{
            console.log(room);
            
            if(room.price_items){
                
                room_price_item_save = JSON.parse(JSON.stringify(room.price_items)) ?? [];
                if(!Array.isArray(room_price_item_save) || !room_price_item_save.length > 0){
                    alert("Không có dịch vụ để chốt");
                    return;
                }
                
                let priceItemElementEdit = $('<div class="price-items-checkout-layout">');
                    priceItemElementEdit.append(`
                        <div style="text-align: center;position: sticky;top: 167px;z-index: 10;padding: 10px;border-bottom:1px solid #c2f2c5;background-color: #ebffec;">
                            <button type="button" data-id="${room.id}" class="btn btn-secondary close-price-item">
                                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                Đóng chốt
                            </button>
                            <button type="button" data-id="${room.id}" class="btn btn-primary submit-price-item" style="margin-left: 5px;">
                                <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                Áp dụng dịch vụ
                            </button>
                        </div>
                    `);
                    $(".room-name-lock-price-item").text("Chốt dịch vụ "+ room.name).show();

                room_price_item_save.sort((itemA, itemB) => { 
                    if (itemA.subtraction && !itemB.subtraction) {
                        return -1;
                    } else if (!itemA.subtraction && itemB.subtraction) {
                        return 1;
                    } else {
                        return 0;
                    }
                }).map((item, key)=> {                    
                    let container = $(`<div class="item">`);
                    let checkNameContainer = $(`<div class="item-check-name">`);

                    checkNameContainer.append(`<input class="form-check-input" type="hidden" value="${item.id}" name="price_items[${item.id}][id]">`);
                    checkNameContainer.append(`<input class="form-check-input" data-price-item-unit="${item.unit}" type="checkbox" id="bill_check_price_item_${item.id}" value="1" checked name="price_items[${item.id}][is_selected]">`);

                    if(item.type === 'frame' && !__helper.checkType.isEmpty(item.frames)){
                        checkNameContainer.append(`<label for="bill_check_price_item_${item.id}"><b>${item.name}</b>`+
                            $.map(item.frames, function(frame, key) {
                                return `<div> ${ parseInt(key) !== 0 ? item.frames[parseInt(key)-1]['volume'] : 0 } - ${frame.volume}, Giá: <b>${__format.currency(frame.price)}/${item.unit_text}</b></div>`
                            }).join('')
                        + "</label>")
                    }else{
                        checkNameContainer.append(`<label for="bill_check_price_item_${item.id}"><b>${item.name}</b> <div>Giá: <b>${__format.currency(item.price)}</b> / ${item.unit_text}</div> </label>`);
                    }

                    let valueContainer = $('<div class="item-value">');
                    if(item.subtraction){
                        valueContainer.append(`<div class="input-group mb-2"><input class="form-control" min="0" id="bill_price_item_${item.id}_0" type="number" placeholder="Nhập số cũ" value="${item?.value ? item?.value[0] : 0}" name="price_items[${item.id}][value][0]"><label class="input-group-text" for="bill_price_item_${item.id}_0">Số cũ</label></div>`);
                        valueContainer.append(`<div class="input-group"><input class="form-control" min="0" id="bill_price_item_${item.id}_1" type="number" placeholder="Nhập số mới" value="${item?.value ? item?.value[1] : 0}" name="price_items[${item.id}][value][1]"> <label class="input-group-text" for="bill_price_item_${item.id}_1">Số mới</label></div>`);
                    }else{
                        valueContainer.append(`<div class="input-group"><input data-price-item-unit="${item.unit}" class="form-control" min="1" type="number" id="bill_price_item_${item.id}" placeholder="Nhập giá trị" value="${item?.value ? item.value[0] : 1}" name="price_items[${item.id}][value][0]"> <label class="input-group-text" for="bill_price_item_${item.id}">${item.unit_text}</label></div>`);
                    }
                    priceItemElementEdit.append(container.append(checkNameContainer).append(valueContainer)).slideDown('1000');
                    
                });

                $(".price-items-layout-container").find('.price-item-content').html("");
                $(".price-items-layout-container").find('.price-item-content').append(priceItemElementEdit)
            }else{
                alert("Phòng chưa có dịch vụ nào để chốt!");
                $(".room-name-lock-price-item").text("").hide();
            }
        };


        const renderRooms = () => {
            __el.modal.find('.room-list').html('');

            if (!roomList || roomList?.length === 0) {
                roomList = [];
                __el.modal.find('.room-list').html('Không có phòng nào để lập hóa đơn');
                return false;
            }

            roomList.map((room) => {
                let isActive = !(typeof roomSend[room.id] === "undefined");

                let hasBill = (room.contract_id && room?.bills?.length > 0) ?
                    !!__helper.array.findObjectInArray(room.contract_id, 'contract_id', room.bills) :
                    false;

                let buttomLock = $(`
                    <button type="button" data-id="${room.id}" class="btn btn-primary deal-price-item">
                        Chốt
                    </button>
                `).click((e)=>{
                    $(".room-item").removeClass("active");
                    let itemRoom = $(e.target).closest('.room-item');
                    itemRoom.addClass("active");

                    // Render price item and show;
                    renderRoomPriceItems(room);
                }); 

                let buttomView = $(`
                    <button type="button" data-id="${room.id}" class="btn btn-primary view-price-item" style="margin-left: 5px;">Xem</button>
                `).click((e)=>{
                    $(".room-item").removeClass("active");
                    let itemRoom = $(e.target).closest('.room-item');
                    itemRoom.addClass("active");

                    // Render price item and show;
                    renderRoomPriceItems(roomSend[room.id]);
                }); 
                
                let buttomCancel = $(`
                    <button type="button" data-id="${room.id}" class="btn btn-secondary cancel-price-item">Hủy</button>
                `).click((e)=>{
                    $(".room-item").removeClass("active");
                    const roomId = parseInt($(e.target).data('id'));
                    let itemRoom = $(e.target).closest('.room-item');
                    if(roomId){
                        Swal.fire({
                            title: 'Thông báo!',
                            text: "Bạn chắc chắn muốn xóa chốt dịch vụ?",
                            icon: 'info',
                            showCancelButton:true,
                            cancelButtonText: 'Vẫn áp dụng',
                            confirmButtonText: 'Vâng! hủy chốt',
                            confirmButtonColor: 'red',
                            cancelButtonColor: '#3c9e47',
                        }).then((result)=>{
                            if(result.isConfirmed){
                                delete roomSend[roomId];
                                itemRoom.removeClass('col-12 is_lock').addClass('col-6');
                                $(`.is-deal-${roomId}`).addClass('d-none');
                                $('.count-deal-price-item').text(Object.values(roomSend)?.length ?? 0);
                            }else{
                                console.log("Vẫn giữ chốt");
                            }
                        });
                    }else{
                        alert("Đã có lỗi xảy ra! Không tìm thấy dịch vụ muốn hủy");
                    }
                }); 

                let item = $(`
                    <div class="col-6 room-item ${isActive ? ' active' : ''}" data-room-id="${room.id}"> 
                        <div class="row">
                            <div class="col-12" style="position:relative" id="room-item-${room.id}" data-room-id="${room.id}">
                                <div class="d-flex room-item-inner align-items-center">
                                    ${isActive ? `<div class="flex-grow-0 icon-room">${feather.icons['check'].toSvg()}</div>` : `<div class="flex-grow-0 icon-room"><img width="20px" src="/images/icons/room.png" alt=""/></div>`}
                                    <div class="flex-grow-1">
                                        <div class="flex-grow-1">
                                            <div>
                                                <b>${room.name}</b>
                                                <span style="background-color: ${room.status_color}; display: table; font-size: 12px; border-radius: 5px; padding:0 7px; color: #fff">${room.status_text}</span>
                                                ${hasBill ? `<div style="font-size: 12px; color: #f44336"><i>Đã có (<b>${room?.bills?.length ?? 0}</b>) trong <b>tháng ${filters.month}</b></i></div>` : ''}
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mt-1">
                                                <div>${feather.icons['dollar-sign'].toSvg({width: 18, height: 18})} ${__format.currency(room.room_amount)}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="is-deal is-deal-${room.id} d-none" style="font-size: 12px; color: #3c9e47;font-weight: bold;">
                                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    <i>Đã chốt dịch vụ</i>
                                </div>
                                <div class="buttom-list"></div>
                            </div>
                        </div>
                `);

                item.find('.buttom-list').append(buttomLock).append(buttomCancel).append(buttomView);

                const roomId = parseInt($(this).data('room-id'))
                
                __el.modal.find('.room-list').append(item);

                __el.modal.find('.count-room-send').text(Object.keys(roomSend)?.length ?? 0);
            });

        };

        const setDataRoomPriceItems = (roomData) =>{
            let priceItems = {
                currentPriceItem: [],
            };
            
            let current_price_item = roomData?.price_items;
            
            if(block_price_item && current_price_item){
                Object.keys(current_price_item).forEach((price_item_id)=>{
                    let searchItem = {...__helper.array.findObjectInArray(price_item_id, 'id', block_price_item)};
                    if(searchItem && parseInt(current_price_item[searchItem.id]?.is_selected)){
                        searchItem.value = [0,0]
                        
                        if(searchItem.subtraction){
                            searchItem.value[1] = parseInt(__helper.convertStringToNumber(current_price_item[searchItem.id]['value'][1] ?? '0'));
                            searchItem.value[0] = parseInt(__helper.convertStringToNumber(current_price_item[searchItem.id]['value'][0] ?? '0'));
                        }else{
                            searchItem.value = [parseInt(__helper.convertStringToNumber(current_price_item[searchItem.id]['value'][0] ?? '0'))];
                        }

                        priceItems.currentPriceItem.push(searchItem);
                    }
                });
            }

            roomSend[roomData.id].price_items = priceItems.currentPriceItem;     
        }

        const loadRoom = () => $.transferData({
            method: "POST",
            url: __helper.url.urlPattern(__routeApi.bill.listSeries, {
                block_id: parseInt(7081)
            }),
            data: {
                filters: filters
            },
            textLoading: `Đang tải danh sách ${__current_block?.room_type_name ??''}...`,
            success: (res) => {
                roomList = res?.data?.payload ?? [];
                roomSend = {};
                renderRooms();
            },
            fail: (res) => {
                roomList = [];
                roomSend = {};
                renderRooms();
            }
        });

        var tabCreateBill = new bootstrap.Tab(__el.form.find("#tab-create-bill").get(0));
        var tabRoomList = new bootstrap.Tab(__el.form.find("#tab-list-room").get(0));
        __el.form.find('#next-step-2').click(function (e) {
            tabCreateBill.show();
            
        });

        __el.form.find('#pre-step-1').on('click', (e)=>{
            tabRoomList.show();
        });

        __el.form.on('change', 'input[name="month"]', function (e) {
            let monthYear = $(this).val()?.split('/');
            if (monthYear && monthYear?.length === 2 && (parseInt(monthYear[0]) !== filters.month || parseInt(monthYear[1]) !== filters.year)) {
                filters['month'] = parseInt(monthYear[0]);
                filters['year'] = parseInt(monthYear[1]);
                loadRoom();
            }
        });

        __el.form.find('.addition-layount #addition-add').on('click', (e)=>{
            additionAdd();
        });

        $(document).find('.addition-layount ').on('click', '.delete', function() {
            $(this).closest('.item').remove();
            getAdditionFromItem();
        });

        $(document).find('.addition-layount ').on('click', '.delete', function() {
            $(this).closest('.item').remove();
        });

        __el.form.on('keyup', '#addition-item textarea', function (e) {
            getAdditionFromItem();
        });

        $(document).find('.price-items-layout-container').on('click', '.close-price-item', function() {
            const roomId = $(this).data('id');
            $(".room-item").removeClass("active");
            $(".price-items-layout-container").find('.price-item-content').html(`
                <div class="text-center" style="margin: 20px 0">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>
                    <h6>Thực hiện chốt dịch vụ</h6>
                    Vui lòng chọn một "Chốt dịch vụ" từ danh sách phòng để thực hiện chốt dịch vụ
                </div>
            `);
            $(".room-name-lock-price-item").text("").hide();
        })

        $(document).find('.price-items-layout-container').on('click', '.submit-price-item', function() {
            const roomId = $(this).data('id');
            let roomItem = $('#room-item-'+roomId).closest(".room-item");
            $(".room-item").removeClass("active");

            let room = __helper.array.findObjectInArray(roomId, 'id', roomList);
            if(!room){
                alert("Đã có lỗi xảy ra!");
                return;
            }
            let data = __el.form.getObjectOfForm();

            roomSend[roomId] = {...room};
            roomSend[roomId].price_items = data.price_items;

            setDataRoomPriceItems(roomSend[roomId]);
            
            roomItem.closest(".room-item").find('.is-deal').removeClass('d-none');
            roomItem.closest(".room-item").addClass('is_lock');
            $(".price-items-layout-container").find('.price-item-content').html(`
                <div class="text-center" style="padding: 20px; 0">
                    <div style="color: #4CAF50;">
                        <svg viewBox="0 0 24 24" width="32" height="32" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </div>
                    <h6>Đã chốt xong dịch vụ</h6>
                    <div style="font-size: 16px;font-weight: 700;">${room.name}</div>
                </div>
            `);
            $(".room-name-lock-price-item").text("").hide();
            $('.count-deal-price-item').text(Object.values(roomSend)?.length ?? 0);
        });

        __el.form.on('change', 'input', function (e) {
            if(['radio', 'number', 'text', 'checkbox'].includes($(this).attr('type'))){
                getAdditionFromItem();
            }
        });

        __el.form.on('keyup', 'input', function (e) {
            if(['radio', 'number', 'text', 'checkbox'].includes($(this).attr('type'))){
                getAdditionFromItem();
            }
        });

        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            const activeTab = $(e.target).attr('href'); 
            if(activeTab === "#list-room"){
                __el.form.find('#next-step-2').removeClass('d-none');
                __el.form.find('#pre-step-1').addClass('d-none');
                __el.form.find('#submit-bill-series').addClass('d-none');
            }else{
                __el.form.find('#next-step-2').addClass('d-none');
                __el.form.find('#pre-step-1').removeClass('d-none');
                __el.form.find('#submit-bill-series').removeClass('d-none');
            }
        });


        new __modalForm(
            __el.modal.get(0),
            __el.form.get(0),
            __el.submit.get(0)
        ).start(null, {
            __openModalForm: function () {
                loadRoom();
                tabRoomList.show();
                __el.form.find('input[name="month"]').val(filters.month + '/' + filters.year);
                __el.form.find('input[name="date"]').get(0)._flatpickr.setDate(new Date());
                __el.form.find('input[name="deadline_bill_date"]').get(0)._flatpickr.setDate(new Date().fp_incr(__current_block?.deadline_bill ?? 5));

                __el.form.find('#next-step-2').remove('d-none');
                __el.form.find('#pre-step-1').addClass('d-none');
                __el.form.find('#submit-bill-series').addClass('d-none');

                $(".price-items-layout-container").find('.price-item-content').html(`
                    <div class="text-center" style="margin: 20px 0">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>
                        <h6>Thực hiện chốt dịch vụ</h6>
                        Vui lòng chọn một "Chốt dịch vụ" từ danh sách phòng để thực hiện chốt dịch vụ
                    </div>
                `);
            },
            __submitModalForm: function (e) {
                let data = __el.form.getObjectOfForm();

                if (!__el.form.get(0).checkValidity() || (!roomSend || Object.keys(roomSend).length===0)) {
                    __el.form.get(0).classList.add('was-validated');
                    Swal.fire({
                        title: 'Thông báo!',
                        text: (!roomSend || Object.keys(roomSend).length===0) ? `Vui lòng chọn ${__current_block?.room_type_name?? 'phòng'} cần thu!`:"Vui lòng nhập đầy đủ thông tin trước khi thực hiện",
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                if(data.addition_value && (data.addition_reason==='undefined' || !data?.addition_reason || data?.addition_reason?.length===0)){
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Vui lòng nhập lý do giảm trừ hoặc cộng thêm",
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                data.month = parseInt(__el.form.find('input[name="month"]').val().split("/")[0]);
                data.year = parseInt(__el.form.find('input[name="month"]').val().split("/")[1]);
                data.reason_text = __el.form.find('select[name="reason_id"] option:selected').text();
                data.addition_value = parseInt(data.addition) * data.addition_value;

                let addition_items = Object.values(data?.addition_items ?? {});
                data.addition_items = addition_items.length!==0 ? addition_items : null;
                
                data.rooms = roomSend;
                
                $.transferData({
                    method: "POST",
                    url: __helper.url.urlPattern(__routeApi.bill.billSeriesAdd, {
                        block_id: parseInt(7081)
                    }),
                    data,
                    success: function (res) {
                        Swal.fire({
                            title: 'Thành công!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đóng'
                        }).then((result) => {
                            location.reload();
                        });
                    },
                    fail: (res) => {
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            },
            __closeModalForm: function (e) {
                __el.form.get(0).reset();
            },
        });
    });
</script>
<!-- Modal deposit temp -->
<style type="text/css">
    .total-price{
        font-size: 18px;
    }
</style>
<div class="modal fade" data-bs-backdrop="static" id="editBill" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                <i data-feather="dollar-sign"> </i>
                </div>
                <h5 class="modal-title">Chỉnh sửa hóa đơn cho <span class="room-name">P.012</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
            </div>
            <div class="modal-body">
                <form class="needs-validation" id="edit-bill-form" novalidate>
                    <input type="hidden" name="_token" value="CZqXP04OzKEuLEt01gkxMY2DrN3sCqnCK8eSZ2o4">                    <div class="row g-2">
                        
                        <div class="col-12">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input type="text" class="form-control month-flat-picker" name="month"
                                           id="month"
                                           placeholder="Nhập tháng" pattern="\d{1,2}\/\d{4}" required>
                                    <label for="month">Tháng lập phiếu</label>
                                </div>
                                <label class="input-group-text" for="month"><i
                                        data-feather="calendar"> </i></label>
                            </div>
                            <div class="invalid-feedback">
                                Vui lòng nhập tháng
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input type="text" class="form-control date-flat-picker" name="date"
                                           data-format="date"
                                           id="date-add-bill"
                                           placeholder="Ngày lập hóa đơn" pattern="\d{1,2}\/\d{1,2}\/\d{4}" required>
                                    <label for="date-add-bill">Ngày lập hóa đơn</label>
                                </div>
                                <label class="input-group-text" for="date-add-bill">
                                    <i data-feather="calendar"> </i>
                                </label>
                            </div>
                            <div class="invalid-feedback">
                                Vui lòng nhập Ngày lập hóa đơn
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="input-group">
                                <div class="form-floating">
                                    <input type="text" class="form-control date-flat-picker" name="deadline_bill_date"
                                           id="deadline_bill_date"
                                           data-format="date"
                                           placeholder="Nhập hạn đóng tiền cho phiếu thu(hóa đơn)" pattern="\d{1,2}\/\d{1,2}\/\d{4}" required>
                                    <label for="deadline_bill_date">Hạn đóng tiền</label>
                                </div>
                                <label class="input-group-text" for="deadline_bill_date">
                                    <i data-feather="calendar"> </i>
                                </label>
                            </div>
                            <div class="invalid-feedback">
                                Vui lòng nhập hạn đóng tiền hóa đơn
                            </div>
                        </div>

                        <div class="col-12 calculate-spent-time-layout">
                            <div class="title-has-icon">
                                <div class="icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                </div>
                                <div class="title-item-small">
                                    <b class="reason_text">Tiền thuê</b>
                                    <div class="des">Ngày vào: <strong style="color: #ff5722" class="date-join">01/01/2021</strong>. Chu kỳ thu: <strong style="color: #ff5722" class="circle-month">1</strong> <span style="color: #ff5722">tháng, <span class="circle-day">thu cuối tháng</span></span></div>
                                </div>
                            </div>    

                            <!-- Số tháng, ngày  layout -->
                            <div class="row g-2 month-amount-layout" style="margin-top: 5px; display:none">
                                <div class="col-6 mt-2">
                                    <div class="form-floating">
                                        <input data-format="numeric" type="text" min="0" class="form-control" value="1" name="month_amount" id="month_amount"
                                            placeholder="Nhập số tháng" readonly required>
                                        <label for="month_amount">Số tháng</label>
                                        <div class="invalid-feedback">
                                            Vui lòng nhập số tháng tính tiền
                                        </div>
                                    </div>
                                </div>
        
                                <div class="col-6 mt-2">
                                    <div class="form-floating">
                                        <input data-format="numeric" type="text" min="0" class="form-control" value="0" name="day_amount" id="day_amount"
                                            placeholder="Nhập số tháng" readonly required>
                                        <label for="day_amount">Số ngày lẻ</label>
                                        <div class="invalid-feedback">
                                            Vui lòng nhập số ngày lẻ
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Từ ngày, đến ngày  layout -->
                            <div class="row g-2 circle-month-layout" style="margin-top: 5px">
                                <div class="col-6 mt-2">
                                    <div class="form-floating">
                                        <input type="text" class="form-control date-flat-picker" name="date_from"
                                           id="date_from"
                                           data-format="date"
                                           placeholder="Từ ngày" pattern="\d{1,2}\/\d{1,2}\/\d{4}" required>
                                        <label for="date_from">Từ ngày</label>
                                    </div>
                                </div>
        
                                <div class="col-6 mt-2">
                                    <div class="form-floating">
                                        <input type="text" class="form-control date-flat-picker" name="date_to"
                                           id="date_to"
                                           data-format="date"
                                           placeholder="Đến ngày" pattern="\d{1,2}\/\d{1,2}\/\d{4}" required>
                                        <label for="date_to">Đến ngày</label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 calculate-spent-time-text">
                                <div class="label-feature">
                                    <div class="row g-0">
                                        <div class="col-6">
                                            <div><span>Số ngày khách ở</span></div>
                                            <b class="bill-month-amount-text" style="color: #ed6004">0 tháng</b>, <b style="color: #ed6004" class="bill-day-amount-text">0 ngày</b>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 room-amount-layout">
                                <div class="label-feature">
                                    <div class="row g-0">
                                        <div class="col-6">
                                            <div><span class="reason_text">Tính tiền nhà</span></div>
                                            <b class="bill-month-amount-text" style="color: #ed6004">0 tháng</b>, <b style="color: #ed6004" class="bill-day-amount-text">0 ngày</b>
                                            x <b class="bill-room-amount">0 đ</b>
                                        </div>
                                        <div class="col-6 text-end">
                                            <div><span>Thành tiền</span></div>
                                            <b class="total-price bill-total-room">0 đ</b>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 deposit-layout">
                            <div class="title-has-icon">
                                <div class="icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                                </div>
                                <div class="title-item-small">
                                    <b class="title_deposit_contract_type">Thu/Trả tiền cọc:</b>
                                    <i class="des des_deposit_contract_type">Tiền đặt cọc khi thuê phòng</i>
                                </div>
                            </div>

                            <div class="col-12 mt-2">
                                <div class="form-floating">
                                    <input data-format="numeric" type="text" min="0" class="form-control" name="deposit_contract_amount" id="deposit_contract_amount"
                                            placeholder="Số tiền cọc thu hoặc trả lại">
                                    <label for="deposit_contract_amount">Số tiền cọc(đ)</label>
                                    <input style="display: none" data-format="numeric" type="text" min="0" name="real_deposit_contract_amount" >
                                    <input style="display: none" data-format="numeric" type="text" min="0" name="contract_deposit_contract_amount" >
                                    <input style="display: none" data-format="numeric" type="text" min="0" value="-1" name="deposit">
                                </div>
                                <div  style="margin-bottom: 0; margin-top: 10px">
                                    <div>
                                        <span class="text-deposit">- Số tiền cọc cần thu </span>: <b class="deposit-contact-paid" style="color:#ff5722">0đ</b><div class="pre-deposit-contact-paid" style="display: none"></div>
                                    </div>
                                    <div style="padding: 10px;border-radius: 10px;background-color: #fff2df; margin-top: 5px;">
                                        <i class="des">* Lưu ý * <br>1. Số tiền cọc hoàn trả không thể lớn hơn số tiền cọc đã thu. <br>2. Số tiền thu cọc không thể lớn hớn mức giá cọc quy định trong hợp đồng</i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 price-item-layout">
                            <div class="title-has-icon">
                                <div class="icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                                </div>
                                <div class="title-item-small">
                                    <b>Tiền dịch vụ</b>
                                    <i class="des">Tính tiền dịch vụ khách xài</i>
                                </div>
                            </div>

                            <div class="waring-addtion-price-item mt-2" style="display: none; background-color: #fff1dd; border-radius: 10px; padding: 10px;">
                                <div class="form-check form-switch">
                                    <input data-format="numeric" class="form-check-input" type="checkbox" value="1" id="price_items_belong_to_date" name="price_items_belong_to_date">
                                    <label class="form-check-label" for="price_items_belong_to_date">
                                        <b>Tính dịch vụ theo ngày thực tế</b>
                                        <p>Áp dụng <strong class="price-item-has-belong-to-date"> </strong> cho <strong style="color: #ff5722"><strong class="spent-days">9</strong> ngày ở</strong></p>
                                    </label>
                                </div>
                            </div>

                            <div class="room-price-item price-items-checkout-layout">
                                <div>Nhà trọ không có dịch vụ nào</div>
                            </div>

                            <div class="label-feature">
                                <div class="row g-0">
                                    <div class="col-6">
                                        <div><span>Tính tiền dịch vụ</span></div>
                                        <div><b><span class="bill-count-price-item">0</span> dịch vụ</b></div>
                                        <span class="bill-month-amount-text" style="color: #ed6004">0 tháng</span>, <span style="color: #ed6004" class="bill-day-amount-text">0 ngày</span>
                                    </div>
                                    <div class="col-6 text-end">
                                        <div><span>Thành tiền</span></div>
                                        <b class="total-price bill-total-price-items">0 đ</b>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="addition-layount">
                            <div class="col-12">
                                <div class="title-has-icon">
                                    <div class="icon">
                                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                                    </div>
                                    <div class="title-item-small">
                                        <b>Cộng thêm / Giảm trừ:</b>
                                        <i class="des">Ví dụ giảm ngày tết, giảm trừ covid, thêm tiền phạt...</i>
                                    </div>
                                </div>    
                            </div>
                            <style type="text/css">
                                #addition-item .item{
                                    border-radius: 5px;
                                    border: 1px solid #ced4da;
                                }
                                #addition-item .form-control{
                                    border:0px;
                                    border-radius: 0;
                                }
                                #addition-item .middle-item, .addition-suggestion-layout .middle-item{
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                    align-items: center;
                                }
                                #addition-item .center-item{
                                    display: flex;
                                    flex-direction: column; 
                                    justify-content: center;
                                }
                                #addition-item .border-top{
                                    border-top: 1px solid #ced4da;
                                }
                                #addition-item .border-bottom{
                                    border-bottom: 1px solid #ced4da;
                                }
                                #addition-item .border-left{
                                    border-left: 1px solid #ced4da;
                                }
                                #addition-item .border-right{
                                    border-right: 1px solid #ced4da;
                                }
                                #addition-item .full{
                                    height: 100%;width: 100%;
                                }
                            </style>
                            <div class="addition-item" id="addition-item">
                                <div class="loz-alert warning" style="margin-bottom: 10px; margin-top: 10px;">
                                    <div class="icon flex-0">
                                        <i data-feather="info"> </i>
                                    </div>
                                    <div class="des flex-1">
                                        Chú ý: Cộng thêm / giảm trừ không nên là tiền cọc. Hãy chọn lý do có tiền cọc để nếu cần
                                    </div>
                                </div>
                            </div> 

                            <div class="col-12">
                                <div style="border-top: 1px solid #eee; padding-top: 10px; text-align: end;">
                                    <button type="button" id="addition-add" class="btn btn-secondary" style="width: 100%;">
                                        <i data-feather="plus"> </i>
                                        Thêm mục cộng thêm / giảm trừ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="display: none">    
                            <div class="col-12">
                                <div class="form-check form-check-inline">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="addition" id="addition_a_bill" checked value="1" data-format="numeric">
                                    <label class="form-check-label" for="addition_a_bill">Cộng thêm</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="addition" id="addition_b_bill" value="-1" data-format="numeric">
                                    <label class="form-check-label" for="addition_b_bill">Giảm trừ</label>
                                </div>
                            </div>

                            <div class="col-12 mt-2">
                                <div class="form-floating">
                                    <input data-format="numeric" type="text" min="0" class="form-control" name="addition_value" id="addition_value"
                                        placeholder="Số tiền cộng thêm hoặc giảm trừ">
                                    <label for="addition_value">Số tiền (đ)</label>
                                </div>
                            </div>

                            <div class="col-12 mt-2">
                                <div class="form-floating">
                                    <textarea type="text" rows="10" style="min-height: 70px" class="form-control" name="addition_reason"
                                            id="addition_reason" placeholder="Nhập lý do"></textarea>
                                    <label for="addition_reason">Lý do</label>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="label-feature">
                                <div class="row g-0">
                                    <div class="col-6">
                                        <div><span class="bill-addition-text">Cộng thêm / giảm trừ</span></div>
                                        <div>Lý do: <i class="bill-addition-reason-text">Chưa có lý do</i></div>
                                    </div>
                                    <div class="col-6 text-end">
                                        <div><span>Thành tiền</span></div>
                                        <b class="total-price bill-total-addition">0 đ</b>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="addition-suggestion-layout">
                            <div class="col-12">
                                <div class="title-has-icon">
                                    <div class="icon">
                                        <img src="/householder-admin/images/icons8-light-100.png" width="60%"/>
                                    </div>
                                    <div class="title-item-small">
                                        <b>Đề xuất giảm trừ / cộng thêm</b>
                                        <i class="des">Các mục bạn có thể giảm trừ / cộng thêm</i>
                                    </div>
                                </div>    
                            </div>
                            <div class="content-suggest mt-2">
                            </div>    
                        </div>

                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky" style="justify-content: space-between; align-items: center">
                <div class="row g-0" style="width: 100%">
                    <div class="col-12 text-end">
                        <div><span>Tổng cộng hóa đơn</span></div>
                        <b class="show-total total-price bill-total" style="color:#3c9e47">2.400.000 đ</b>
                    </div>
                    <div class="col-12 text-end" style="margin-top: 10px">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                        <button type="button" id="submit-edit-bill" class="btn btn-primary">
                            <i data-feather="plus"> </i>
                            Chỉnh sửa hóa đơn
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function () {
        let __el = {
            room_price_items: $('#edit-bill-form .room-price-item'),
            form: $('#edit-bill-form'),
            modal: $("#editBill"),
            submit: $('#submit-edit-bill')
        };

        let block_bill_setting = JSON.parse(JSON.stringify({"note":{"content":null},"enable_qr":1,"payment_default":"cash","show_circle_day":0,"single_send_zalo":0,"template_bill_zalo":1,"enable_rounding_money":1,"extract_receipt_expense":0}));

        let cell = null;
        let billData = null;
        let price_item_start = null;
        let room_price_item_save = null;
        let sugget_addition_items = [];
        let date_terminate = null;
        let priceItemHasBelongToDays = [];

        let price_items_belong_to_date = __el.form.find('input[name="price_items_belong_to_date"]').is(':checked') ? 1 : 0;

         // Kiểm tra xem có tính tiền thuê phòng/giường;
         const isShowRoomAmount = (reason_id) => Boolean((reason_id === 1 || reason_id === 2 || reason_id === 4));

        // Kiểm tra xem có show thời gian ở hay không;
        const isShowCalculateTime = (reason_id) => Boolean((reason_id === 1 || reason_id === 2 || reason_id === 3 || reason_id === 4 || reason_id === 5));

        // Kiểm tra xem có tính tiền dịch vụ hay không;
        const isShowPriceItem = (reason_id) => Boolean(reason_id === 1 || reason_id === 2 || reason_id === 3 || reason_id === 5);

        // Kiểm tra show thu tiền cọc;
        const isShowDepositContractAdd = (reason_id) => Boolean(reason_id === 2 || reason_id === 6);
        // Kiểm tra show hủy tiền cọc;
        const isShowDepositContractReturn = (reason_id) => Boolean(reason_id === 3 || reason_id === 7);

        const isShowDepositContract = (reason_id) => Boolean(isShowDepositContractAdd(reason_id) || isShowDepositContractReturn(reason_id));

         // Render các tổng của các thành phần tính tiền cho người dùng thấy
         const reRenderTotal = () =>{
            if(!billData){
                $.notify({
                    title: 'Thông báo!',
                    message: 'Không tìm thấy dữ liệu hóa đơn.'
                }, {
                    type: "error",
                });
                return false;
            }
            let totalBill = 0;

            // let reason_id = parseInt(__el.form.find('#reason_id').find(":selected").val());
            let reason_id = billData.reason_id
            let monthAmount = parseInt(__helper.convertStringToNumber(__el.form.find('input[name="month_amount"]').val()) ?? 0);
            let dayAmount = parseInt(__helper.convertStringToNumber(__el.form.find('input[name="day_amount"]').val()) ?? 0);

            // Tính tiền phòng;
            let totalDays = monthAmount * 30 + dayAmount;
            let totalRoom = parseInt(totalDays * (billData.room_amount_unit/30));
            if(isShowRoomAmount(reason_id)){
                totalBill += totalRoom;
            }

            let priceItems = {
                count: 0,
                currentPriceItem: [],
                total: 0
            };
            let current_price_item_form = __el.form?.getObjectOfForm()?.price_items;

            if(price_item_start && current_price_item_form){
                Object.keys(current_price_item_form).map((price_item_id)=>{
                    let searchItem = __helper.array.findObjectInArray(price_item_id, 'id', price_item_start);

                    if(searchItem && parseInt(current_price_item_form[searchItem.id]?.is_selected)){
                        priceItems.count += 1;

                        let totalItem = 0;
                        let priceItemForm = current_price_item_form[searchItem.id];

                        if(searchItem.subtraction){
                            let subtraction = parseInt(__helper.convertStringToNumber(priceItemForm['value'][1] ?? '0')) - parseInt(__helper.convertStringToNumber(priceItemForm['value'][0] ?? '0'));

                            totalItem = (subtraction > 0 ? subtraction:0) * searchItem.price;

                            searchItem.value[1] = parseInt(__helper.convertStringToNumber(priceItemForm['value'][1] ?? '0'));
                            searchItem.value[0] = parseInt(__helper.convertStringToNumber(priceItemForm['value'][0] ?? '0'));
                        }else{
                            totalItem = parseInt(__helper.convertStringToNumber(priceItemForm['value'][0] ?? '0')) * searchItem.price;

                            searchItem.value = [parseInt(__helper.convertStringToNumber(priceItemForm['value'][0] ?? '0'))];
                        }

                        if(['nguoi', 'chiec', 'thang'].includes(searchItem['unit']) && price_items_belong_to_date){
                            priceItems.total += monthAmount * totalItem + __helper.roundingMoney(dayAmount * totalItem / 30);
                        }else{
                            priceItems.total += totalItem;
                        }
                        
                        priceItems.currentPriceItem.push(searchItem);

                        // Xử lý hiển thị cho tùy chọn sự phụ thuộc dịch vụ vào ở;
                        priceItemHasBelongToDays = [];
                        __el.form.find('.spent-days').text(totalDays ?? '');
                        if(['nguoi', 'chiec', 'thang'].includes(searchItem?.unit)){
                            const {customerUse} = getCustomerUse(searchItem, price_items_belong_to_date, totalDays);
                            if(customerUse > 0)
                                priceItemHasBelongToDays.push(searchItem.name);
                        }

                        if(totalDays != 30 && totalDays > 0 && !__helper.checkType.isEmpty(priceItemHasBelongToDays)){
                            __el.modal.find(".price-item-has-belong-to-date").text(priceItemHasBelongToDays.join(', '));
                            __el.form.find('.waring-addtion-price-item').css('display' , 'block');
                        }else{
                            __el.form.find('.waring-addtion-price-item').css('display' , 'none');
                            __el.modal.find(".price-item-has-belong-to-date").text(priceItemHasBelongToDays.join(', '));
                        }
                    }
                });
                room_price_item_save = priceItems.currentPriceItem;
            }else{
                room_price_item_save = null;
                //__el.form.find('input[name="price_items_belong_to_date"]').prop('checked', false);
            }
            // Tính tiền dịch vụ;
            if(isShowPriceItem(reason_id)){
                totalBill += (priceItems?.total ?? 0);
            }

            // Tính tiền thu cọc hoặc hoàn cọc;
            let depositType = parseInt(__el.form.find('input[name="deposit"]').val());
            let deposit_contract_amount = depositType *  parseInt(__helper.convertStringToNumber(__el.form.find('input[name="deposit_contract_amount"]').val()) ?? 0); 
            if(isShowDepositContractAdd(reason_id) || isShowDepositContractReturn(reason_id)){
                totalBill += deposit_contract_amount;
            }

            // Tính tiền giảm trừ cộng thêm;
            let addition = parseInt(__el.form.find('input[name="addition"]:checked').val());
            let addition_text = addition > 0 ? 'Cộng thêm' : 'Giảm trừ';
            let addition_value = addition * parseInt(__helper.convertStringToNumber(__el.form.find('input[name="addition_value"]').val()) ?? 0);
            let addition_reason = __el.form.find('textarea[name="addition_reason"]').val();
            totalBill += addition_value;
            
            if(totalBill && block_bill_setting?.enable_rounding_money){
                totalBill = __helper.roundingMoney(totalBill);
            }

            // Xử lý hiển thị tiền nhà;
            __el.modal.find(".bill-month-amount-text").text(`${monthAmount} tháng`);
            __el.modal.find(".bill-day-amount-text").text(`${dayAmount} ngày`);
            __el.modal.find(".bill-room-amount").text(`${__format.currency(billData.room_amount_unit)}`);
            __el.modal.find(".bill-total-room").text(`${__format.currency(totalRoom)}`);

            // Xử lý hiển thị tiền dich vụ
            __el.modal.find(".bill-count-price-item").text(priceItems.count);
            __el.modal.find(".bill-total-price-items").text(`${__format.currency(priceItems.total)}`);

            // Xử lý hiển thị tiền addition
            __el.modal.find(".bill-total-addition").text(`${__format.currency(addition_value)}`);
            __el.modal.find(".bill-addition-text").text(addition_text);
            __el.modal.find(".bill-addition-reason-text").text(addition_reason.length > 0 ? addition_reason : 'Chưa có lý do');
            
            // Xử lý hiển thị tổng;
            __el.modal.find(".bill-total").text(`${__format.currency(totalBill)}`);
        };

        // Renter các price item
        const reRenderFormPriceItems = (priceItems) =>{
            if(priceItems){
                __el.room_price_items.html('');
                room_price_item_save = JSON.parse(JSON.stringify(priceItems)) ?? [];

                Array.isArray(room_price_item_save) &&
                room_price_item_save.length > 0 &&
                room_price_item_save.sort((itemA, itemB) => { 
                    if (itemA.subtraction && !itemB.subtraction) {
                        return -1;
                    } else if (!itemA.subtraction && itemB.subtraction) {
                        return 1;
                    } else {
                        return 0;
                    }
                }).map((item, key)=> {
                    let container = $(`<div class="item">`);
                    let checkNameContainer = $(`<div class="item-check-name">`);

                    checkNameContainer.append(`<input class="form-check-input" type="hidden" value="${item.id}" name="price_items[${item.id}][id]">`);
                    checkNameContainer.append(`<input class="form-check-input" data-price-item-unit="${item.unit}" type="checkbox" id="bill_check_price_item_${item.id}" value="1" checked name="price_items[${item.id}][is_selected]">`);

                    if(item.type === 'frame' && !__helper.checkType.isEmpty(item.frames)){
                        checkNameContainer.append(`<label for="bill_check_price_item_${item.id}"><b>${item.name}</b>`+
                            $.map(item.frames, function(frame, key) {
                                return `<div> ${ parseInt(key) !== 0 ? item.frames[parseInt(key)-1]['volume'] : 0 } - ${frame.volume}, Giá: <b>${__format.currency(frame.price)}/${item.unit_text}</b></div>`
                            }).join('')
                        + "</label>")
                    }else{
                        checkNameContainer.append(`<label for="bill_check_price_item_${item.id}"><b>${item.name}</b> <div>Giá: <b>${__format.currency(item.price)}</b> / ${item.unit_text}</div> </label>`);
                    }

                    let valueContainer = $('<div class="item-value">');
                    if(item.subtraction){
                        valueContainer.append(`<div class="input-group mb-2"><input class="form-control" min="0" id="bill_price_item_${item.id}_0" type="number" placeholder="Nhập số cũ" value="${item?.value ? item?.value[0] : 0}" name="price_items[${item.id}][value][0]"><label class="input-group-text" for="bill_price_item_${item.id}_0">Số cũ</label></div>`);
                        valueContainer.append(`<div class="input-group"><input class="form-control" min="0" id="bill_price_item_${item.id}_1" type="number" placeholder="Nhập số mới" value="${item?.value ? item?.value[1] : 0}" name="price_items[${item.id}][value][1]"> <label class="input-group-text" for="bill_price_item_${item.id}_1">Số mới</label></div>`);
                    }else{
                        valueContainer.append(`<div class="input-group"><input data-price-item-unit="${item.unit}" class="form-control" min="0" type="number" id="bill_price_item_${item.id}" placeholder="Nhập giá trị" value="${item?.value[0] ?? ''}" name="price_items[${item.id}][value][0]"> <label class="input-group-text" for="bill_price_item_${item.id}">${item.unit_text}</label></div>`);
                    }
                    __el.room_price_items.append(container.append(checkNameContainer).append(valueContainer));
                });
            }else{
                __el.room_price_items.html('');
            }
        };

        // Kiểm tra ngày có hợp lệ không
        const isValidDate = (dateInput) => {
            
            if(!dateInput instanceof Date){
                console.log(dateInput + " không phải là ngày tháng");
                return false;
            }

            let year = dateInput.getFullYear(); 
            let month = dateInput.getMonth() + 1; 
            let day = dateInput.getDate(); 

            // Kiểm tra xem năm có trong khoảng từ 1 đến 9999
            if (year < 1 || year > 9999) {
                console.log("Sai năm "+ year);
                return false;
            }

            // Kiểm tra xem tháng có trong khoảng từ 1 đến 12
            if (month < 1 || month > 12) {
                console.log("Sai tháng "+ month);
                return false;
            }

            // Kiểm tra số ngày hợp lệ của từng tháng
            const daysInMonth = new Date(year, month, 0).getDate();
            if (day < 1 || day > daysInMonth) {
                console.log("Sai ngày "+ day);
                return false;
            }

            return true;
        }

        // Lấy ngày cuối cùng của một ngày cho trước;
        const getLastDayOfMonth = (dateString)=> {
            let date = new Date(dateString);
            lastDayInMonth = (new Date(date.getFullYear(), date.getMonth() + 1, 0)).getDate();
            return new Date(date.getFullYear(), date.getMonth(), lastDayInMonth);
        }

        // Lấy số ngày trong tháng của một ngày đã cho
        const getDaysInMonth = (dateInput) => {
            let date = new Date(dateInput);
            return (new Date(date.getFullYear(), date.getMonth() + 1, 0)).getDate();
        }

        // Kiểm tra một ngày có phải đang ở cuối tháng;
        const isLastDay = (dateInput) => {
            let date = new Date(dateInput);
            return getDaysInMonth(date) === date.getDate();
        }

        // Tính ra số tháng và ngày lẻ của 2 ngày cho trước;
        const getMonthsAndDays = (fromDate, toDate, debug = false) => {
            let date1 = new Date(fromDate);
            let date2 = new Date(toDate);
            
            let startYear = date1.getFullYear();
            let startMonth = date1.getMonth();
            let startDate = date1.getDate();
            let daysInMonthOfStartDate = (new Date(startYear, startMonth + 1, 0)).getDate();

            let endYear = date2.getFullYear();
            let endMonth = date2.getMonth();
            let endDate = date2.getDate();
            let daysInMonthOfEndDate = (new Date(endYear, endMonth + 1, 0)).getDate();

            // Tổng số ngày khác;
            let daysDiff = Math.ceil(Math.abs(date2.setHours(23, 59, 59, 999) - date1.setHours(0, 0, 0, 0)) / (1000 * 3600 * 24))

            if(!isValidDate(date1)){
                alert("Ngày bắt đầu không hợp lệ! " + date1);
                return {
                    months: 0,
                    days: 0,
                    daysDiff: 0
                };
            }

            if(!isValidDate(date2)){
                alert("Ngày kết thúc không hợp lệ! " + date2);
                return {
                    months: 0,
                    days: 0,
                    daysDiff: 0
                };
            }
            
            // Khởi tạo giá trị;
            let months = 0;
            let days = 0;

            // Duyệt qua từng tháng từ ngày cho trước đến ngày hiện tại
            let runYear = startYear;
            let runMonth = startMonth;
            while ((runYear === endYear && runMonth <= endMonth) || runYear < endYear) {
                
                let isStart  = runMonth === startMonth && runYear === startYear;
                let isEnd    = runMonth === endMonth && runYear === endYear;
                let isMiddle = !isStart && !isEnd;

                if(!isMiddle){
                    // So sánh trong 1 tháng
                    if(isStart && isEnd){
                        if(startDate === 1 && endDate === daysInMonthOfStartDate){
                            months ++;
                        }else{
                            days += (endDate - startDate) + 1;
                        }
                    }else{

                        // Nếu là điểm bắt đầu;
                        if(isStart){
                            // Đếm số ngày ở;
                            let countDays = (daysInMonthOfStartDate - startDate) + 1;

                            if(countDays === daysInMonthOfStartDate){
                                months ++; 
                            }else{
                                days += countDays;
                            }
                        }

                        // Nếu là điểm cuối;
                        if(isEnd){
                            if(endDate === daysInMonthOfEndDate){
                                months ++; 
                            }else{
                                days += (endDate === 1 ? 0 : endDate);
                            }
                        }
                    }
                }else{
                    // Nếu là các tháng chính giữ (Middle);
                    months++;
                }

                debug &&
                console.log(isStart, isMiddle, isEnd, "runing month: " + (runMonth + 1), 'last day: '+ (new Date(runYear, runMonth + 1, 0)).getDate(), 'months: ' + months, 'days: ' + days);

                // Tăng thêm runMonth & và kiểm tra xem khi đạt tới 12 tháng;
                runMonth ++;
                if (runMonth === 12) {
                    runMonth = 0;
                    runYear ++;
                }
            }

            // Xử lý 2 ngày đầu và ngày cuối trùng nhau chỉ khác tháng hoặc năm;
            if(startDate === endDate && startDate!== 1 && (startMonth !== endMonth || startYear !== endYear)){
                return {
                    months: endDate !== daysInMonthOfEndDate ? months + 1 : months,
                    days: 0,
                    daysDiff: daysDiff
                };
            }

            // Xử lý khi số ngày lẻ lớn hơn 30. Gây ra do tổng ngày lẻ của điển bắt đầu & ngày lẻ của diểm cuối;
            if(days >= 30){
                months = months + Math.floor(days / 30);
                days = days % 30;
            }

            return {
                months: months,
                days: days,
                daysDiff: daysDiff
            };
        };

        // Lấy thông tin ngày tháng và số tháng ngày lẻ đã ở;
        const calculateSpentTime = (reasonIdInit = null, contract = null, currentRoom = null, dateFromInput = null, dateToInput = null) => {
            if(dateFromInput && dateToInput){
                const {months, days, daysDiff} = getMonthsAndDays(dateFromInput, dateToInput);
                return {
                    date_from: dateFromInput,
                    date_to: dateToInput,

                    month_amount: months,
                    day_amount: days,
                };
            }

            let date_from = null;
            let date_to = null;

            let bills_count = contract?.bills_count ?? null;
            let circle_month = currentRoom?.circle_month ?? null;
            let circle_day = currentRoom?.circle_day ?? null;
            
            // Ngày vào ở;
            let date_join = contract?.date_join ? new Date(contract?.date_join) : null;

            // Lấy ra ngày cuối cùng thanh toán phí;
            let date_last_room_amount = currentRoom?.room_amount_date_to ?? null;
            if(date_last_room_amount){
                date_last_room_amount = new Date(date_last_room_amount);
                // Kiểm tra xem có phải là ngày cuối tháng;
                if (isLastDay(date_last_room_amount)) {
                    date_last_room_amount.setDate(date_last_room_amount.getDate() + 1);
                }
            }

            date_from = dateFromInput;
            if(!dateFromInput){
                if (!bills_count) {
                    // Kiểm tra phòng/giường chưa có bill nào;
                    let dateFromInit = date_last_room_amount ?? date_join;
                    date_from = dateFromInit ? new Date(dateFromInit) : new Date();
                } else {
                    // Kiểm tra phòng/giường đã có bill;
                    let dateFrom = date_last_room_amount ?? null;
                    if (dateFrom && isValidDate(new Date(dateFrom))) {
                        date_from = new Date(dateFrom);
                    }
                }
            }

            if ((reasonIdInit === 2 && circle_month === 1) || (reasonIdInit === 2 && date_from.getDate() === 1 && circle_month === 1)){
                // Nếu thu tiền của tháng đầu tiên & chu kỳ thu tiền 1 tháng
                if (currentRoom?.circle_day) {
                    if (date_from.getDate() >= circle_day) {
                        // Lấy ngày kết thúc là ngày ngày của circle của tháng tới số với ngày bắt đầu
                        date_to = new Date(date_from.getFullYear(), date_from.getMonth() + circle_month, circle_day);
                    } else {
                        // Lấy ngày kết thúc là ngày của circle trong cùng một tháng so với ngày bắt đầu;
                        date_to = new Date(date_from.getFullYear(), date_from.getMonth(), circle_day);
                    }
                } else {
                    // Ngày cuối tháng
                    date_to = new Date(date_from.getFullYear(), date_from.getMonth() + 1, 0);
                }
            } else {
                // Cộng thêm chu kỳ 1 hoặc nhiều tháng vào ngày bắt đầu để tạo ra ngày kết thúc;
                date_to = new Date(date_from.getFullYear(), date_from.getMonth() + (circle_month ?? 1), date_from.getDate());
            }

            if (!date_from || !date_to) {
                return {
                    date_from,
                    date_to,
                    month_amount: 0,
                    day_amount: 0,
                };
            }

            const { months, days } = getMonthsAndDays(date_from, date_to);
            return {
                date_from,
                date_to,
                month_amount: months,
                day_amount: days,
            };
        };

        const getCustomerUse = (priceItem, price_items_belong_to_date = 0, days = 0) =>{
            let customerUse = 0;
            let customerUseDescription = "";

            let total = 0;
            let totalDescription = "";

            let textDeta = "";

            if(priceItem?.subtraction === 1){
                textDeta = `[0 - 0]`;
                if(!__helper.checkType.isEmpty(priceItem?.value)){
                    customerUse = (parseInt(priceItem?.value[1] ?? 0) - parseInt(priceItem.value[0] ?? 0)) ?? 0;
                    customerUseDescription = `Số cũ: ${parseInt(priceItem.value[0] ?? 0)} - Số mới: ${parseInt(priceItem?.value[1] ?? 0)}`;
                    textDeta = `[${parseInt(priceItem.value[0] ?? 0)} - ${parseInt(priceItem?.value[1] ?? 0)}]`;
                }else{
                    textDeta `Không sử dụng`;
                }
            }
            
            if(priceItem?.subtraction === 0){
                if(!__helper.checkType.isEmpty(priceItem?.value)){
                    customerUse = parseInt(priceItem.value[0] ?? 0) ?? 0;
                }
            }

            total = priceItem.price * customerUse;
            totalDescription = customerUse ? `${customerUse} ${priceItem.unit_text} x ${priceItem.price} đ`: 'Không sử dụng';

            // Khi dịch vụ phụ thuộc vào ngày ở;
            if(['nguoi', 'chiec', 'thang'].includes(priceItem?.unit) && price_items_belong_to_date){
                total =  __helper.roundingMoney(days * total / 30);
                if(priceItem?.unit === 'thang'){
                    totalDescription = customerUse ? `${priceItem.price} đ/${priceItem.unit_text} cho ${days} ngày`: 'Không sử dụng';
                }else{
                    totalDescription = customerUse ? `${customerUse} ${priceItem.unit_text} x ${__format.currency(priceItem.price)} đ cho ${days} ngày`: 'Không sử dụng';
                }
                
            }

            // Tính theo giá bậc thang;
            if (customerUse && priceItem.type === 'frame' && !__helper.checkType.isEmpty(priceItem.frames)) {
                let remain = customerUse;
                for (const [index, frame] of priceItem.frames.entries()) {
                    if (!__helper.checkType.isEmpty(frame)) {
                        const deltaVolume = parseInt(frame.volume) - ( index > 0 ? priceItem.frames[index-1].volume: 0);
                        if (remain <= deltaVolume) {
                            total = remain * frame.price;
                            break;
                        }
                        remain = remain - deltaVolume;

                        total = (deltaVolume + remain * Number(index + 1 === priceItem.frames.length)) * frame.price;
                    }
                }
                totalDescription = customerUse ? `Tính theo định mức`: 'Không sử dụng'; 
            }

            return {
                customerUse,
                customerUseDescription,

                total,
                totalDescription,
                
                textDeta
            };
        }

        const getAdditionFromItem = () =>{
            let data = __el.form.getObjectOfForm();

            let addition_amount = 0;
            let addition_reason = [];
            
            if(Object.keys(data?.addition_items ?? {}).length !== 0){
                Object.keys(data.addition_items).map((index)=>{
                    let item = data.addition_items[index];
                    addition_amount += item.addition * item.addition_value;

                    if(item.addition_reason)
                        addition_reason.push(item.addition_reason);
                });
                if(addition_amount > 0)
                    __el.form.find('input[name="addition"][value="1"]').prop("checked", true);

                if(addition_amount < 0)
                    __el.form.find('input[name="addition"][value="-1"]').prop("checked", true);

                __el.form.find('input[name="addition_value"]').val(Math.abs(addition_amount));
                __el.form.find('textarea[name="addition_reason"]').val(addition_reason.join(', '));
            }else{
                __el.form.find('input[name="addition"][value="1"]').prop("checked", true);
                __el.form.find('input[name="addition_value"]').val('');
                __el.form.find('textarea[name="addition_reason"]').val('');
            }

            reRenderTotal();
        }

        const additionAdd = (index=null, dataDefault=null) => {
            if(!index){
                index = __el.modal.find('#addition-item .item').length;
            }

            // Tạo phần tử mới
            const newItem = `
                <div class="row g-0 item mt-1 mb-1">
                    <div class="col-3">
                        <div class="middle-item border-right full">
                            <div class="border-bottom center-item full p-2">
                                <div class="form-check">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="addition_items[${index}]['addition']" id="addition_a_bill_${index}" ${dataDefault?.addition && dataDefault?.addition === 1 ? "checked" : ""} value="1">
                                    <label class="form-check-label" for="addition_a_bill_${index}">Cộng [+]</label>
                                </div>
                            </div>
                            <div class="center-item full p-2">
                                <div class="form-check">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="addition_items[${index}]['addition']" id="addition_b_bill_${index}" ${dataDefault?.addition && dataDefault?.addition === -1 ? "checked" : ""} value="-1">
                                    <label class="form-check-label" for="addition_b_bill_${index}">Giảm [-]</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-8 border-right">
                        <div class="row">
                            <div class="col-12">
                                <div class="form-floating">
                                    <input data-format="numeric" type="text" min="0" class="border-bottom form-control" name="addition_items[${index}]['addition_value']" placeholder="Số tiền cộng thêm hoặc giảm trừ" value="${dataDefault?.addition_value ? __format.currencyInput(dataDefault?.addition_value): ''}" required>
                                    <label for="addition_value_${index}">Số tiền (đ)</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea type="text" rows="10" style="min-height: 60px" class="form-control" name="addition_items[${index}]['addition_reason']" placeholder="Nhập lý do" value="${dataDefault?.addition_reason ? dataDefault?.addition_reason: ''}" required>${dataDefault?.addition_reason ? dataDefault?.addition_reason: ''}</textarea>
                                    <label for="addition_reason_${index}">Lý do</label>
                                </div>
                            </div>
                        </div>    
                    </div>  
                    <div class="col-1" style="border-radius: 0 5px 5px 0;display: flex;flex-direction: column;justify-content: center;align-items: center;background-color: #ffeee9;">
                        <button class="btn delete" type="button" style="color:red; height: 100%;">Xóa</button>
                    </div>  
                </div>`;
            
            // Thêm phần tử mới vào addition-item
            __el.modal.find('#addition-item').append(newItem);

            __el.modal.find('input[data-format="numeric"][type="text"]').on('input', function() {
                let value = $(this).val();
                
                let number = __helper.convertStringToNumber(value);
                let newVal = __format.currencyInput(number);

                $(this).val(value ==='' ? '': isNaN(number) ? '': newVal);
            });

            getAdditionFromItem();

            // Cật nhật là thuộc tính sử dụng của đề nghị;
            if(dataDefault && dataDefault.length !== 0){
                sugget_addition_items = sugget_addition_items.map((item)=>{
                    if(item.id === dataDefault.id){
                        item.has_use = 1;
                    }
                    return item;
                });
                renderAdditionSuggestion(sugget_addition_items);
            }
        };

        const renderAdditionSuggestion =(data=null) =>{
            __el.modal.find('.addition-suggestion-layout .content-suggest').html('');
            let showSuggest = false;
            if(data?.length > 0){
                data = data.map((item)=>{
                    if(!item?.has_use){
                        showSuggest = 1;
                        __el.modal.find('.addition-suggestion-layout .content-suggest').append($('<div class="col-12 d-flex mb-2" style="padding: 10px;border: 1px solid #ced4da;border-radius: 7px;">').append(
                        `
                            <div style="flex:1">
                                <b>${item.addition_title}</b>
                                <div style="font-size: 20px;color:${item.addition>0? '#4CAF50':'#FF5722'}"><b>${__format.currencyInput(item.addition * item.addition_value)}đ</b></div>
                                <p>${item.addition_reason}</p>
                            </div>
                        `
                    ).append($(`
                            <div class="middle-item">
                                <a href="javascript:;" style="color: #0d6efd;text-decoration: underline;border: 1px solid;border-radius: 5px;padding:7px 10px;margin-left: 10px;">
                                    Áp dụng
                                </a>
                            </div>
                        `).click(()=>additionAdd(null, item))));  
                    }
                    return item;
                });
            }
            __el.modal.find('.addition-suggestion-layout').css('display',  showSuggest ? 'block':'none');   
        }

        // Áp dụng mục đề xuất tới addition;
        const useAdditionSuggest = (additionSuggestItem)=>{
            additionAdd(null, additionSuggestItem);
        }

        __el.form.on('keyup', '#addition-item textarea', function (e) {
            getAdditionFromItem();
        });

        // Xóa phần tử khi nhấn nút xóa
        __el.form.find('.addition-layount ').on('click', '.delete', function() {
            $(this).closest('.item').remove();
            getAdditionFromItem();
        });

        __el.form.find('.addition-layount #addition-add').on('click', (e)=>{
            additionAdd();
        });


        flatpickr(__el.form.find('input[name="month"]'), {
            allowInput: true,
            enableTime: false,
            dateFormat: "m/Y",
            locale: 'vn',
            defaultDate:'today',
            plugins: [
                new monthSelectPlugin({
                    shorthand: true, //defaults to false
                    dateFormat: "m/Y", //defaults to "F Y"
                    altFormat: "F Y", //defaults to "F Y"
                    theme: "light" // defaults to "light"
                })
            ]
        });

        flatpickr(__el.form.find('input[name="date"]'), {
            defaultDate: 'today',
            allowInput: true,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn'
        });

        flatpickr(__el.form.find('input[name="deadline_bill_date"]'), {
            defaultDate: new Date().fp_incr(__current_block?.deadline_bill ?? 0).toLocaleDateString('vi', {
                year: "numeric",
                month: "2-digit",
                day: "numeric"
            }),
            allowInput: true,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn'
        });

        let date_from_pre = null;
        flatpickr(__el.form.find('input[name="date_from"]'), {
            defaultDate: null,
            allowInput: true,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn',
            onOpen: function(selectedDates, dateStr, instance) {
                date_from_pre = selectedDates.length!==0 ? selectedDates[0].toLocaleDateString() : null;
            },
            onChange: function(selectedDates, dateStr, instance) {
                let dateFrom = new Date(selectedDates[0]);
                let reason_id = billData.reason_id
               
                if(date_from_pre !== dateFrom.toLocaleDateString()){

                    date_from_pre = dateFrom.toLocaleDateString();
                    let dateTo = null;
                    if(date_terminate && reason_id === 3){
                        dateTo = date_terminate;
                    }

                    if(dateFrom && dateTo){
                        const {months, days} = getMonthsAndDays(dateFrom, dateTo);
                        __el.form.find('input[name="month_amount"]').val(months);
                        __el.form.find('input[name="day_amount"]').val(days);
                    }
                }
            }
        });

        let date_to_pre = null;
        flatpickr(__el.form.find('input[name="date_to"]'), {
            defaultDate: null,
            allowInput: true,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn',
            onOpen: function(selectedDates, dateStr, instance) {
                date_from_pre = selectedDates.length!==0 ? selectedDates[0].toLocaleDateString() : null;
            },
            onChange: function(selectedDates, dateStr, instance) {
                let dateTo = new Date(selectedDates[0]);
                let reason_id = billData.reason_id

                let data = __el.form.getObjectOfForm();
                let dateFrom = new Date(data?.date_from) ?? new Date();

                if(date_to_pre !== dateTo.toLocaleDateString()){

                    date_to_pre = dateTo.toLocaleDateString();
                    if(reason_id === 3){
                        date_terminate = dateTo;
                    }

                    if(dateFrom && dateTo){
                        const {months, days} = getMonthsAndDays(dateFrom, dateTo);
                        __el.form.find('input[name="month_amount"]').val(months);
                        __el.form.find('input[name="day_amount"]').val(days);
                    }
                }
            }
        });

        __el.form.on('keyup', '#addition-item textarea', function (e) {
            getAdditionFromItem();
        });
        
        __el.form.on('change', 'input', function (e) {
            if(['radio', 'number', 'text', 'checkbox'].includes($(this).attr('type'))){
                price_items_belong_to_date = __el.form.find('input[name="price_items_belong_to_date"]').is(':checked') ? 1 : 0;
                getAdditionFromItem();
                reRenderTotal();
            }
        });

        __el.form.on('keyup', 'input', function (e) {
            if(['radio', 'number', 'text', 'checkbox'].includes($(this).attr('type'))){
                price_items_belong_to_date = __el.form.find('input[name="price_items_belong_to_date"]').is(':checked') ? 1 : 0;
                getAdditionFromItem();
                reRenderTotal();
            }
        });

        __el.form.on('change', 'textarea', function (e) {
            reRenderTotal();
        });

        __el.form.find('#reason_id').on('change', function() {
            let reason_id = parseInt($(this).find(":selected").val());
            let data = __el.form.getObjectOfForm();

            let dateFrom = data?.date_from ?? null;
            let dateTo = data?.date_to ?? null;
            
        });

        new __modalForm(
            __el.modal.get(0),
            __el.form.get(0),
            __el.submit.get(0)
        ).start(null, {
            __openModalForm: function ({relatedTarget}) {
                cell = relatedTarget?.cell ?? null;
                billData = relatedTarget?.cell?.getData() ?? null;
                __el.form.setObjectToForm(billData);

                $.transferData({
                    method: "GET",
                    url: __helper.url.urlPattern(__routeApi.room.show, {
                        id: billData.room_id
                    }),
                    success: function (res) {
                        let dataRes = res?.data;
                        let roomData = res?.data ?? null;
                        let contract = res?.data?.contract ?? null;
                        price_item_start = JSON.parse(JSON.stringify(__preparePriceItems(billData.price_items ?? null, roomData ?? null)));

                        __el.modal.find(".room-name").text(`"${roomData?.name}"`);

                        // Xử lý layout tính số ngày ở;
                        __el.form.find('.calculate-spent-time-layout').css('display', 'none');
                        if(isShowCalculateTime(billData.reason_id)){
                            __el.form.find('.calculate-spent-time-layout').css('display', 'block');
                            __el.form.find('.calculate-spent-time-text').css('display', 'block');
                        }

                        // Set ngày thanh toán tiền phòng;
                        __el.form.find('.room-amount-layout').css('display', 'none');
                        __el.form.find('.room-amount-layout input').map((index, input)=>{input.removeAttribute('required')});
                        __el.form.find('.reason_text').text(billData.reason);
                        if(isShowRoomAmount(billData.reason_id)){
                            __el.form.find('.room-amount-layout input').map((index, input)=>{
                                input.setAttribute('required', '');
                            });
                            __el.form.find('.room-amount-layout').css('display', 'block');
                            __el.form.find('.calculate-spent-time-text').css('display', 'none');
                        }

                        // Xử lý thông tin của phòng;
                        __el.form.find('.date-join').text(roomData?.date_join_format ?? 'Không xác định');
                        __el.form.find('.circle-month').text(roomData?.circle_month ?? 'Không xác định');
                        __el.form.find('.circle-day').text(roomData?.circle_day ? `ngày ${roomData?.circle_day} thu` : 'thu cuối tháng');
                        
                        // Xử lý thông tin ngày của hóa đơn;
                        __el.form.find('input[name="month"]').get(0)._flatpickr.setDate(new Date(billData.date), true, "d/m/Y");
                        __el.form.find('input[name="date"]').get(0)._flatpickr.setDate(new Date(billData.date), true, "d/m/Y");
                        __el.form.find('input[name="deadline_bill_date"]').get(0)._flatpickr.setDate(new Date().fp_incr(__current_block?.deadline_bill ?? 5));

                        // Xử lý số ngày ở;
                        __el.form.find('input[name="date_from"]').get(0)._flatpickr.setDate(new Date(billData.date_from), true, "d/m/Y");
                        __el.form.find('input[name="date_to"]').get(0)._flatpickr.setDate(new Date(billData.date_to), true, "d/m/Y");
                        __el.form.find('input[name="month_amount"]').val(billData.month_amount);
                        __el.form.find('input[name="day_amount"]').val(billData.day_amount);


                        // Xử lý tiền cọc
                        let deposit_contract_amount = 0;
                        let depositType = -1;
                        __el.form.find('.deposit-layout').css('display', 'none');

                        // Xử lý thu tiền cọc;
                        if(isShowDepositContractAdd(billData.reason_id)){
                            // Tính ra tiền cọc cần thu;
                            deposit_contract_amount = parseInt(contract?.deposit_contract_amount ?? 0) - parseInt( contract?.real_deposit_contract_amount ?? 0);
                            
                            __el.form.find('.deposit-layout').css('display', 'block');
                            __el.form.find('.title_deposit_contract_type').text("Thu tiền cọc");
                            __el.form.find('.des_deposit_contract_type').text("Thu tiền cọc nếu có phát sinh");
                            __el.form.find('.text-deposit').text("Số tiền cọc cần thu ");
                            __el.form.find(".deposit-contact-paid").text(`${__format.currency(deposit_contract_amount)}`);

                            if(contract?.real_deposit_contract_amount){
                                __el.form.find(".pre-deposit-contact-paid").css('display', 'initial').html(`, Số tiền đã thu trước đó <b style="color: #3c9e47">${__format.currency(contract.real_deposit_contract_amount)}</b>`);
                            }else{
                                __el.form.find(".pre-deposit-contact-paid").css('display', 'none').html(``);
                            }

                            // Set thể loại là thu tiền cọc;
                            depositType = 1;   
                        }
                        // Xử lý trả tiền cọc;
                        if(isShowDepositContractReturn(billData.reason_id)){
                            deposit_contract_amount = contract.real_deposit_contract_amount ?? 0
                            __el.form.find('.deposit-layout').css('display', 'block');
                            __el.form.find('.title_deposit_contract_type').text("Trả tiền cọc");
                            __el.form.find('.des_deposit_contract_type').text("Trả tiền cọc nếu trước đó có thu khi vào làm hợp đồng");
                            __el.form.find('.text-deposit').text("Số tiền cọc cần hoàn ");
                            __el.form.find(".deposit-contact-paid").text(`${__format.currency(deposit_contract_amount)}`);
                            
                            // Set thể loại là trả tiền cọc;
                            depositType = -1;
                        }

                        // Set html cho cọc;
                        __el.form.find('input[name="real_deposit_contract_amount"]').val(contract?.real_deposit_contract_amount ?? 0);
                        __el.form.find('input[name="contract_deposit_contract_amount"]').val(contract?.deposit_contract_amount ?? 0);
                        __el.form.find('input[name="deposit_contract_amount"]').val(__format.currencyInput(billData.deposit_contract_amount ?? 0));
                        __el.form.find('input[name="deposit"]').val(depositType);

                        //Xử lý tiền dịch vụ
                        if(!isShowPriceItem(billData.reason_id)){
                            __el.form.find('.price-item-layout').css('display', 'none');
                            __el.form.find('.waring-addtion-price-item').css('display' , 'none');

                            reRenderFormPriceItems(null);
                        }else{
                            __el.form.find('.price-item-layout').css('display', 'block');

                            if(billData.total_day != 30 && billData.total_day > 0){
                                __el.form.find('.waring-addtion-price-item').css('display' , 'block');
                                __el.form.find('.spent-days').text(billData.total_day ?? '');
                            }else{
                                __el.form.find('.waring-addtion-price-item').css('display' , 'none');
                            }
                            reRenderFormPriceItems(price_item_start);
                        }

                        // Xử lý giảm trừ và cộng thêm;
                        if(!__helper.checkType.isEmpty(billData.addition_items)){
                            $.each(billData.addition_items, function( index, item ) {
                                additionAdd(index, item);
                            });
                        }
                        
                        // Xử lý giảm trừ hoặc cộng thêm;
                        if(!__helper.checkType.isEmpty(billData.sugget_addition_items)){
                            renderAdditionSuggestion(billData.sugget_addition_items);
                            __el.form.find('.addition-suggestion-layout').css('display', 'block');  
                        }else{
                            __el.form.find('.addition-suggestion-layout').css('display','none'); 
                            renderAdditionSuggestion(null);
                        }

                        reRenderTotal();
                    },
                    fail: (res)=>{
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            }, 
            __submitModalForm: function (e) {
                let data = __el.form.getObjectOfForm();
                
                if (!__el.form.get(0).checkValidity()) {
                    __el.form.get(0).classList.add('was-validated');
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Vui lòng nhập đầy đủ thông tin trước khi thực hiện",
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                if(data.addition_value && (data.addition_reason==='undefined' || !data?.addition_reason || data?.addition_reason?.length===0)){
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Vui lòng nhập lý do giảm trừ hoặc cộng thêm",
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                data.room_id = billData.room_id;
                data.price_items = room_price_item_save;
                data.month = parseInt(__el.form.find('input[name="month"]').val().split("/")[0]);
                data.year = parseInt(__el.form.find('input[name="month"]').val().split("/")[1]);
                // data.reason_text = __el.form.find('select[name="reason_id"] option:selected').text();
                data.reason_text = billData.reason
                data.reason_id = billData.reason_id
                data.addition_value = parseInt(data.addition) * data.addition_value;
                
                let addition_items = Object.values(data?.addition_items ?? {});
                data.addition_items = addition_items.length!==0 ? addition_items : null;

                if(data.deposit_contract_amount)
                    data.deposit_contract_amount = parseInt(data.deposit) * parseInt(data.deposit_contract_amount);

                if(!__helper.checkType.isEmpty(data.price_items)){
                    $.each(data.price_items, function( index, item ) {
                        const {customerUse, customerUseDescription,total,totalDescription} = getCustomerUse(item, price_items_belong_to_date, (data.month_amount * 30 + data.day_amount));
                        item.use                = customerUse
                        item.use_description    = customerUseDescription
                        item.total              = total
                        item.total_description  = totalDescription
                    });
                }
                
                $.transferData({
                    method: "POST",
                    url: __helper.url.urlPattern(__routeApi.bill.update, {
                        id: billData.id
                    }),
                    data,
                    success: function (res) {
                        Swal.fire({
                            title: 'Thành công!',
                            html: res.message,
                            icon: 'success',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đóng'
                        }).then((result)=>{
                            res?.data?.bill && cell &&
                            cell.getRow().update(res.data.bill);
                            bootstrap.Modal.getInstance(__el.modal.get(0)).hide();
                        });
                    },
                    fail: (res)=>{
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            },
            __closeModalForm: function (e) {
                let oldAddition = __el.form.find('.addition-layount .item');
                if(oldAddition.length >= 0){
                    $.each(oldAddition, function( index, item ) {
                        $(item).closest('.item').remove();
                        getAdditionFromItem();
                    });
                }
                __el.form.get(0).reset();
            },
	    });
    })
</script>
                </div>
            </div>
            <!-- Modal manage block -->
 <div class="modal fade" id="manageBlock" tabindex="-1" aria-labelledby="manageBlockLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-header--sticky">
                <i style="margin-right: 15px" data-feather="home"> </i>
                <h5 class="modal-title" id="manageBlockLabel">
                    Danh sách nhà trọ của bạn
                    <p style="font-size: 14px; font-weight: normal; font-style: italic; margin: 0">Tới 1 nhà trọ và quản lý</p>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
            </div>
            <div class="modal-body">
                                    <div class="item-feature active d-flex align-items-center justify-content-between mb-2">
                        <div class="info" style="flex: 1">
                            <h6>Nhà trọ ASUS</h6>
                            <p>63, An Tịnh, Trảng Bàng, Tây Ninh</p>
                        </div>

                                                                                    <div class="btn-round disabled btn-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="Không thể xóa nhà trọ đang thao tác">
                                    <i data-feather="trash-2"> </i>
                                </div>
                                                                            
                                                <div class="btn-round btn-edit"
                                data-bs-toggle="modal"
                                data-bs-target="#addBlock"
                                data-block='{"id":7081,"name":"ASUS","name_full":"Nh\u00e0 tr\u1ecd ASUS","user_id":8151,"category":0,"category_name":"Nh\u00e0 tr\u1ecd","category_name_short":"Nh\u00e0 tr\u1ecd","room_type":"room","room_type_name":"ph\u00f2ng","type":"floors","room_total":6,"count_floor":2,"area":15,"room_amount":36,"ele_amount":0,"water_amount":0,"price_items_cache":[{"id":23351,"name":"Ti\u1ec1n \u0111i\u1ec7n","type":"constant","unit":"kwh","price":1700,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"ele","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"KWh","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1},{"id":23352,"name":"Ti\u1ec1n n\u01b0\u1edbc","type":"constant","unit":"khoi","price":18000,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"water","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"Kh\u1ed1i","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1}],"circle_order":6,"deadline_bill":10,"bill_setting":{"note":{"content":null},"enable_qr":1,"payment_default":"cash","show_circle_day":0,"single_send_zalo":0,"template_bill_zalo":1,"enable_rounding_money":1,"extract_receipt_expense":0},"app_renter_setting":{"allow_update_car":1,"default_password":123456789,"allow_close_clock":0,"auto_create_account":0,"allow_ticket_contract":1,"allow_update_customer":1},"room_group":[{"id":1,"name":"T\u1ea7ng tr\u1ec7t","index":0,"label":"T\u1ea7ng tr\u1ec7t","value":1},{"id":2,"name":"T\u1ea7ng 1","index":1,"label":"T\u1ea7ng 1","value":2}],"max_member":1,"open_door":null,"close_door":null,"rule":null,"extension":null,"data_log":{"menu_label":{"pay_bill":0,"room_list":"0\/6","new_session":6,"deposit_request":6,"terminate_contract":0}},"setting":{"car_function":1,"post_function":1,"agent_function":1,"asset_function":1,"price_item_ele":3,"price_item_wifi":0,"price_item_trash":0,"price_item_water":3,"task_job_function":1,"send_sms_when_create_bill":1,"contract_document_function":0},"province_id":72,"district_id":712,"ward_id":25732,"address_component":{"address":"63, An T\u1ecbnh, Tr\u1ea3ng B\u00e0ng, T\u00e2y Ninh","ward_id":"25732","position":{"latitude":"10.7829132","longitude":"106.6961898"},"district_id":"712","province_id":"72","address_detail":"63"},"address":"63, An T\u1ecbnh, Tr\u1ea3ng B\u00e0ng, T\u00e2y Ninh","latitude":10.7829132,"longitude":106.6961898,"auto_create_room":1,"post_ids":[]}'>
                            <div style="width: 100%; height: 100%; align-items: center;
                            display: inherit;
                            text-align: center;
                            justify-content: center; color: #000" data-bs-toggle="tooltip" data-bs-placement="top" title="Chỉnh sửa Nhà trọ">
                                <i data-feather="edit"> </i>
                            </div>
                        </div>
                                               
                        <a class="btn-round btn-go-to"
                           data-bs-toggle="tooltip" data-bs-placement="top" title="Tới quản lý Nhà trọ"
                           href="/quan-ly/nha-tro/7081">
                            <i data-feather="arrow-right"> </i>
                        </a>
                    </div>
                            </div>
        </div>
    </div>
</div>
 <script type="text/javascript">
     $(document).ready(function() {
         $("#manageBlock .btn-edit").click(function(e){
             let ModalAddBlock = $($(this).data('bsTarget'));
             ModalAddBlock &&
             ModalAddBlock.data('block', $(this).data('block'));
         });

         $("#manageBlock .btn-delete").click(function(e){
             Swal.fire({
                 title: 'Thông báo!',
                 text: "Bạn có chắc chắn muốn xóa nhà trọ",
                 icon: 'warning',
                 showCancelButton: true,
                 cancelButtonColor: '#d33',
                 confirmButtonColor: '#3085d6',
                 confirmButtonText: 'Vâng! tôi muốn xóa',
                 cancelButtonText: 'Không xóa'
             }).then((result) => {
                 if (result.isConfirmed) {
                    $.transferData({
                        method: "GET",
                        url: __helper.url.urlPattern(__routeApi.block.delete, {
                                block_id : parseInt($(this).data('id')) }),
                        success: (res) => {
                            Swal.fire({
                                title: 'Thành công!',
                                text: res.message,
                                icon: 'success',
                                confirmButtonColor: '#3c9e47',
                                confirmButtonText: 'Đóng'
                            }).then((result) => {
                                window.location.href = "/quan-ly";
                            });
                        }
                    });
                 }
             });
         });
     });
 </script>
                <!-- Modal add block -->
<div class="modal fade" data-bs-backdrop="static"  id="addBlock" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                <i data-feather="home"> </i>
                </div>
                <h5 class="modal-title">Thêm nhà trọ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="add-block-form" novalidate>
                    <input type="hidden" name="_token" value="CZqXP04OzKEuLEt01gkxMY2DrN3sCqnCK8eSZ2o4">                    <div class="row g-3">
                        <div class="col-12">
                            <div class="title-item-small">
                                <b>Thông tin:</b>
                                <i class="des">Các thông tin nhà trọ cơ bản</i>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-floating">
                                <select data-format="numeric" id="category" name="category" class="form-select form-control" required>
                                                                                                                        <option value="0">Nhà trọ</option>
                                                                                    <option value="1">Ký túc xá/sleepbox</option>
                                                                                    <option value="2">Chung cư mini</option>
                                                                                    <option value="5">Tòa nhà chung cư</option>
                                                                                    <option value="3">Nhà nguyên căn</option>
                                                                                    <option value="4">Văn phòng cho thuê</option>
                                                                                                            </select>
                                <label for="category">Loại nhà trọ</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" name="name" id="name" required
                                    placeholder="Tên nhà trọ">
                                <label for="name">Tên nhà trọ</label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập tên nhà trọ
                                </div>
                            </div>
                        </div>

                        <div class="col-6 mt-2 invisible d-none">
                                                                                                <div class="form-check">
                                        <input class="form-check-input" type="radio" id="room_type_room" name="room_type" value="room">
                                        <label class="form-check-label" for="room_type_room">
                                            <b>Thuê theo phòng</b>
                                            <p>Tính tiền thuê theo phòng</p>
                                        </label>
                                    </div>
                                                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="room_type_bed" name="room_type" value="bed">
                                        <label class="form-check-label" for="room_type_bed">
                                            <b>Thuê theo giường</b>
                                            <p>Tính tiền theo giường</p>
                                        </label>
                                    </div>
                                                                                    </div>

                        <div class="col-12">
                            <div class="title-item-small">
                                <b>Chọn phương thức khởi tạo dữ liệu</b>
                                <i class="des">Chọn 1 trong 3 phương thức tạo khởi tạo dữ liệu</i>
                            </div>
                        </div>
                        <div class="col-12 mt-2 type-input-room hide-when-edit d-flex" style="text-align: center;">
                            <style type="text/css">
                                .type-input-room .item{
                                    width: 100%;
                                    border: 1px solid #ccc;
                                    margin: 5px;
                                    padding: 5px;
                                    border-radius: 10px;
                                }
                            </style>
                            <div class="item">
                                <div class="form-check form-check-inline">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="auto_create_room" id="enable" checked value="1">
                                    <label class="form-check-label" for="enable">
                                        <b>Tạo dữ liệu <span class="room_type_name">phòng</span> tự động </b>
                                    </label>
                                </div>
                            </div> 
                            <div class="item">  
                                <div class="form-check form-check-inline">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="auto_create_room" id="excel" value="2">
                                    <label class="form-check-label" for="excel">
                                        <b>Tạo dữ liệu <span class="room_type_name">phòng</span> từ Excel</b>
                                    </label>
                                </div>
                            </div>
                            <div class="item">
                                <div class="form-check form-check-inline">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="auto_create_room" id="disable" value="0">
                                    <label class="form-check-label" for="disable">
                                        <b>Tạo dữ liệu <span class="room_type_name">phòng</span> thủ công </b>
                                    </label>
                                </div>
                            </div>    
                        </div>

                        <div class="col-12 mt-2 info-auto-create-room-enable">
                            <div class="loz-alert info mt-2 mb-2">
                                <div class="icon flex-0">
                                    <i data-feather="info" size="20"> </i>
                                </div>
                                <div class="des flex-1">
                                    <b>Ghi chú:</b> Vui lòng chọn số tầng và nhập số <span class="room_type_name">phòng</span> để hệ thống tự động tạo dữ liệu <span class="room_type_name">phòng</span> cho bạn
                                </div>
                            </div>
                        </div>

                        <div class="col-12 mt-2 d-none info-auto-create-room-disable">
                            <div class="loz-alert warning mt-2 mb-2">
                                <div class="icon flex-0">
                                    <i data-feather="info" size="20"> </i>
                                </div>
                                <div class="des flex-1">
                                    <b>Ghi chú:</b> Bạn phải thực hiện tạo dữ liệu cho từng <span class="room_type_name">phòng</span> bằng thủ công.
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-none import-from-excel-layout">
                            <style type="text/css">
                                .stepProgress {
                                    position: relative;
                                    padding-left: 45px;
                                    list-style: none;
                                }
                                .stepProgress::before {
                                    display: inline-block;
                                    content: '';
                                    position: absolute;
                                    top: 0;
                                    left: 15px;
                                    width: 10px;
                                    height: 100%;
                                    border-left: 2px solid #CCC;
                                }
                                .stepProgress-item {
                                    position: relative;
                                    counter-increment: list;
                                }
                                .stepProgress-item:not(:last-child) {
                                    padding-bottom: 20px;
                                }
                                .stepProgress-item::before {
                                    display: inline-block;
                                    content: '';
                                    position: absolute;
                                    left: -30px;
                                    height: 100%;
                                    width: 10px;
                                }
                                .stepProgress-item::after {
                                    content: '';
                                    display: inline-block;
                                    position: absolute;
                                    top: 0;
                                    left: -39px;
                                    width: 20px;
                                    height: 20px;
                                    border: 2px solid #CCC;
                                    border-radius: 50%;
                                    background-color: #FFF;
                                }
                            </style>
                            <ul class="stepProgress">
                                <li class="stepProgress-item">Bước 1: Tải file mẫu</li>
                                <li class="stepProgress-item">Bước 2: Nhập dữ liệu của bạn vào file mẫu</li>
                                <li class="stepProgress-item">Bước 3: Upload file mẫu lên để nhập liệu</li>
                            </ul>
                            <div class="row g-2">
                                <div class="col-6 mt-2 import-excel">
                                    <div class="image-upload-simple" style="height: 100px;">
                                        <input type="file" style="display: none" id="file-excel"  accept=".xlsx">
                                        <div class="container-upload " id="import-excel-trigger" style="border: 2px dashed #ccc;">
                                            <div class="placeholder __add-more-imge" style="display: grid;cursor: pointer !important;width: 100%;align-items: center;justify-content: center;height: 100%;margin:-10px;">
                                                <div class="icon-upload" style="margin:auto"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload-cloud"><polyline points="16 16 12 12 8 16"></polyline><line x1="12" y1="12" x2="12" y2="21"></line><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path><polyline points="16 16 12 12 8 16"></polyline></svg>
                                                </div>
                                                <label style="text-decoration:underline" id="text-import">File Excel cần nhập dữ liệu</label>
                                            </div>
                                        </div>
                                        <div class="invalid-feedback"> Vui lòng chọn file Excel</div>
                                    </div>
                                </div>
                                <div class="col-6 mt-2 download-template-excel">
                                    <a href="/download-template-excel" style=" color: inherit;">
                                        <div class="image-upload-simple" style="height: 100px;">
                                            <div class="container-upload " id="download-excel-trigger" style="border: 2px dashed #ccc;">
                                                <div class="placeholder __add-more-imge" style="display: grid;cursor: pointer !important;width: 100%;align-items: center;justify-content: center;height: 100%;margin:-10px;">
                                                    <div class="icon-upload" style="margin:auto">
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="main-grid-item-icon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                                            <polyline points="8 17 12 21 16 17" />
                                                            <line x1="12" x2="12" y1="12" y2="21" />
                                                            <path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29" />
                                                        </svg>
                                                    </div>
                                                    <label style="text-decoration:underline" id="text-download">Tải file Excel mẫu</label>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                
                                </div>
                            </div>
                        </div>

                        <div class="col-6 mt-2 count_floor">
                            <div class="form-floating">
                                <select data-format="numeric" id="count_floor" name="count_floor" class="form-select form-control" required>
                                                                                                                        <option value="1">Tầng trệt (không có tầng)</option>
                                                                                    <option value="2">2 tầng (Gồm 1 trệt + 1 tầng)</option>
                                                                                    <option value="3">3 tầng (Gồm 1 trệt + 2 tầng)</option>
                                                                                    <option value="4">4 tầng (Gồm 1 trệt + 3 tầng)</option>
                                                                                    <option value="5">5 tầng (Gồm 1 trệt + 4 tầng)</option>
                                                                                    <option value="6">6 tầng (Gồm 1 trệt + 5 tầng)</option>
                                                                                    <option value="7">7 tầng (Gồm 1 trệt + 6 tầng)</option>
                                                                                    <option value="8">8 tầng (Gồm 1 trệt + 7 tầng)</option>
                                                                                                            </select>
                                <label for="count_floor">Loại nhà trọ</label>
                            </div>
                        </div>
                       
                        <div class="col-6 mt-2 total-room">
                            <div class="form-floating">
                                <input data-format="numeric" type="text" class="form-control" name="room_total" id="room_total" placeholder="Số phòng/giường" required>
                                <label for="room_total">Số <span class="room_type_name">phòng</span></label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập tổng số <span class="room_type_name">phòng</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="title-item-small">
                                <b>Địa chỉ:</b>
                                <i class="des">Giúp cho khách thuê của bạn có thể tìm thấy nhà trọ của bạn dễ
                                    dàng hơn</i>
                            </div>
                        </div>
                        <div class="col-12">
                            <div id="block_address" class="address_component_container row g-2">
    <div class="col-6 mt-2">
        <div class="form-floating">
            <select data-format="numeric" name="address_component[province_id]" class="form-select form-control province" required>
                <option value="">Tỉnh/Thành phố</option>
            </select>
            <label for="province">Chọn Tỉnh/Thành phố</label>
            <div class="invalid-feedback">
                Vui lòng chọn thành phố
            </div>
        </div>
    </div>
    <div class="col-6 mt-2">
        <div class="form-floating">
            <select data-format="numeric" name="address_component[district_id]" class="form-select form-control district" required>
                <option value="">Quận/Huyện</option>
            </select>
            <label for="district">Chọn Quận/Huyện</label>
            <div class="invalid-feedback">
                Vui lòng chọn quận hoặc huyện
            </div>
        </div>
    </div>
    <div class="col-12 mt-2">
        <div class="form-floating">
            <select data-format="numeric" name="address_component[ward_id]" class="form-select form-control ward" required>
                <option value="">Phường/Xã</option>
            </select>
            <label for="ward">Chọn Phường/Xã</label>
            <div class="invalid-feedback">
                Vui lòng chọn phường hoặc xã
            </div>
        </div>
    </div>
    <div class="col-12 mt-2">
        <div class="form-floating">
            <input type="text" class="form-control address_detail" name="address_component[address_detail]"
                placeholder="ví dụ: 122 - Đường Nguyễn Duy Trinh" required>
            <label for="address_detail">Địa chỉ chi tiết. Ví dụ: 122 - Đường Nguyễn Duy Trinh</label>
            <div class="invalid-feedback">
                Vui lòng nhập địa chỉ chi tiết
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        let __el = {
            province: $("#block_address").find(".province"),
            district: $("#block_address").find(".district"), 
            ward    : $("#block_address").find(".ward"),

            address_detail : $("#block_address").find(".address_detail"),
            address_show_container: $("#block_address").find(".address-detail-show-container"),  
            address_show: $("#block_address").find(".address-detail-show"),   
        };

        function getAddressFull(){
            let arrayText = [
                __el.address_detail.val(),
                __el.ward.find('option:selected').text().trim(),
                __el.district.find('option:selected').text().trim(),
                __el.province.find('option:selected').text().trim() 
            ];
            if(arrayText[0].lengh!=='' && arrayText[1].lengh!=='' && arrayText[2].lengh!=='' && arrayText[2].lengh!==''){
                __el.address_show_container.show();
                __el.address_show.text(arrayText.join(', '));
            }else{
                __el.address_show_container.hide();
            }
        }

        __el.address_detail.keyup((e)=>{
            getAddressFull();
        });

        __el.province.change(function(){
            __el.district.empty();
            __el.ward.empty();

            $.transferData({
                url: __helper.url.urlPattern(__routeApi.location.showProvince, {
                        id : parseInt($(this).val())
                    }),
                method: 'GET',
                success:function(res){
                     __el.district.append(`<option value=''>Quận/Huyện</option>`);
                    $.each(res.data.districts, function(key, value) {
                        __el.district.append(`<option value='${value.id}'>${value.name}</option>`);
                    });
                    getAddressFull();
                }
            });

        });

        __el.district.change(function(){
            __el.ward.empty();
            $.transferData({
                url: __helper.url.urlPattern(__routeApi.location.showDistrict, {
                        id : parseInt($(this).val())
                    }),
                method: 'GET',
                success:function(res){
                    __el.ward.append(`<option value=''>Phường/Xã</option>`);
                    $.each(res.data.wards, function(key, value) {
                        __el.ward.append(`<option value='${value.id}'>${value.name}</option>`);
                    });
                    getAddressFull();
                }
            });
        });

        __el.ward.change(function(){
            getAddressFull();
        });
    });
</script> 

                        </div>
                       
                        <div class="col-12 mt-2 text-center" style="display: none">
                            <div style="border: 1px solid #ccc; border-radius: 5px; padding: 10px">
                                <i data-feather="map-pin"></i>
                                <input type="hidden" required value="10.7829132" class="form-control" name="address_component[position][latitude]" id="address_component[position][latitude]">
                                <input type="hidden" required value="106.6961898" class="form-control" name="address_component[position][longitude]" id="address_component[position][longitude]">
                                <div class="invalid-feedback">
                                    Vui lòng thêm vị trí nhà trọ
                                </div>
                                <b>Vị trí nhà trọ</b>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="title-item-small">
                                <b>Thông tin cơ bản:</b>
                                <i class="des not-edit">Thông tin diện tích, giá thuê, số lượng thành viên</i>
                                <i class="des note" style="color:red; display: none"> <b>*Các thông tin dưới đây chỉ áp dụng cho lúc tạo nhà trọ tự động và khởi tạo đăng tin cho thuê</b></i>
                            </div>
                        </div>

                        <div class="col-6 hide-when-not-room">
                            <div class="form-floating">
                                <input data-format="numeric" type="text" class="form-control" name="area" id="area" value="15" required placeholder="Nhập diện tích">
                                <label for="area">Diện tích (m2)</label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập diện tích
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating">
                                <input data-format="numeric" type="text" class="form-control" name="room_amount" id="room_amount" placeholder="Giá thuê" required>
                                <label for="room_amount">Giá thuê trung bình (đ)</label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập giá thuê
                                </div>
                            </div>
                        </div>

                        <div class="col-12 hide-when-not-room">
                            <div class="form-floating">
                                <select data-format="numeric" id="max_member" name="max_member" class="form-select form-control">
                                                                                                                        <option value="1">1 người ở</option>
                                                                                    <option value="2">2 người ở</option>
                                                                                    <option value="3">3 người ở</option>
                                                                                    <option value="4">4 người ở</option>
                                                                                    <option value="5">5-6 người ở</option>
                                                                                    <option value="6">7-10 người ở</option>
                                                                                    <option value="0">Không giới hạn</option>
                                                                                                            </select>
                                <label for="max_member">Tối đa người ở / <span class="room_type_name">phòng</span></label>
                            </div>
                        </div>

                        <div class="col-12 hide-when-edit">
                            <div class="title-item-small">
                                <b>Cài đặt dịch vụ:</b>
                                <i class="des">Thiết lập các dịch vụ khi khách thuê sử dụng khi thuê</i>
                            </div>
                        </div>

                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-floating">
                                <select data-format="numeric" id="setting[price_item_ele]" name="setting[price_item_ele]" class="form-select form-control">
                                    <option value="0">Miễn phí/Không sử dụng</option>
                                    <option value="1">Tính theo người</option>
                                    <option value="2">Tính theo tháng</option>
                                    <option value="3" selected>Tính theo đồng hồ (phổ biến)</option>
                                </select>
                                <label for="setting[price_item_ele]">Dịch vụ điện</label>
                            </div>
                        </div>
                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-floating">
                                <select data-format="numeric" id="setting[price_item_water]" name="setting[price_item_water]" class="form-select form-control">
                                    <option value="0">Miễn phí/Không sử dụng</option>
                                    <option value="1">Tính theo người</option>
                                    <option value="2">Tính theo tháng</option>
                                    <option value="3" selected>Tính theo đồng hồ (phổ biến)</option>
                                </select>
                                <label for="setting[price_item_water]">Dịch vụ nước</label>
                            </div>
                        </div>
                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-floating">
                                <select data-format="numeric" id="setting[price_item_trash]" name="setting[price_item_trash]" class="form-select form-control">
                                    <option value="0">Miễn phí/Không sử dụng</option>
                                    <option value="1">Tính theo người</option>
                                    <option value="2">Tính theo tháng</option>
                                </select>
                                <label for="setting[price_item_trash]">Dịch vụ rác</label>
                            </div>
                        </div>

                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-floating">
                                <select data-format="numeric" id="setting[price_item_wifi]" name="setting[price_item_wifi]" class="form-select form-control">
                                    <option value="0">Miễn phí/Không sử dụng</option>
                                    <option value="1">Tính theo người</option>
                                    <option value="2">Tính theo tháng</option>
                                </select>
                                <label for="setting[price_item_wifi]">Dịch vụ wifi/internet</label>
                            </div>
                        </div>

                        <div class="col-12 hide-when-edit">
                            <div class="title-item-small">
                                <b>Cài đặt tính năng:</b>
                                <i class="des">Thiết lập các tính năng cho nhà trọ</i>
                            </div>
                        </div>

                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" value="1" id="setting[asset_function]" name="setting[asset_function]"
                                       checked>
                                <label class="form-check-label" for="setting[asset_function]">
                                    <b>Quản lý tài sản</b>
                                    <p>Quản lý tài sản khách thuê sử dụng</p>
                                </label>
                            </div>
                        </div>

                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" value="1" id="setting[car_function]" name="setting[car_function]" checked>
                                <label class="form-check-label" for="setting[car_function]">
                                    <b>Quản lý xe</b>
                                    <p>Các thông tin xe của khách thuê</p>
                                </label>
                            </div>
                        </div>

                        <div class="col-6 mt-2">
                            <div class="form-check form-switch">
                                <input data-format="numeric" class="form-check-input" type="checkbox" value="1" id="setting[agent_function]" name="setting[agent_function]" checked>
                                <label class="form-check-label" for="setting[agent_function]">
                                    <b>Quản lý mô giới</b>
                                    <p>Các thông tin về mô giới</p>
                                </label>
                            </div>
                        </div>
                
                        <div class="col-6 mt-2">
                            <div class="form-check form-switch">
                                <input data-format="numeric" class="form-check-input" type="checkbox" value="1" id="setting[post_function]" name="setting[post_function]" checked>
                                <label class="form-check-label" for="setting[post_function]">
                                    <b>Quản lý tin đăng</b>
                                    <p>Các thông tin về tin đăng</p>
                                </label>
                            </div>
                        </div>

                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" value="1" id="setting[send_sms_when_create_bill]" name="setting[send_sms_when_create_bill]"
                                    checked>
                                <label class="form-check-label" for="setting[send_sms_when_create_bill]">
                                    <b>Gửi tin nhắn tự động cho khách thuê</b>
                                    <p>Giửi tin nhắn SMS tự động cho khách thuê sau khi lập phiếu</p>
                                </label>
                            </div>

                        </div>

                        <div class="col-12">
                            <div class="title-item-small">
                                <b>Cài đặt cho phiếu thu (hóa đơn):</b>
                                <i class="des">Thiết lập cho hóa đơn khi bạn lập hóa đơn tiền thuê cho khách
                                    thuê</i>
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="form-floating">
                                <input data-format="numeric" type="text" class="form-control" id="circle_order" name="circle_order" placeholder="Ngày lập hóa đơn"  min="1" max="31" required>
                                <label for="circle_order">Ngày lập hóa đơn và trong khoảng 1 đến 31</label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập ngày lập hóa đơn
                                </div>
                            </div>
                            <div class="loz-alert info mt-2 mb-2">
                                <div class="icon flex-0">
                                    <i data-feather="info" size="20"> </i>
                                </div>
                                <div class="des flex-1">
                                    <b>Thông tin:</b> Khi đến ngày lập hóa đơn hệ thống sẽ nhắc nhở qua
                                    thông báo
                                </div>
                            </div>
                            <p>
                                - Là ngày lập hóa đơn tiền điện, nước...<br>
                                - Nhập một ngày trong tháng. Nếu không nhập mặc định là cuối tháng.
                            </p>
                        </div>

                        <div class="col-6">
                            <div class="form-floating">
                                <input data-format="numeric" type="text" class="form-control" id="deadline_bill" name="deadline_bill"
                                    placeholder="Ngày lập hóa đơn" min="1" max="20" required>
                                <label for="deadline_bill">Hạn đóng tiền</label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập hạn đóng tiền và trong khoảng 1 đến 20 ngày
                                </div>
                            </div>
                            <div class="loz-alert info mt-2 mb-2">
                                <div class="icon flex-0">
                                    <i data-feather="info" size="20"> </i>
                                </div>
                                <div class="des flex-1">
                                    <b>Thông tin:</b> Khi khách đóng tiền không đúng thời hạn hệ thống sẽ nhắc nhở
                                </div>
                            </div>
                            <p>
                                <b>Ví dụ:</b> Bạn lập phiếu ngày 01 và hạn đóng tiền thuê trọ ở đây là 5 ngày thì ngày 05
                                sẽ là ngày hết hạn
                            </p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="submit-block" class="btn btn-primary">
                    <i data-feather="plus"> </i>
                    Thêm nhà trọ
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function(){
        var __el = {
            form    : $('#add-block-form'),
            modal   : $("#addBlock"),
            submit  : $('#submit-block'),
            province: $("#province"),
            district: $("#district"),
            ward    : $("#ward"),

        };

        let dataBlock =  null;

        const excelFile = (file)=> {
            try {
                var reader = new FileReader();
                reader.readAsBinaryString(file);
                reader.onload = function(e) {
            
                    var data = e.target.result;

                    var workbook = XLSX.read(data, {
                        type : 'binary',
                        UTC  : false
                    });

                    if(workbook.SheetNames && workbook.SheetNames.length!==0){
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                        if (jsonData.length !== 0) {
                            let header = jsonData[0];
                            let data = [];
                            jsonData.forEach((row, rowIndex) => {
                                if(row.length!==0 && rowIndex !== 0){
                                    data[rowIndex] = []
                                    row.forEach((value, colIndex) => {
                                        let header = jsonData[0][colIndex];
                                        data[rowIndex].push({
                                            colIndex: colIndex,
                                            name: header,
                                            value: value
                                        });
                                    })
                                }
                            
                            })

                            $.transferData({
                                method: "POST",
                                url: __helper.url.urlPattern(__routeApi.checkDataFromFile),
                                data : {
                                    data_excel: data
                                },
                                success: (res) => {
                                    __el.form.find('#count_floor').val(res.data.count_floor).change();
                                    Swal.fire({
                                        title: 'Thành công!',
                                        text: res.message,
                                        icon: 'success',
                                        confirmButtonColor: '#3c9e47',
                                        confirmButtonText: 'Đóng'
                                    });
                                },
                                fail: (res) => {
                                    Swal.fire({
                                        title: 'Dữ liệu không chính xác',
                                        html: res.message,
                                        icon: 'error',
                                        confirmButtonText: 'Đã hiểu'
                                    });

                                    $('#file-excel').val('');
                                    $('#text-import').text('Chưa có tệp nào được chọn');
                                }
                            });
                        }
                    }
                }
            }catch(e){
                console.error(e);
            }
        }

        const changeRoomType = (room_type)=>{
            if(room_type ==='room'){
                __el.form.find('input[name="room_total"]').attr('placeholder', 'Nhập số phòng');
                __el.form.find('.room_type_name').text('phòng');
                __el.form.find('.hide-when-not-room').show();

            }else{
                __el.form.find('input[name="room_total"]').attr('placeholder', 'Nhập số giường');
                __el.form.find('.room_type_name').text('giường');
                __el.form.find('.hide-when-not-room').hide();
            }
        };

        __el.form.find("#import-excel-trigger").on("click", function() {
            __el.form.find("#file-excel").click();
        });
        
        __el.modal.find("#province").change(function(){
            __el.modal.find("#district").empty();
            __el.modal.find("#ward").empty();

            $.transferData({
                url: __helper.url.urlPattern(__routeApi.location.showProvince, {
                        id : parseInt($(this).val())
                    }),
                method: 'GET',
                loadingEle:false,
                success:function(res){
                    __el.modal.find("#district").append(`<option value=''>Chọn Quận/Huyện</option>`);
                    $.each(res.data.districts, function(key, value) {
                        __el.modal.find("#district").append(`<option value='${value.id}'>${value.name}</option>`);
                    });
                }
            });

        });

        __el.modal.find("#district").change(function(){
            __el.modal.find("#ward").empty();
            $.transferData({
                url: __helper.url.urlPattern(__routeApi.location.showDistrict, {
                        id : parseInt($(this).val())
                    }),
                method: 'GET',
                loadingEle:false,
                success:function(res){
                    __el.modal.find("#ward").append(`<option value=''>Chọn Phường/Xã</option>`);
                    $.each(res.data.wards, function(key, value) {
                        __el.modal.find("#ward").append(`<option value='${value.id}'>${value.name}</option>`);
                    });
                }
            });
        });


        __el.form.on("change","#file-excel", function(e) {
            var file = e.target.files[0];
            if (file) {
                __el.form.find("#text-import").text(file.name)
                excelFile(file);
            } else {
                alert("Vui lòng chọn file excel để tiếp tục!");
            }
        });

        __el.form.on('change', 'input[name="room_type"]', function (e) {
            changeRoomType($(this).val())
        });

        __el.form.on('change', 'select[name="category"]', function (e) {
            if($(this).val() == 1)
                __el.form.find('#room_type_bed').prop('checked', true).change();
            else
                __el.form.find('#room_type_room').prop('checked', true).change();
                
        });

        __el.form.on('change', 'input[name="auto_create_room"]', function (e) {
            if (__el.form.find("#disable").is(':checked')) {
                __el.form.find("#file-excel").removeAttr('required'); 
                __el.form.find("#room_total").removeAttr('required');

                __el.form.find("#room_total").attr("disabled", true);
                __el.form.find("#room_total").val(0);

                __el.form.find('.total-room').removeClass("d-none");
                __el.form.find('.count_floor').removeClass("d-none");   
                __el.form.find('.import-from-excel-layout').addClass("d-none");  
                __el.form.find(".info-auto-create-room-enable").addClass("d-none");
                __el.form.find(".info-auto-create-room-disable").removeClass("d-none");
                __el.form.find('.total-room').addClass("d-none");
                __el.form.find('.count_floor').addClass("d-none");  

                __el.form.find('#file-excel').val('');
                __el.form.find('#text-import').text('File Excel cần nhập dữ liệu');

            } else if (__el.form.find("#enable").is(':checked')) {
                __el.form.find("#room_total").attr('required', 'required');
                __el.form.find("#file-excel").removeAttr('required');   

                __el.form.find("#room_total").removeAttr("disabled");
                __el.form.find("#room_total").val('');

                __el.form.find('.total-room').removeClass("d-none");
                __el.form.find('.count_floor').removeClass("d-none");   
                __el.form.find(".info-auto-create-room-enable").removeClass("d-none");
                __el.form.find(".info-auto-create-room-disable").addClass("d-none");

                __el.form.find('.import-from-excel-layout').addClass("d-none"); 

                __el.form.find('#file-excel').val('');
                __el.form.find('#text-import').text('File Excel cần nhập dữ liệu');

            } else if (__el.form.find("#excel").is(':checked')) {
                __el.form.find('.total-room').addClass("d-none");
                __el.form.find('.count_floor').addClass("d-none");    
                __el.form.find(".info-auto-create-room-enable").addClass("d-none");
                __el.form.find('.import-from-excel-layout').removeClass("d-none");     
                __el.form.find(".info-auto-create-room-disable").addClass("d-none");
                __el.form.find("#room_total").removeAttr('required');  
                 
                __el.form.find("#file-excel").attr('required', 'required');    
            }
        });

        __el.form.on('change', '#room_total', function (e) {
            if(parseInt($(this).val()) === 0){
                __el.form.find('#auto_create_room').prop('checked', false);
                __el.form.find("#auto_create_room").attr("disabled", true);
            }else{
                __el.form.find('#auto_create_room').prop('checked', true);
                __el.form.find("#auto_create_room").removeAttr("disabled");
            }
        });

        
        new __modalForm(
            __el.modal.get(0),
            __el.form.get(0),
            __el.submit.get(0)
        ).start(null, {
            __openModalForm: function () {
                __el.form.get(0).reset();
                dataBlock = __el.modal.data('block');
                __el.modal.find('.title-disable').remove();
                __el.modal.find('input[name="count_floor"]').remove();
                __el.modal.find("#province").empty();
                __el.modal.find("#district").empty();
                __el.modal.find("#ward").empty();
                if(dataBlock){
                    __el.modal.find('.count_floor').before(`
                    <div class="col-12 title-disable">
                        <div class="title-item-small">
                            <b>Thông tin không thể chỉnh sửa:</b>
                            <i class="des">Các thông tin dưới đây không thể được chỉnh sửa</i>
                        </div>
                    </div>`);
                    __el.modal.find('.not-edit').hide();
                    __el.modal.find('.note').show();
                    __el.modal.find('#count_floor').attr("disabled", true);
                    __el.modal.find('#count_floor').after(`<input type="hidden" data-format="numeric" class="form-control" name="count_floor" placeholder="Số phòng/giường" value="${dataBlock.count_floor}">`);
                    __el.modal.find('#room_total').attr("readonly", true);
                    __el.modal.find('.hide-when-edit').addClass("d-none");
                    
                    $.transferData({
                        method: "POST",
                        url: __helper.url.urlPattern(__routeApi.location.init),
                        data: {
                            'province_id': dataBlock.province_id,
                            'district_id': dataBlock.district_id,
                            'ward_id': dataBlock.ward_id,
                        },
                        loadingEle:false,
                        success: (res) => {
                            $.each(res.data.provinces, function(key, province) {
                                __el.modal.find(".province").append(`<option value='${province.id}'>${province.short_name}</option>`);
                                if(parseInt(province.id) === parseInt(dataBlock.province_id))
                                    $(`.province option[value=${province.id}]`).prop('selected', true);
                            });

                            $.each(res.data.districts, function(key, district) {
                                __el.modal.find(".district").append(`<option value='${district.id}'>${district.name}</option>`);
                                if(parseInt(district.id) === parseInt(dataBlock.district_id))
                                    $(`.district option[value=${district.id}]`).prop('selected', true);
                            });

                            $.each(res.data.wards, function(key, ward) {
                                __el.modal.find(".ward").append(`<option value='${ward.id}'>${ward.name}</option>`);
                                if(parseInt(ward.id) === parseInt(dataBlock.ward_id))
                                    $(`.ward option[value=${ward.id}]`).prop('selected', true);
                            });
                        },
                    });

                    __el.modal.find('.modal-title').text(`Chỉnh sửa ${dataBlock.category_name} ${dataBlock.name}`);
                    __el.modal.find('.modal-footer .btn-primary').text(`Chỉnh sửa ${dataBlock.category_name}`);
                    __el.form.setObjectToForm(dataBlock);
                    changeRoomType(dataBlock.room_type);
                }else{
                    __el.modal.find('.not-edit').show();
                    __el.modal.find('.note').hide();
                    __el.modal.find('input[name="count_floor"]').remove();
                    __el.modal.find('.title-disable').remove();
                    __el.modal.find('#count_floor').attr("disabled", false);
                    __el.modal.find('#room_total').attr("readonly", false);
                    __el.form.find('input[name="room_type"]').val(['room']);
                    __el.modal.find('.hide-when-edit').removeClass("d-none");
                    changeRoomType('room');

                    __el.modal.find(".district").empty();
                    __el.modal.find(".ward").empty();
                    if(!__el.modal.find(".province option[value='79']").length){
                        $.transferData({
                            method: "GET",
                            url: __helper.url.urlPattern(__routeApi.location.provinces),
                            loadingEle:false,
                            success: (res) => {
                                __el.modal.find(".province").empty();
                                __el.modal.find(".province").append(`<option value=''>Chọn Tỉnh/Thành phố</option>`);
                                $.each(res.data, function(key, value) {
                                    __el.modal.find(".province").append(`<option value='${value.id}'>${value.short_name}</option>`);
                                });
                            },
                        });
                    }
                }
            },
            __closeModalForm: function () {
                __el.form.get(0).reset();
                __el.form.get(0).classList.remove('was-validated');

                __el.modal.data('block', null);

                __el.modal.find('.modal-title').text("Thêm nhà trọ");
                __el.modal.find('.modal-footer .btn-primary').text("Thêm nhà trọ");
                __el.modal.find('input[name="auto_create_room"][value="1"]').prop('checked', true).change();
            },
            __submitModalForm: function(e){
                let data = __el.form.getObjectOfForm();
                if (!__el.form.get(0).checkValidity()) {
                    __el.form.get(0).classList.add('was-validated');
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Vui lòng nhập đầy đủ thông tin trước khi thực hiện",
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                if(parseInt(__el.form.find('input[name="auto_create_room"]:checked').val()) === 2){}
                    data.file = $("#file-excel")[0].files[0]
     
                data.address_component['address'] = ([
                    __el.modal.find(".address_detail").val(),
                    __el.modal.find(".ward option:selected").val() ? __el.modal.find(".ward option:selected").text() : '',
                    __el.modal.find(".district option:selected").val() ? __el.modal.find(".district option:selected").text() : '',
                    __el.modal.find(".province option:selected").val() ? __el.modal.find(".province option:selected").text() : '',
                ]).join(', ');

                let url  = !dataBlock ? __helper.url.urlPattern(__routeApi.block.create) : __helper.url.urlPattern(__routeApi.block.update, {
                    block_id : parseInt(dataBlock.id)
                });
  
                $.transferForm({
                    method: "POST",
                    url,
                    data ,
                    success: function(res) {
                        Swal.fire({
                            title: 'Thành công!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đóng'
                        }).then((result) => {
                            window.location.href = "/quan-ly";
                        });
                    },
                    fail:(res)=>{
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            },
        });
    });
</script>
    </div>
    <div class="text-center mt-5"><span style="color: #727272; font-style: italic;">Copyright @ <strong style="color: #000">HPT-NTMT</strong> 2020</span></div>
<div class="text-center"><p style="color: #727272; font-style: italic;">Version <strong style="color: #000">1.3.8</strong></p></div>
<div class="zalo-container fix item-contact">
    <a id="zalo-btn"
       href="https://zalo.me/0965227453"
       target="_blank" rel="noopener">
        <div class="animated_zalo infinite zoomIn_zalo cmoz-alo-circle"></div>
        <div class="animated_zalo infinite pulse_zalo cmoz-alo-circle-fill"></div>
        <span>
            <img width="100%"
                   src="https://quanlytro.me/images/icons/zalo-icon-white.webp"
                   alt="Liên hệ với LOZIDO - Quản lý nhà cho thuê qua Zalo">
        </span>
    </a>
</div>

<script>
    feather.replace();

    $(document).ready(function () {
        $(document).find('input[data-format="numeric"][type="text"]').map((key, element) => {
            element.addEventListener('keyup', e => {
                let value = $(element).val();
                let number = __helper.convertStringToNumber(value);
                let newVal = __format.currencyInput(number);
                
                $(element).val(value ==='' ? '': isNaN(number) ? '': newVal);
            });
        });

        $(document).find('input[data-format="stringNumber"]').map((key, element) => {
            element.addEventListener('keyup', e => {
                $(element).val(__format.phone($(element).val()));
            });
        });

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        setTimeout(() => {
                $.transferData({
                    url: __helper.url.urlPattern(__routeApi.notification.all,{
                        page: 1
                    }),
                    loadingEle:false,
                    success: (res) => {
                        $('.count-notification').text(res?.data?.unread_count ?? 0);
                        res?.data?.notifications?.length > 0 &&
                        $(".notication-dropdown").html('') &&
                        res.data.notifications.map((notification)=>{
                            $(".notication-dropdown").append($(`
                                <li style="cursor: pointer" class="item-notication d-flex align-items-center">
                                        <div class="icon ${!notification?.read_at ? 'not-read':''}">
                                            <i data-feather="bell" size="20"></i>
                                        </div>
                                        <div class="content">
                                            <div class="des">
                                                <b>
                                                    ${notification?.data?.title ?? ''}
                                                </b>
                                                <p>${notification?.data?.body ?? ''}</p>
                                            </div>
                                            <div class="time">${notification?.created_at ?? ''}</div>
                                        </div>
                                </li>
                            `).click((e)=>{
                                Swal.fire({
                                    title: 'Thông báo!',
                                    text: "Tính năng đi đến thông báo đang phát triển. Hệ thống sẽ hoàn thành sớm!",
                                    icon: 'warning',
                                    confirmButtonText: 'Đã hiểu'
                                });
                            }));
                        });
                        feather.replace();
                    },
                    fail:(res)=>{

                    }
            });
        }, 5000);
       
    });
</script>
</body>
</html>
