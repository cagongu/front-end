<!DOCTYPE html>
<html lang="vi" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

<head>
    <meta charset="utf-8">
    <meta name="geo.region" content="vi">
    <meta name="language" content="vi">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>LOZIDO - Tất cả hợp đồng</title>
    <meta name="keywords" content="Phần mềm nhà trọ, phần mềm phòng trọ, phần mềm quản lý nhà trọ, phần mềm quản lý nhà trọ, quản lý nhà trọ, quản lý trọ, quản lý phòng trọ">
    <meta name="description" content="Phần mềm quản lý nhà  trọ trên điện thoại, máy tính, máy tính bảng, iPad hỗ trợ chủ nhà quản lý nhà trọ, phòng trọ, ký túc xá dễ dàng và tiện lợi mọi lúc mọi nơi, tiết kiệm thời gian và công sức">

    <meta name="robots" content="noindex, nofollow" />
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="csrf-token" content="CZqXP04OzKEuLEt01gkxMY2DrN3sCqnCK8eSZ2o4">

    <meta name="author" content="LOZIDO - Quản lý nhà cho thuê">
    <meta name="copyright" content="LOZIDO - Quản lý nhà cho thuê - Platform Quan ly nha tro, phong tro">
    <meta name="abstract" content="Phần mềm quản lý nhà trọ, phòng trọ, ký túc xá, chung cư tốt nhất hiện nay">

    <meta property="og:image" content="https://quanlytro.me/householder-admin/images/lozido_facebook-recovered.jpg">
    <meta property="og:image:secure_url" content="https://quanlytro.me/householder-admin/images/lozido_facebook-recovered.jpg">
    <meta property="og:image:width" content="800">
    <meta property="og:image:height" content="370">
    <meta property="og:image:type" content="image/webp">

    <link rel="shortcut icon" href="https://quanlytro.me/images/favicon.ico" type="image/x-icon">
    <link rel="alternate" href="https://quanlytro.me/quan-ly/7081/tat-ca-hop-dong" hreflang="vi-vn" />

    <script type="text/javascript">
        var recaptcha_site_key = '6Ld0LAYeAAAAABA67PAls5DpnkfNJ-rkgHbsSilR';
        var __environment = 'production';
    </script>

    <script src="https://quanlytro.me/plugins/jquery-3.6.0/jquery.min.js"></script>
    <script src="https://quanlytro.me/plugins/jquery-3.6.0/jquery-ui-1.8.13.min.js"></script>
    <script src="https://quanlytro.me/plugins/feather.min.js"></script>
    <!-- <script src="https://quanlytro.me/plugins/sweetalert2@11"></script>
    <script src="https://quanlytro.me/bootstrap-5.0/js/popper.min.js"></script> -->
    <script src="https://quanlytro.me/bootstrap-5.0/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/helper.js?version=1.3.8"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/format.js?version=1.3.8"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/route-api.js?version=1.3.8"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/index.js?version=1.3.8"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/transporter.js?version=1.3.8"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/upload-image.js?version=1.3.8"></script>
    <style>
        .modal.show .btn-close {
            outline: 0;
            box-shadow: 0 0 0 .25rem rgb(255 87 34 / 9%);
            opacity: 1;
            border-radius: 100%;
            padding: 10px;
        }
        .btn{
            font-size: 14px!important;
            font-weight: 600!important;
        }
    </style>
    <script type="text/javascript">
        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        var __current_block = JSON.parse(JSON.stringify({"id":7081,"name":"ASUS","name_full":"Nh\u00e0 tr\u1ecd ASUS","user_id":8151,"category":0,"category_name":"Nh\u00e0 tr\u1ecd","category_name_short":"Nh\u00e0 tr\u1ecd","room_type":"room","room_type_name":"ph\u00f2ng","type":"floors","room_total":6,"count_floor":2,"area":15,"room_amount":36,"ele_amount":0,"water_amount":0,"price_items_cache":[{"id":23351,"name":"Ti\u1ec1n \u0111i\u1ec7n","type":"constant","unit":"kwh","price":1700,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"ele","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"KWh","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1},{"id":23352,"name":"Ti\u1ec1n n\u01b0\u1edbc","type":"constant","unit":"khoi","price":18000,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"water","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"Kh\u1ed1i","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1}],"circle_order":6,"deadline_bill":10,"bill_setting":{"note":{"content":null},"enable_qr":1,"payment_default":"cash","show_circle_day":0,"single_send_zalo":0,"template_bill_zalo":1,"enable_rounding_money":1,"extract_receipt_expense":0},"app_renter_setting":{"allow_update_car":1,"default_password":123456789,"allow_close_clock":0,"auto_create_account":0,"allow_ticket_contract":1,"allow_update_customer":1},"room_group":[{"id":1,"name":"T\u1ea7ng tr\u1ec7t","index":0,"label":"T\u1ea7ng tr\u1ec7t","value":1},{"id":2,"name":"T\u1ea7ng 1","index":1,"label":"T\u1ea7ng 1","value":2}],"max_member":1,"open_door":null,"close_door":null,"rule":null,"extension":null,"data_log":{"menu_label":{"pay_bill":0,"room_list":"0\/6","new_session":6,"deposit_request":6,"terminate_contract":0}},"setting":{"car_function":1,"post_function":1,"agent_function":1,"asset_function":1,"price_item_ele":3,"price_item_wifi":0,"price_item_trash":0,"price_item_water":3,"task_job_function":1,"send_sms_when_create_bill":1,"contract_document_function":0},"province_id":72,"district_id":712,"ward_id":25732,"address_component":{"address":"63, An T\u1ecbnh, Tr\u1ea3ng B\u00e0ng, T\u00e2y Ninh","ward_id":"25732","position":{"latitude":"10.7829132","longitude":"106.6961898"},"district_id":"712","province_id":"72","address_detail":"63"},"address":"63, An T\u1ecbnh, Tr\u1ea3ng B\u00e0ng, T\u00e2y Ninh","latitude":10.7829132,"longitude":106.6961898,"auto_create_room":1,"post_ids":[]}));

        var __permission_block = JSON.parse(JSON.stringify(null));

        let user = JSON.parse(JSON.stringify({"staff":false,"free":false,"trial":true,"fee":false}));
       
    </script>
    <link href="/bootstrap-5.0/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
                        <link href="/householder-admin/css/common.cssversion=1.3.8.css"
                rel="stylesheet">
                    <link href="/householder-admin/css/block.cssversion=1.3.8.css"
                rel="stylesheet">
            </head>

<body>
    <div id="app_loading" class="text-center" style="padding:40vh 10px">
        <div class="inner-loading">
            <img style="margin: auto" src="/images/icons/loading.gif" alt="Đang tải..." width="50px"/>
            <i class="loading_text" style="font-size: 13px; margin-top: -10px;">Đang tải dữ liệu...</i>
        </div>
    </div>
    <header>
    <div class="header-inner">
                <div class="header-sticky">
            <nav class="navbar navbar-expand-lg navbar-light">
                <div class="container-fluid">
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                            data-bs-target="#lozido-main-menu" aria-controls="lozido-main-menu" aria-expanded="false"
                            aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"> </span>
                    </button>
                    <nav class="collapse navbar-collapse lozido-main-menu">
                        <ul class="navbar-nav main-menu-left  me-auto mb-2 mb-lg-0">
                            <li class="nav-item menu-item active">
                                <a href="/" class="nav-link ">
                                    <i data-feather="arrow-left"></i>
                                                                            <img width="180px" src="/images/logo-lozido-quan-ly-tro-white.png"/>
                                                                    </a>
                            </li>
                        </ul>

                        <ul class="topbar-items main-menu-right navbar-nav">
                                                                                                <li class="nav-item menu-item active">
                                        <a href="/quan-ly.html" class="nav-link ">
                                            <i data-feather="home"></i>
                                            <span style="margin-top: 5px" class="text">Quản lý nhà</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/bao-cao.html" class="nav-link ">
                                            <i data-feather="pie-chart"></i>
                                            <span style="margin-top: 5px" class="text">Tổng báo cáo</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/dang-tin.html" class="nav-link ">
                                            <i data-feather="plus"></i>
                                            <span style="margin-top: 5px" class="text">Đăng tin</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/moi-gioi.html" class="nav-link ">
                                            <i data-feather="users"></i>
                                            <span style="margin-top: 5px" class="text">Môi giới</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/phan-quyen.html" class="nav-link ">
                                            <i data-feather="box"></i>
                                            <span style="margin-top: 5px" class="text">Công ty/nhóm</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/cai-dat.html" class="nav-link ">
                                            <i data-feather="settings"></i>
                                            <span style="margin-top: 5px" class="text">Cài đặt chung</span>
                                        </a>
                                    </li>
                                                                                                                                                                                                                                                                                            <li class="nav-item btn-group menu-item ">
                                        <a href="javascript:;" class="nav-link" data-bs-toggle="dropdown" aria-expanded="false">
                                            <span class="count-notification badge">0</span>
                                            <i data-feather="bell"></i>
                                            <span style="margin-top: 5px" class="text">Thông báo</span>
                                        </a>
                                        <ul class="dropdown-menu notication-dropdown dropdown-menu-lg-end">
                                            <div class="text-center" style="padding: 20px">
                                                <img style="margin: auto" src="/images/icons/loading.gif" alt="Đang tải..." width="50px"/>
                                                <div>
                                                    <i class="loading_text" style="font-size: 13px; margin-top: -10px;">Đang tải thông báo...</i>
                                                </div>
                                            </div>
                                        </ul>
                                    </li>

                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/tai-khoan.html" class="nav-link ">
                                            <i data-feather="user"></i>
                                            <span style="margin-top: 5px" class="text">Tài khoản</span>
                                        </a>
                                    </li>
                                                                                                                                                                <li class="nav-item menu-item ">
                                        <a href="/dang-xuat" class="nav-link ">
                                            <i data-feather="log-out"></i>
                                            <span style="margin-top: 5px" class="text">Đăng xuất</span>
                                        </a>
                                    </li>
                                                                                                                    </ul>
                    </nav>
                </div>
            </nav>
        </div>
    </div>
</header>
    <div>
                    <div>
                <style type="text/css">
    .scrollable-content {
        overflow-x: auto;
        white-space: nowrap;
        flex: 1;
        position: relative;
        scroll-behavior: smooth; /* Thêm hiệu ứng cuộn mượt */
    }
    .scrollable-content-container button {
        color: #fff;
        border: none;
        cursor: pointer;
        transition: opacity 0.3s ease;
        position: absolute;
        top: 50%;
        height: 96%;
        width: 50px;
        transform: translateY(-50%);
        z-index: 1;
    }
    .scrollable-content-container button::before{
        content: "";
        position: absolute;
        top: 50%;
        left: 10px;
        transform: translateY(-50%);
        width: 30px;
        height: 30px;
        border-radius: 100%;
        background: #000;
        z-index: -1;
    }
    .scrollable-content-container button:hover::before {
        background-color: #2f8932;
    }

    .scrollable-content-container button.hidden {
        opacity: 0;
        pointer-events: none; /* Ngăn chặn sự kiện chuột khi ẩn */
    }

    .scrollable-content-container .scroll-left{
        left: 0px;
        flex: 0 0 auto;
        background: linear-gradient(to right, rgb(255 255 255), rgb(255 255 255 / 0%));
    }
    .scrollable-content-container .scroll-right {
        right: 0px;
        flex: 0 0 auto;
        background: linear-gradient(to left, rgb(255 255 255), rgb(255 255 255 / 0%));
    }
</style>

<div style="min-height: 125px;display: flex;padding: 0px 10px 0px 0px;">
    <div class="col-md-2 d-flex align-items-center justify-content-center" style="margin-right: 10px;">
        <div class="current-block d-flex align-items-center" style="position: relative" data-bs-toggle="modal" data-bs-target="#manageBlock">
            <div class="d-flex align-items-center" style="flex-direction: row; flex:1">
                <div class="icon-blocks">
                    <span class="count-block">1</span>
                    <i data-feather="home" class="feather-size-18"> </i>
                </div>

                <div style="padding: 20px 0px 20px 5px; flex:1">
                    <span style="font-size: 12px;">Đang quản lý</span>
                    <h4 style="font-size: 14px; color: #15a05c; padding:0px; margin:0px; white-space: nowrap;max-width: 150px; overflow: hidden; text-overflow: ellipsis; ">
                        <span>Nhà trọ ASUS</span>
                    </h4>
                </div>
            </div>
                            <button class="shadow" id="add-block"
                        style="position: absolute;
                        right: -14px;
                        top: 29px;
                        border-radius: 100%;
                        height: 35px;
                        width: 35px;
                        text-align: center;
                        padding: 0px;
                        background-color: #7dc343;
                        color: #fff;
                        border: 1px solid #7dc443;
                        z-index: 10;"
                        data-bs-toggle="modal" data-bs-target="#addBlock">
                    <span data-bs-toggle="tooltip" data-bs-placement="top" title="Thêm mới nhà cho thuê">
                        <i data-feather="plus"> </i>
                    </span>
                </button>
                    </div>
    </div>
    <div class="col-md-10" style="align-items: center; justify-content: space-between; display: flex;">
        <div class=" scrollable-content-container" style="position: relative; align-items: center; justify-content: space-between; display: flex;overflow: hidden;">
            <button class="scroll-left">←</button>
            <div style="display: flex; flex-wrap: nowrap; overflow-x: auto; position: relative;" class="scrollable-content">    
                                                                                        <a href="/quan-ly.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/thu_tien.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý phòng</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/lap-phieu-thu.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/thu_tien.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý hóa đơn</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/quan-ly-dich-vu.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/ghi_chu.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý dịch vụ</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/quan-ly-tai-san.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/ghi_chu.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý tài sản</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/tat-ca-hop-dong.html" class="item-menu active">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/report_customer_use.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý hợp đồng</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/tat-ca-khach-thue.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/danh_sach_lien_he.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Quản lý khách thuê</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/thu-chi-tong-ket.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/thu_tien.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Thu/Chi - Tổng kết</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/cai-dat-nha-tro.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=55px src="/images/icons/menus/setting.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Cài đặt</b></span>
                                </div>
                            </a>
                                                                        <a href="/quan-ly/option/lich-su-gui-zalo.html" class="item-menu">
                                                        <div class="icon text-center">
                                    <img width=45px src="/images/icons/icon-zalo.png"/>
                                </div>
                                <div class="key">
                                    <span class="title"><b>Lịch sử gửi zalo</b></span>
                                </div>
                            </a>
                                                </div>
            <button class="scroll-right">→</button> 
        </div>       
    </div>
</div>

<script type="text/javascript">
    const $scrollableContent = $('.scrollable-content');
    const $scrollLeft = $('.scroll-left');
    const $scrollRight = $('.scroll-right');

    function updateButtonVisibility() {
        const scrollLeft = $scrollableContent.scrollLeft();
        const scrollWidth = $scrollableContent[0].scrollWidth-10;
        const clientWidth = $scrollableContent[0].clientWidth;

        $scrollLeft.toggleClass('hidden', scrollLeft === 0);
        $scrollRight.toggleClass('hidden', scrollLeft + clientWidth >= scrollWidth);
    }

    $scrollLeft.click(function() {
        $scrollableContent.animate({ scrollLeft: 0 }, 100); // Hiệu ứng cuộn mượt
    });

    $scrollRight.click(function() {
        const scrollWidth = $scrollableContent[0].scrollWidth-10;
        $scrollableContent.animate({ scrollLeft: scrollWidth }, 100); // Hiệu ứng cuộn mượt
    });

    $scrollableContent.on('scroll', updateButtonVisibility);

    updateButtonVisibility(); // Cập nhật trạng thái nút khi trang được tải
</script>
                <div style="padding:15px 15px 15px 15px; background-color: #fff; border-radius: 10px; margin: 0 10px 10px 10px">
                    <style>
    .tabulator-row.done-background{
        background-color: #4caf5029!important
    }

    .tabulator-row.cancel-background{
        background-color: #eeeeee82!important
    }
    .tabulator-row.enable-background{
        background-color: #ff57220f!important
    }
</style>
<div row>
    <div class="header-item">
        <h4 class="title-item">
            Tất cả hợp đồng
            <i class="des">Danh sách hợp đồng được tạo khi thêm phiên ở mới</i>
        </h4>

                    <button class="add-round" id="addContract" data-bs-toggle="modal" data-bs-target="#addNewContractChooseRoom" data-type="contract">
                <span data-bs-toggle="tooltip" data-bs-placement="left" title="Thêm">
                    <i data-feather="plus"> </i>
                </span>
            </button>
            </div>

    <div class="header-table header-item">
        <div class="d-flex">
            <div style="margin-right: 20px; padding: 0px 10px; border-right: 1px solid #ebeced;position:relative"><i
                    data-feather="filter"></i>
                    <span id="filter-count">0</span>
            </div>
            <div class="d-flex">
                <div class="form-check form-check-inline">
                    <input class="form-check-input contract-filters" type="checkbox" name="is_active" id="is_active" value="is_active">
                    <label class="form-check-label" for="is_active">Trong thời hạn hợp đồng</label>
                    <span class="count-filter active success">0</span>
                </div>

                <div class="form-check form-check-inline">
                    <input class="form-check-input contract-filters" type="checkbox" name="is_tick_terminate" id="is_tick_terminate" value="is_tick_terminate">
                    <label class="form-check-label" for="is_tick_terminate">Đang báo kết thúc</label>
                    <span class="count-filter tick-terminate warning">0</span>
                </div>

                <div class="form-check form-check-inline">
                    <input class="form-check-input contract-filters" type="checkbox" name="is_will_terminate" id="is_will_terminate" value="is_will_terminate">
                    <label class="form-check-label" for="is_will_terminate">Sắp đến hạn </label>
                    <span class="count-filter will-terminate error">0</span>
                </div>

                <div class="form-check form-check-inline">
                    <input class="form-check-input contract-filters" type="checkbox" name="is_expire" id="is_expire" value="is_expire">
                    <label class="form-check-label" for="is_expire">Đã quá hạn</label>
                    <span class="count-filter expire disable">0</span>
                </div>
            </div>
        </div>
        <div class="d-flex">
                            <a href="/cai-dat#contract_template">
                    <button style="margin-left: 10px" class="ml-2 btn btn-primary">
                        <i data-feather="file-text"></i>
                        Thiết lập mẫu hợp đồng
                    </button>
                </a>
                       
        </div>
    </div>

    <div id="buttom-save-container">
        <div style="margin-right: 10px">Bạn có <span id="count-edit">5</span> mục thay đổi bạn có muốn lưu ?</div>
        <div class="btn btn-danger" id="clear-change" style="margin-right: 10px"><i data-feather="x"></i> Xóa tất cả thay đổi</div>
        <div class="btn btn-primary" id="save-change"><i data-feather="save"></i> Lưu thay đổi</div>
    </div>

    <div id="table" class="celled"></div>

    <script type="text/javascript" src="https://quanlytro.me/tabulator-5.5/dist/js/tabulator.js"></script>
    <script type="text/javascript" src="https://quanlytro.me/tabulator-5.5/dist/js/jquery_wrapper.js"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/plugins/flatpickr/js/flatpickr-4.6.9.min.js"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/plugins/flatpickr/js/month-select-4.6.9.min.js"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/plugins/flatpickr/js/vn.js"></script>
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/plugins/xlsx.full.min.js"></script>

    <link href="https://quanlytro.me/householder-admin/plugins/flatpickr/css/flatpickr.min.css" rel="stylesheet">
    <link href="https://quanlytro.me/householder-admin/plugins/flatpickr/css/month-select.min.css" rel="stylesheet">
    <link href="https://quanlytro.me/tabulator-5.5/dist/css/tabulator_semanticui.min.css" rel="stylesheet">
    
    <script type="text/javascript" src="https://quanlytro.me/householder-admin/js/tabulator-setting.js?version=1.3.8"></script>
    <script type="text/javascript">
        Tabulator.extendModule("edit", "editors", common_editors);
        Tabulator.extendModule("accessor", "accessors", common_accessor);
        Tabulator.extendModule("format", "formatters", Object.assign(common_formatters, {
            deposit_contract: function (cell, formatterParams){
                return `<div style="line-height: 100%;width: 100%;"><strong>${__format.currency(cell.getData().deposit_contract_amount) ?? 0}</strong><div style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;"><i style="font-size: 11px;color:${cell.getData().status_text_deposit_contract.color};">(${cell.getData().status_text_deposit_contract.text})</i></div></div>`;
            }, 
            document: function (cell, formatterParams) {
                let data = cell.getData();
                if(!data?.documents || data.documents.length === 0)
                    return 'Chưa ghi nhận';
                return `<div style="display: inline-block; font-size: 12px;"><div>${feather.icons['image'].toSvg({width: 16, height: 16})} Chứng từ </div>`;
            },
            room_name: function (cell, formatterParams){
                return `<div style="line-height: 100%;width: 100%;"><strong>${cell.getData().room.name}</strong><div style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;"><i style="font-size: 11px;color:#15a05c;">Đại diện: ${cell.getData().customer_name}</i></div></div>`;
            },
            signature: function (cell, formatterParams){
                if(cell.getValue() === "Khách đã ký")
                    return `<div style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;"><span>${cell.getValue()}</span></div>`

                return `<div style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;"><span>${cell.getValue()}</span></div>`
            },
            list_lang: function (cell, formatterParams) {
                if (typeof formatterParams['list'][cell.getValue()] !== "undefined") {
                    return `<span>${formatterParams['list'][cell.getValue()]['name']}</span>`;
                }
                return "Không xác định";
            },
        }));
    </script>
    <script>
         $(document).ready(function () {
            var __el = {
                table: $("#table"),
                filter_check: $(".header-table .form-check-input"),
                count_filter: $("#filter-count"),
                count_edit: $("#count-edit"),
                button_save_container: $("#buttom-save-container"),
                save_change: $("#save-change"),
                clear_change: $("#clear-change"),
                setting_contract_template: $("#setting-contract-template"),
            };

            var dataEdited = {};
            var groupValues = [];
            var tableDataNewSession = {};
            var tableDataInit = [];
            var tableData = {};
            let columns = {};
            let filters = {
                status: [],
            };

            let documentModal = new __modalEditCell(
                $("#documentModal").get(0),
                $('#document-form').get(0),
                $('#submit-document-form').get(0)
            );

            //Build Tabulator
            let table = new Tabulator(__el.table.get(0), {
                index:'id',
                layout: "fitColumns",
                resizableColumnFit:true,
                reactiveData: true,
                height: false,
                movableRows: false,
                columnHeaderVertAlign: 'middle',
                selectable: false,
                minHeight: 200,
                placeholder: `<div class="empty-table" style="margin: auto; display: inline-grid;"><img width="300px" src="https://quanlytro.me/images/empty-box-4085812-3385481.webp" />Không tìm thấy dữ liệu!</div>`,
                rowFormatter:function(row){
                    var data = row.getData();
                    
                    // 'is_active','is_will_terminate','is_tick_terminate','is_expire','unactivated'
                    if(!['is_active'].includes(row.getData().status)){
                        row.getElement().classList.add("enable-background");
                    }
                },
            });

            function renderCount(){
                __el.count_filter.text(table.getData().length);
                if(tableDataInit?.length >=1 ){
                    $(".count-filter.active").text(__countStatus(tableDataInit, 'is_active'));
                    $(".count-filter.tick-terminate").text(__countStatus(tableDataInit, 'is_tick_terminate'));
                    $(".count-filter.will-terminate").text(__countStatus(tableDataInit, 'is_will_terminate'));
                    $(".count-filter.expire").text(__countStatus(tableDataInit, 'is_expire'));
                }
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                });
            }

            table.on("cellEdited", function (cell) {
                let dataNew = {
                    ...cell.getData()
                };
                
                if (cell.getValue() !== cell.getInitialValue() && (cell.getValue()!=='' || (cell.getInitialValue() && cell.getInitialValue()===undefined))) {
                    dataEdited[cell.getData().id] = cell.getData();
                    $(cell.getRow().getCell('id').getElement()).find('div').addClass("edited");
                    checkShowEdit();
                    __el.count_edit.text(Object.keys(dataEdited).length);

                    dataNew.is_edited = true;
                    cell.getRow().update(dataNew);
                }
            });

            window.contractTable = table;

            const prepareColumns = function (column) {
                if (column?.clickMenu && typeof commonClickMenu[column?.clickMenu] !== "undefined")
                    column.clickMenu = commonClickMenu[column?.clickMenu];

                if(__permission_block === null || __permission_block.contract.update){
                    if (column?.cellClick && typeof commonCellClick[column?.cellClick] !== "undefined")
                        column.cellClick = commonCellClick[column?.cellClick];

                    if(column.field ==='customer_id'){
                        column.editorParams={
                            isNumber:true,
                            values: null,
                            hookGetData: function(data, cell){
                                if(cell.getData()?.customers?.length === 0){
                                    return [];
                                }
                                return cell.getData().customers.map((item)=>{
                                        return {
                                            id: item.id,
                                            value: item.id,
                                            label: item.name,
                                        }
                                });
                            }
                        };

                        column.formatterParams={
                            isNumber:true,
                            values: null,
                            hookGetData: function(data, cell){
                                if(cell.getData()?.customers?.length === 0){
                                    return [];
                                }
                                
                                return cell.getData().customers.map((item)=>{
                                        return {
                                            id: item.id,
                                            value: item.id,
                                            label: item.name,
                                            name: item.name,
                                        }
                                });
                            }
                        };
                    }    

                    if (!column?.cssClass) {
                        if (column?.editor) {
                            column.cssClass = "edit_enable"
                        } else {
                            column.cssClass = "edit_disable";
                        }
                    }

                    if(column?.cellClick==='document'){
                            column.cellClick = function (e, cell) {
                                documentModal.showModal(cell, {
                                    __submitModalForm: function (e) {
                                        let data = $(this.form).getObjectOfForm();
                                        if(!$('#document').data('uploadImageData').value){
                                                Swal.fire({
                                                    title: 'Thông báo!',
                                                    text: 'Yêu cầu chừng từ',
                                                    icon: 'error',
                                                    confirmButtonText: 'Đã hiểu'
                                                });
                                        }else{
                                            this.cell.setValue(null);
                                            if($('#document').data('uploadImageData').value.length !== 0)
                                                this.cell.setValue($('#document').data('uploadImageData').value);

                                            this.modalInstance.hide();
                                        }
                                    },
                                    __openModalForm:function (e) {

                                        // Set image cũ cho form
                                        if(this.cell.getData()?.documents){
                                            $('#document').data('uploadImageData').setValue(this.cell.getData()?.documents)
                                        }else{
                                            $('#document').data('uploadImageData').setValue(null);
                                        }
                                    }
                                });
                            }
                        }
                }else{
                    if(column.field ==='customer_id'){
                        column.formatterParams={
                            isNumber:true,
                            values: null,
                            hookGetData: function(data, cell){
                                if(cell.getData()?.customers?.length === 0){
                                    return [];
                                }
                                
                                return cell.getData().customers.map((item)=>{
                                        return {
                                            id: item.id,
                                            value: item.id,
                                            label: item.name,
                                            name: item.name,
                                        }
                                });
                            }
                        };
                    }   

                    column.editable = function (cell) {
                        return false;
                    } 
                }
               
                return column;
            };

            const checkShowEdit = function () {
                dataEdited && Object.keys(dataEdited).length > 0 ?
                    __el.button_save_container.addClass('show') :
                    __el.button_save_container.removeClass('show');
            };

            const loadData = (filter = null) => $.transferData({
                method: "POST",
                data: {
                    filters: filter ?? null
                },
                url: __helper.url.urlPattern(__routeApi.contract.listByBlock, {
                    block_id : parseInt(7081)
                }),
                success: (res) => {
                    if (res?.data?.table_data?.columns) {
                        columns = res?.data?.table_data?.columns;
                        tableData = res?.data?.payload;
                        dataEdited = {};

                        columns.map((column) => {
                            prepareColumns(column);
                            if (column?.columns && column.columns.length > 0) {
                                column.columns.map((col, index_col) => {
                                    column.columns[index_col] = prepareColumns(col);
                                });
                            }
                            return column;
                        });

                        tableDataNewSession = JSON.parse(JSON.stringify(tableData));
                        if(!tableDataInit || Object.keys(tableDataInit).length === 0){
                            tableDataInit = [...(res?.data?.payload ?? [])];
                        }

                        table.setColumns(columns);
                        table.setData(tableData);
                        table.setSort("room.sort", "asc");
                    } else {
                        tableDataNewSession = null;
                        table.setData(null);
                        table.setSort("room.sort", "asc");
                    }
                    renderCount();
                },
                error: (e) => {
                    Swal.fire({
                        title: 'Thông báo!',
                        text: 'Đã có lỗi trong quán trình tải danh sách'+e,
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });
                }
            });

            loadData(null);

            __el.filter_check.on('change', (e) => {
                filters.status =  $('.contract-filters:checked').map(function(_, el) {
                    return $(el).val();
                }).get();
                loadData(filters);
            });

            __el.clear_change.click(() => {
                dataEdited = {};
                checkShowEdit();
                table.setData(tableDataNewSession);
            });

            __el.save_change.click(() => {
                if (Object.keys(dataEdited).length === 0) {
                    Swal.fire({
                        title: 'Thông báo!',
                        text: 'Không có gì thay đổi!',
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });

                    return false;
                }
                $.transferData({
                    method: "POST",
                    url:__helper.url.urlPattern(__routeApi.contract.updateSeries, {
                        block_id: parseInt(7081)
                    }),
                    data: {
                        data_edited: dataEdited,
                    },
                    success: (res) => {
                        Swal.fire({
                            title: 'Thao tác thành công!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonText: 'Đã hiểu'
                        });

                        dataEdited = {};
                        checkShowEdit();

                        table.setData(tableData.map((item) => {
                            item.is_edited = false;
                            return item;
                        }));
                    },
                    fail: (res) => {
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'warning',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            });

            __settingSaveChangeContainer(__el.table);
         })
    </script>

</div>
<!-- Modal add new contract -->
<div class="modal fade" data-bs-backdrop="static"  id="addNewContractChooseRoom" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                <i data-feather="book"> </i>
                </div>
                <h5 class="modal-title">Thêm hợp đồng mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="add-new-contract" novalidate>
                    <input type="hidden" name="_token" value="CZqXP04OzKEuLEt01gkxMY2DrN3sCqnCK8eSZ2o4">                    <div class="row g-3">
                        <div class="col-7">
                            <div class="col-12 mb-2">
                                <div class="title-item-small">
                                    <b>Danh sách phòng</b>
                                    <i class="des">Danh sách phòng có thể lập hợp đồng</i>
                                </div>
                            </div>
                            <div style="position: sticky; top: 20px">
                                <div class="room-list row g-2">

                                </div>
                            </div>
                        </div>
                        <div class="col-5">
                            <div style="position: sticky; top: 20px">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <div class="title-item-small">
                                            <b>Thời hạn hợp đồng:</b>
                                        </div>
                                    </div>

                                    <div class="col-md-12 mt-2">
                                        <div class="form-floating">
                                            <select data-format="numeric" id="contract_time" name="contract_time"
                                                    class="form-select form-control">
                                                                                                                                                            <option value="0">Tùy chỉnh</option>
                                                                                                            <option value="1">1 tháng</option>
                                                                                                            <option value="2">2 tháng</option>
                                                                                                            <option value="3">3 tháng</option>
                                                                                                            <option value="4">4 tháng</option>
                                                                                                            <option value="5">5 tháng</option>
                                                                                                            <option value="6">6 tháng</option>
                                                                                                            <option value="7">7 tháng</option>
                                                                                                            <option value="8">8 tháng</option>
                                                                                                            <option value="9">9 tháng</option>
                                                                                                            <option value="10">10 tháng</option>
                                                                                                            <option value="11">11 tháng</option>
                                                                                                            <option value="12">1 năm</option>
                                                                                                            <option value="18">1 năm, 6 tháng</option>
                                                                                                            <option value="24">2 năm</option>
                                                                                                            <option value="32">3 năm</option>
                                                                                                            <option value="48">4 năm</option>
                                                                                                            <option value="60">5 năm</option>
                                                                                                                                                </select>
                                            <label for="contract_time">Thời hạn hợp đồng</label>
                                        </div>
                                    </div>

                                    <div class="col-6 mt-2">
                                        <div class="input-group">
                                            <div class="form-floating">
                                                <input type="text" class="form-control date-flat-picker" name="date_join"
                                                    id="date_join"
                                                    data-format="date"
                                                    placeholder="Ngày vào ở" pattern="\d{1,2}\/\d{1,2}\/\d{4}" required>
                                                <label for="date_join">Ngày vào ở</label>
                                            </div>
                                            <label class="input-group-text" for="date_join"><i
                                                    data-feather="calendar"> </i></label>
                                        </div>
                                        <div class="invalid-feedback">
                                            Vui lòng nhập ngày vào ở và ngày không đúng định dạng. Vui lòng kiểm tra lại
                                        </div>
                                    </div>
                                    <div class="col-6 mt-2">
                                        <div class="input-group">
                                            <div class="form-floating">
                                                <input type="text" class="form-control date-flat-picker" name="date_terminate"
                                                    id="date_terminate" placeholder="Ngày kết thúc hợp đồng"
                                                    data-format="date"
                                                    pattern="\d{1,2}\/\d{1,2}\/\d{4}">
                                                <label for="date_terminate">Kết thúc hợp đồng</label>
                                            </div>
                                            <label class="input-group-text" for="date_terminate"><i
                                                    data-feather="calendar"> </i></label>
                                        </div>
                                        <div class="invalid-feedback">
                                            Ngày không đúng định dạng. Vui lòng kiểm tra lại
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="title-item-small">
                                            <b>Thông tin khách thuê:</b>
                                        </div>
                                    </div>

                                    <div class="col-12 mt-2" style="display: block">
                                        <div class="form-floating">
                                            <input data-format="numeric" type="text" class="form-control" value="1"
                                                name="customer_count" min="0"
                                                id="customer_count" placeholder="Nhập số người ở" required>
                                            <label for="customer_count">Số lượng thành viên</label>
                                            <div class="invalid-feedback">
                                                Vui lòng nhập số lượng thành viên
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6 mt-2">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" name="customer_name" id="customer_name"
                                                placeholder="Nhập tên người ở"
                                                oninput="this.value = __format.capitalizeFirstStr(this.value)"
                                                required>
                                            <label for="customer_name">Tên người ở</label>
                                            <div class="invalid-feedback">
                                                Vui lòng nhập tên người ở
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6 mt-2">
                                        <div class="form-floating">
                                            <input type="text" class="form-control phone" name="customer_phone" id="customer_phone"
                                                placeholder="Nhập sdt người ở" data-format="stringNumber" required>
                                            <label for="customer_phone">Số điện thoại người ở</label>
                                            <div class="invalid-feedback">
                                                Vui lòng nhập sdt người ở
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12 mt-2">
                                        <div class="form-check form-check-inline">
                                            <input data-format="numeric" class="form-check-input" type="radio" name="identity_type" id="cccd" checked="" value="0">
                                            <label class="form-check-label" for="cccd">Đinh dạng CCCD</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input data-format="numeric" class="form-check-input" type="radio" name="identity_type" id="passport" value="1">
                                            <label class="form-check-label" for="passport">Đinh dạng Passport/Visa</label>
                                        </div>
                                    </div>

                                    <div class="col-12 mt-2">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" name="identity_number"
                                                   id="identity_number" placeholder="Nhập số CMND/CCCD">
                                            <label id="label-identity-number" for="identity_number">CMND/CCCD</label>
                                            <div class="invalid-feedback">
                                                Vui nhập cmnd/cccd đúng định dạng
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6">
                                        <div class="input-group">
                                            <div class="form-floating">
                                                <input type="text" class="form-control date-flat-picker" name="birthday"
                                                       id="birthday" data-format="date"
                                                       placeholder="Ngày vào ở" pattern="\d{1,2}\/\d{1,2}\/\d{4}">
                                                <label for="birthday">Ngày sinh</label>
                                            </div>
                                            <label class="input-group-text" for="birthday"><i
                                                    data-feather="calendar"> </i></label>
                                        </div>
                                        <div class="invalid-feedback">
                                            Vui lòng nhập này sinh và phải đúng định dạng
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-floating">
                                            <select id="customer_sex" name="sex" class="form-select form-control" required>
                                                <option value="1" selected>Nam</option>
                                                <option value="0">Nữ</option>
                                                <option value="-1">Chưa xác định</option>
                                            </select>
                                            <label for="customer_sex">Giới tính</label>
                                        </div>
                                    </div>
            
                                    <div class="col-12">
                                        <div id="contract_customer_address" class="address_component_container row g-2">
    <div class="col-6 mt-2">
        <div class="form-floating">
            <select data-format="numeric" name="address_component[province_id]" class="form-select form-control province" >
                <option value="">Tỉnh/Thành phố</option>
            </select>
            <label for="province">Chọn Tỉnh/Thành phố</label>
            <div class="invalid-feedback">
                Vui lòng chọn thành phố
            </div>
        </div>
    </div>
    <div class="col-6 mt-2">
        <div class="form-floating">
            <select data-format="numeric" name="address_component[district_id]" class="form-select form-control district" >
                <option value="">Quận/Huyện</option>
            </select>
            <label for="district">Chọn Quận/Huyện</label>
            <div class="invalid-feedback">
                Vui lòng chọn quận hoặc huyện
            </div>
        </div>
    </div>
    <div class="col-12 mt-2">
        <div class="form-floating">
            <select data-format="numeric" name="address_component[ward_id]" class="form-select form-control ward" >
                <option value="">Phường/Xã</option>
            </select>
            <label for="ward">Chọn Phường/Xã</label>
            <div class="invalid-feedback">
                Vui lòng chọn phường hoặc xã
            </div>
        </div>
    </div>
    <div class="col-12 mt-2">
        <div class="form-floating">
            <input type="text" class="form-control address_detail" name="address_component[address_detail]"
                placeholder="ví dụ: 122 - Đường Nguyễn Duy Trinh" >
            <label for="address_detail">Địa chỉ chi tiết. Ví dụ: 122 - Đường Nguyễn Duy Trinh</label>
            <div class="invalid-feedback">
                Vui lòng nhập địa chỉ chi tiết
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        let __el = {
            province: $("#contract_customer_address").find(".province"),
            district: $("#contract_customer_address").find(".district"), 
            ward    : $("#contract_customer_address").find(".ward"),

            address_detail : $("#contract_customer_address").find(".address_detail"),
            address_show_container: $("#contract_customer_address").find(".address-detail-show-container"),  
            address_show: $("#contract_customer_address").find(".address-detail-show"),   
        };

        function getAddressFull(){
            let arrayText = [
                __el.address_detail.val(),
                __el.ward.find('option:selected').text().trim(),
                __el.district.find('option:selected').text().trim(),
                __el.province.find('option:selected').text().trim() 
            ];
            if(arrayText[0].lengh!=='' && arrayText[1].lengh!=='' && arrayText[2].lengh!=='' && arrayText[2].lengh!==''){
                __el.address_show_container.show();
                __el.address_show.text(arrayText.join(', '));
            }else{
                __el.address_show_container.hide();
            }
        }

        __el.address_detail.keyup((e)=>{
            getAddressFull();
        });

        __el.province.change(function(){
            __el.district.empty();
            __el.ward.empty();

            $.transferData({
                url: __helper.url.urlPattern(__routeApi.location.showProvince, {
                        id : parseInt($(this).val())
                    }),
                method: 'GET',
                success:function(res){
                     __el.district.append(`<option value=''>Quận/Huyện</option>`);
                    $.each(res.data.districts, function(key, value) {
                        __el.district.append(`<option value='${value.id}'>${value.name}</option>`);
                    });
                    getAddressFull();
                }
            });

        });

        __el.district.change(function(){
            __el.ward.empty();
            $.transferData({
                url: __helper.url.urlPattern(__routeApi.location.showDistrict, {
                        id : parseInt($(this).val())
                    }),
                method: 'GET',
                success:function(res){
                    __el.ward.append(`<option value=''>Phường/Xã</option>`);
                    $.each(res.data.wards, function(key, value) {
                        __el.ward.append(`<option value='${value.id}'>${value.name}</option>`);
                    });
                    getAddressFull();
                }
            });
        });

        __el.ward.change(function(){
            getAddressFull();
        });
    });
</script> 

                                    </div>
            
                                    <div class="col-12 mt-2">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" name="job"
                                                   id="customer_job" placeholder="Nhập công việc khách thuê">
                                            <label for="customer_job">Nhập công việc</label>
                                            <div class="invalid-feedback">
                                                Vui lòng nhập công việc của khách thuê
                                            </div>
                                        </div>
                                    </div>
             
                                    <div class="col-6">
                                        <div class="input-group">
                                            <div class="form-floating">
                                                <input type="text" class="form-control date-flat-picker" name="identity_date"
                                                       id="identity_date" data-format="date"
                                                       placeholder="Ngày cấp " pattern="\d{1,2}\/\d{1,2}\/\d{4}">
                                                <label for="identity_date">Ngày cấp CMND/CCCD</label>
                                            </div>
                                            <label class="input-group-text" for="identity_date"><i
                                                    data-feather="calendar"> </i></label>
                                        </div>
                                        <div class="invalid-feedback">
                                            Vui lòng nhập ngày đúng định dạng
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-floating">
                                            <input type="text" class="form-control" name="identity_place"
                                                   id="identity_place" placeholder="Nhập số CMND/CCCD">
                                            <label for="identity_place">Nơi cấp CMND/CCCD</label>
                                            <div class="invalid-feedback">
                                                Vui nhập nơi cấp CMND/CCCD
                                            </div>
                                        </div>
                                    </div>
            
                                    <div class="col-6 mt-2">
                                        <div id="image_identity_before_ele" class="image-upload-simple">
                                        </div>
                                    </div>
            
                                    <div class="col-6 mt-2">
                                        <div id="image_identity_after_ele" class="image-upload-simple">
                                        </div>
                                    </div>


                                                                            <div class="col-12">
                                            <div class="title-item-small">
                                                <b>Dịch vụ sử dụng</b>
                                                <i class="des">Thêm dịch vụ sử dụng như: điện, nước, rác, wifi...</i>
                                            </div>
                                            <div class="price-items-checkout-layout">
                    <div class="item">
                <div class="item-check-name">
                    <input class="form-check-input" id="room_check_price_item_23351" type="checkbox" value="1"
                           name="price_items[23351][is_selected]">

                    <label for="room_check_price_item_23351">
                        <b>Tiền điện</b>
                                                    <p>Giá: <b>1.700đ</b> / KWh</p>
                                            </label>
                </div>

                <div class="item-value">
                                                <div class="input-group mb-2">
                                <input class="form-control" id="new_contract_room_price_item_23351_0" min="0" type="number"
                                    placeholder="Nhập chỉ số hiện tại"
                                    required
                                    oninput="$(new_contract_room_price_item_23351_1).val(this.value)"
                                    value="0" name="price_items[23351][value][]">
                                <label style="font-size: 12px" class="input-group-text" for="new_contract_room_price_item_23351_0">Chỉ số <br>hiện tại</label>
                            </div>
                            <div class="input-group" style="display: none">
                                <input class="form-control" id="new_contract_room_price_item_23351_1" min="0" type="number"
                                    oninput="$(new_contract_room_price_item_23351_0).val(this.value)"
                                    placeholder="Nhập số mới"
                                    required
                                    value="0" name="price_items[23351][value][]">
                                <label class="input-group-text" for="new_contract_room_price_item_23351_1">Số mới</label>
                            </div>
                                    </div>
            </div>
                    <div class="item">
                <div class="item-check-name">
                    <input class="form-check-input" id="room_check_price_item_23352" type="checkbox" value="1"
                           name="price_items[23352][is_selected]">

                    <label for="room_check_price_item_23352">
                        <b>Tiền nước</b>
                                                    <p>Giá: <b>18.000đ</b> / Khối</p>
                                            </label>
                </div>

                <div class="item-value">
                                                <div class="input-group mb-2">
                                <input class="form-control" id="new_contract_room_price_item_23352_0" min="0" type="number"
                                    placeholder="Nhập chỉ số hiện tại"
                                    required
                                    oninput="$(new_contract_room_price_item_23352_1).val(this.value)"
                                    value="0" name="price_items[23352][value][]">
                                <label style="font-size: 12px" class="input-group-text" for="new_contract_room_price_item_23352_0">Chỉ số <br>hiện tại</label>
                            </div>
                            <div class="input-group" style="display: none">
                                <input class="form-control" id="new_contract_room_price_item_23352_1" min="0" type="number"
                                    oninput="$(new_contract_room_price_item_23352_0).val(this.value)"
                                    placeholder="Nhập số mới"
                                    required
                                    value="0" name="price_items[23352][value][]">
                                <label class="input-group-text" for="new_contract_room_price_item_23352_1">Số mới</label>
                            </div>
                                    </div>
            </div>
            </div>
                                        </div>
                                    
                                    <div class="col-12">
                                        <div class="title-item-small">
                                            <b>Thông tin giá trị hợp đồng:</b>
                                            <i class="des">Giá tiền phòng và tiền cọc</i>
                                        </div>
                                    </div>

                                    <div class="col-6 mt-2">
                                        <div class="form-floating">
                                            <input type="text" class="form-control currency" name="room_amount" id="room_amount"
                                                data-format="numeric" min="0"
                                                placeholder="Nhập giá thuê" required>
                                            <label for="room_amount">Giá thuê (đ)</label>
                                            <div class="invalid-feedback">
                                                Vui lòng nhập giá thuê
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6 mt-2">
                                        <div class="form-floating">
                                            <input type="text" class="form-control currency" name="deposit_contract_amount"
                                                   data-format="numeric" min="0"
                                                   id="deposit_contract_amount" placeholder="Nhập số tiền cọc" required>
                                            <label for="deposit_contract_amount">Mức tiền cọc (đ)</label>
                                            <div class="invalid-feedback">
                                                Vui lòng nhập số tiền cọc
                                            </div>
                                        </div>
                                    </div>
            
                                    <div class="col-12">
                                        <div class="loz-alert warning mt-2 mb-2">
                                            <div class="icon flex-0">
                                                <i data-feather="info" size="20"> </i>
                                            </div>
                                            <div class="des flex-1">
                                                Bạn cần <b>tạo hóa đơn đầu tháng </b>để hoàn tất việc thu tiền cọc 
                                            </div>
                                        </div>
                                    </div>
                                                      
                                    <div class="col-12 mt-2">
                                        <div class="form-floating">
                                            <select data-format="numeric" id="circle_month" name="circle_month"
                                                    class="form-select form-control">
                                                                                                                                                            <option
                                                            value="1">1 tháng</option>
                                                                                                            <option
                                                            value="2">2 tháng</option>
                                                                                                            <option
                                                            value="3">3 tháng</option>
                                                                                                            <option
                                                            value="4">4 tháng</option>
                                                                                                            <option
                                                            value="5">5 tháng</option>
                                                                                                            <option
                                                            value="6">6 tháng</option>
                                                                                                            <option
                                                            value="7">7 tháng</option>
                                                                                                            <option
                                                            value="8">8 tháng</option>
                                                                                                            <option
                                                            value="9">9 tháng</option>
                                                                                                            <option
                                                            value="10">10 tháng</option>
                                                                                                            <option
                                                            value="11">11 tháng</option>
                                                                                                            <option
                                                            value="12">1 năm</option>
                                                                                                            <option
                                                            value="18">1 năm, 6 tháng</option>
                                                                                                            <option
                                                            value="24">2 năm</option>
                                                                                                            <option
                                                            value="32">3 năm</option>
                                                                                                            <option
                                                            value="48">4 năm</option>
                                                                                                            <option
                                                            value="60">5 năm</option>
                                                                                                                                                </select>
                                            <label for="circle_month">Chu kỳ thu tiền</label>
                                        </div>
                                    </div>
                                    
                                    <div class="col-12">
                                        <div class="title-item-small">
                                            <b>Chọn mẫu văn bản hợp đồng</b>
                                            <i class="des">Mẫu văn bản hợp đồng dùng khi in</i>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-floating">
                                            <select data-format="numeric" id="room_contract_template_id" name="room_contract_template_id" class="form-select form-control">
                                                <option value="">Mẫu văn bản hợp đồng</option>
                                                                                                                                                            <option value="1">Mẫu mặc định</option>
                                                                                                                                                </select>
                                            <label for="room_contract_template_id">Danh sách mẫu văn bản hợp đồng đang có</span></label>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="title-item-small">
                                            <b>Ghi chú</b>
                                            <i class="des">Những ghi chú lưu ý cho hợp đồng này</i>
                                        </div>
                                    </div>
                                    <div class="col-12 mt-2">
                                        <div class="form-floating">
                                            <textarea type="text" rows="10" style="min-height: 70px" class="form-control" name="note"
                                                      id="note" placeholder="Ghi chú"></textarea>
                                            <label for="addition_reason">Ghi chú</label>
                                        </div>
                                    </div>

                                    
                                    
                                                                        <div class="agent-section">
                                        <div class="col-12">
                                            <div class="title-item-small">
                                                <b>Môi giới</b>
                                                <i class="des">Chọn người giới thiệu hợp đồng và phí môi giới</i>
                                            </div>
                                        </div>
            
                                        <div class="col-12 mt-2">
                                            <div class="form-floating">
                                                <select data-format="numeric" id="agent_id" name="agent_id" class="form-select form-control">
                                                    <option data="0" value="">---Chọn môi giới----</option>
                                                </select>
                                                <label for="agent_id">Danh sách môi giới</span></label>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6 mt-2">
                                                <div class="form-floating">
                                                    <select data-format="numeric" id="commission_rate" name="commission_rate" class="form-select form-control">
                                                        <option value="">---- % hoa hồng ----</option>
                                                                                                                                                                                    <option value="0">0%</option>
                                                                                                                            <option value="10">10%</option>
                                                                                                                            <option value="20">20%</option>
                                                                                                                            <option value="30">30%</option>
                                                                                                                            <option value="40">40%</option>
                                                                                                                            <option value="50">50%</option>
                                                                                                                            <option value="60">60%</option>
                                                                                                                            <option value="70">70%</option>
                                                                                                                            <option value="80">80%</option>
                                                                                                                            <option value="90">90%</option>
                                                                                                                            <option value="100">100%</option>
                                                                                                                                                                        </select>
                                                    <label for="commission_rate">Mức hoa hồng</span></label>
                                                </div>
                                            </div>
            
                                            <div class="col-6 mt-2">
                                                <div class="form-floating">
                                                    <input type="text" class="form-control currency" name="commission"
                                                        data-format="numeric" min="0"
                                                        id="commission" placeholder="Số tiền nhận">
                                                    <label for="commission">Số tiền nhận (đ)</label>
                                                </div>
                                            </div>
                                        </div>
            
                                        <div class="col-12 mt-2">
                                            <div class="form-check form-switch">
                                                <input data-format="numeric" class="form-check-input" type="checkbox" value="1"
                                                    id="auto_receipts_expenses" name="auto_receipts_expenses">
                                                <label class="form-check-label" for="auto_receipts_expenses">
                                                    <b>Tạo phiếu chi</b>
                                                    <p>Tạo phiếu chi hoa hồng cho môi giới</p>
                                                </label>
                                            </div>
                                        </div>
                                    </div> 
                                                                    </div>
                            </div>
                        </div>
                    </div>            
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="submit-new-contract" class="btn btn-primary">
                    <i data-feather="plus"> </i>
                    Thêm hợp đồng mới
                </button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        let __el = {
            form: $('#add-new-contract'),
            modal: $("#addNewContractChooseRoom"),
            submit: $('#submit-new-contract')
        };

        let roomData = null;
        let cell = null;

        let image_identity_before = null;
        let image_identity_after = null;
        let document = null;


        let block_price_item = JSON.parse(JSON.stringify([{"id":23351,"name":"Ti\u1ec1n \u0111i\u1ec7n","type":"constant","unit":"kwh","price":1700,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"ele","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"KWh","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1},{"id":23352,"name":"Ti\u1ec1n n\u01b0\u1edbc","type":"constant","unit":"khoi","price":18000,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"water","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"Kh\u1ed1i","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1}]));

        let block_asset = JSON.parse(JSON.stringify(null));

        __el.form.find('input[name="identity_type"]').change(function() {
            if(parseInt($(this).val()) === 1){
                __el.form.find('#label-identity-number').text('Passport/Visa')
                __el.form.find('input[name="identity_type"]').attr('placeholder', 'Passport/Visa');
            }else{
                __el.form.find('#label-identity-number').text('CMND/CCCD')
                __el.form.find('input[name="identity_type"]').attr('placeholder', 'CMND/CCCD');
            }
        });

        const renderRooms = () => {
            __el.modal.find('.room-list').html('');

            if (!roomList || roomList?.length === 0) {
                roomList = [];
                __el.modal.find('.room-list').html('Không có phòng nào để thêm khách thuê');
                return false;
            }

            roomList.map((room) => {
                let isActive = (roomData?.id === room.id);
                let icon = isActive ? `<div class="flex-grow-0 icon-room">${feather.icons['check'].toSvg()}</div>` :
                                      `<div class="flex-grow-0 icon-room"><img width="20px" src="/images/icons/room.png" alt=""/></div>`;
                let item = $(`
                    <div class="col-6 room-item${isActive ? ' active' : ''}">
                        <div class="d-flex room-item-inner align-items-center">
                             ${icon}
                            <div class="flex-grow-1">
                                <div>
                                    <b>${room.name}</b>
                                    <span style="background-color: ${room.status_color}; display: table; font-size: 12px; border-radius: 5px; padding:0 7px; color: #fff">${room.status_text}</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <div>${feather.icons['dollar-sign'].toSvg({width: 18,height: 18})} ${__format.currency(room.room_amount)}</div>
                                    <div>${feather.icons['user'].toSvg({width: 18, height: 18})} ${room.customers.length}/${room.customer_count} người</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).click(function (e) {
                    if ($(this).hasClass("active")) {
                        $(this).removeClass("active");
                        roomData = null;
                        setDefaultForm();
                    } else {
                        $(this).addClass("active");
                        roomData = room;
                    }

                    if(roomData){
                        $.transferData({
                            method: "GET",
                            url: __helper.url.urlPattern(__routeApi.room.show, {
                                id: roomData.id
                            }),
                            textLoading: `Đang tải thông tin ${__current_block?.room_type_name ?? ''}...`,
                            success: (res) => {
                                roomData = res?.data ?? null;
                                __el.form.find('input[name="room_amount"]').val(__format.currencyInput(roomData?.room_amount) ?? 0);
                                __el.form.find('input[name="deposit_contract_amount"]').val(__format.currencyInput(roomData?.room_amount) ?? 0);
                                
                                let room_price_item = JSON.parse(JSON.stringify(roomData.price_items)) ?? [];
                                if(Array.isArray(room_price_item) && room_price_item?.length > 0){
                                    room_price_item.map((item, key)=> {
                                        __el.form.find(`input[name="price_items[${item.id}][is_selected]"]`).prop("checked", true);
                                        
                                        let value = __getDefaultPriceItemsValue(item, null);
                                        if(item.subtraction===1){
                                            __el.form.find(`input[name="price_items[${item.id}][value][]"]`)?.length &&
                                            __el.form.find(`input[name="price_items[${item.id}][value][]"]`).map((index, el)=>{
                                                $(el).val(value[index] ?? '0')
                                            });
                                        }else{
                                            __el.form.find(`input[name="price_items[${item.id}][value][]"]`).val(value[0] ?? '0');
                                        }
                                    });
                                }else{
                                    Array.isArray(block_price_item) &&
                                    block_price_item?.length > 0 &&
                                    block_price_item.map((item, key)=> {
                                        __el.form.find(`input[name="price_items[${item.id}][is_selected]"]`).prop("checked", false);
                                        
                                        let value = __getDefaultPriceItemsValue(item, null);
                                        if(item.subtraction===1){
                                            __el.form.find(`input[name="price_items[${item.id}][value][]"]`)?.length &&
                                            __el.form.find(`input[name="price_items[${item.id}][value][]"]`).map((index, el)=>{
                                                $(el).val(0)
                                            });
                                        }else{
                                            __el.form.find(`input[name="price_items[${item.id}][value][]"]`).val(value[0] ?? '0');
                                        }
                                    });
                                }
             
                                // Set các tài sản đã được thiết lập cho phòng
                                let room_asset = JSON.parse(JSON.stringify(roomData.asset)) ?? [];
                                Array.isArray(room_asset) &&
                                room_asset?.length > 0 &&
                                room_asset.map((item, key)=> {
                                    __el.form.find(`input[name="assets[${item.id}][is_selected]"]`).prop("checked", true);
                                    
                                    __el.form.find(`input[name="assets[${item.id}][quantity]"]`).val(item?.data?.quantity ?? '0');
                                });
                                
                                if(roomData?.deposit){
                                    __el.form.find('input[name="date_join"]').get(0)._flatpickr.setDate(new Date(roomData?.deposit.date_will_join), true, "d/m/Y");
                                    __el.form.find('input[name="customer_name"]').val(roomData.deposit.customer_name);
                                    __el.form.find('input[name="customer_phone"]').val(roomData.deposit.customer_phone);
                                    __el.form.find('input[name="deposit_contract_amount"]').val(__format.currencyInput(roomData?.deposit.deposit_temp_amount) ?? 0)
                                }
                            },
                            fail: (res) => {
                                Swal.fire({
                                    title: 'Thông báo!',
                                    text: "Không thể tải thông tin "+ res.message,
                                    icon: 'error',
                                    confirmButtonColor: '#3c9e47',
                                    confirmButtonText: 'Đã hiểu'
                                });
                                setDefaultForm();
                            },
                            error:(res)=>{
                                Swal.fire({
                                    title: 'Thông báo!',
                                    text: "Không thể tải thông tin",
                                    icon: 'error',
                                    confirmButtonColor: '#3c9e47',
                                    confirmButtonText: 'Đã hiểu'
                                });
                                setDefaultForm();
                            }
                        });
                    }
                    renderRooms();
                });
                __el.modal.find('.room-list').append(item);
            });
        };

        const loadRoom = () => $.transferData({
            method: "POST",
            url: __helper.url.urlPattern(__routeApi.bill.listSeries, {
                block_id: parseInt(7081)
            }),
            data: {
                filters: {
                    status: ['is_empty','is_deposit_temp']
                }
            },
            textLoading: `Đang tải danh sách ${__current_block?.room_type_name ?? ''}...`,
            success: (res) => {
                roomList = res?.data?.payload ?? [];
                renderRooms();
            },
            fail: (res) => {
                roomList = [];
                renderRooms();
            }
        });
        

        const setDefaultForm = () =>{
            roomData = null;
            __el.form.find('input[name="date_join"]').get(0)._flatpickr.setDate(new Date());
            __el.form.find('input[name="room_amount"]').val(0);

            Array.isArray(block_price_item) &&
            block_price_item?.length > 0 &&
            block_price_item.map((item, key)=> {
                __el.form.find(`input[name="price_items[${item.id}][is_selected]"]`).prop("checked", false);
                
                let value = __getDefaultPriceItemsValue(item, null);
                if(item.subtraction===1){
                    __el.form.find(`input[name="price_items[${item.id}][value][]"]`)?.length &&
                    __el.form.find(`input[name="price_items[${item.id}][value][]"]`).map((index, el)=>{
                        $(el).val(0)
                    });
                }else{
                    __el.form.find(`input[name="price_items[${item.id}][value][]"]`).val(value[0] ?? '0');
                }
            });
        }

        new __modalForm(
            __el.modal.get(0),
            __el.form.get(0),
            __el.submit.get(0),
        ).start(null, {
            __openModalForm:function ({relatedTarget}) {

                // Tải thông tin thành phố, quận, phường.
                $.transferData({
                    method: "GET",
                    url: __helper.url.urlPattern(__routeApi.agent.list),
                    loadingEle : false,
                    success: (res) => {
                        __el.modal.find("#agent_id").empty();
                        __el.modal.find("#agent_id").append(`<option data='0' value=''> --- Chọn môi giới ----</option>`);

                        __el.modal.find(".agent-section").show();
                        if(res?.data?.payload?.length){
                            $.each(res?.data?.payload, function(key, value) {
                                __el.modal.find("#agent_id").append(`<option data='${value.commission_rate}' value='${value.id}'>${value.name}</option>`);
                            });
                        }
                    }
                });

                __el.form.on('change', 'select', function (e) {
                    if ($(this).attr('name') === 'contract_time') {
                        let date_join = new Date(__el.form.find('input[name="date_join"]').get(0)._flatpickr.selectedDates[0]);
                        if (parseInt($(this).val()) > 0) {
                            date_join.setMonth(date_join.getMonth() + parseInt($(this).val()));
                            __el.form.find('input[name="date_terminate"]').get(0)._flatpickr.setDate(date_join, true, "d/m/Y")
                        } else {
                            __el.form.find('input[name="date_terminate"]').get(0)._flatpickr.setDate(null, true, "d/m/Y")
                        }
                    }

                    // Xử lý cho môi giới
                    if ($(this).attr('name') === 'agent_id') {
                        let commission_rate = parseInt($(this).find(':selected').attr('data'));
                        if(Number.isFinite(commission_rate)){
                            __el.form.find('select[name="commission_rate"]').val(commission_rate).change();
                        }
                    }
                    if ($(this).attr('name') === 'commission_rate') {
                        
                        let commission_rate = $(this).val()?.length === 0 ? 0 : parseInt($(this).val());
                        let roomAmount = roomData?.room_amount ?? 0;
                        let commissionAmount = roomAmount;
                        
                        if(commission_rate){
                            commissionAmount = (roomAmount * commission_rate)/100;
                            __el.form.find('input[name="commission"]').prop( "readonly", true );
                        }else{
                            __el.form.find('input[name="commission"]').prop( "readonly", false );
                        }
                        
                        __el.form.find('input[name="commission"]').val(commissionAmount);
                    }
                });

                flatpickr(__el.form.find('input[name="date_join"]'), {
                    defaultDate: 'today',
                    allowInput: true,
                    enableTime: false,
                    dateFormat: "d/m/Y",
                    locale: 'vn',
                    onChange: function(selectedDates, dateStr, instance) {
                        let selected = __el.form.find('select[name=contract_time] option').filter(':selected').val()
                        if( parseInt(selected) > 0){
                            selectedDates[0].setMonth(selectedDates[0].getMonth() + parseInt(selected));
                            __el.form.find('input[name="date_terminate"]').get(0)._flatpickr.setDate(selectedDates[0], true, "d/m/Y")
                        }
                    },
                });

                flatpickr(__el.form.find('input[name="date_terminate"]'), {
                    allowInput: true,
                    enableTime: false,
                    dateFormat: "d/m/Y",
                    locale: 'vn'
                });
                
                image_identity_before = __el.form.find('#image_identity_before_ele').uploadImageSimple({
                    label: 'Ảnh mặt trước CMND/CCCD',
                    name: 'image_identity_before',
                    error: 'Vui nhập ảnh mặt trước cmnd/cccd',
                    required: false
                });

                image_identity_after = __el.form.find('#image_identity_after_ele').uploadImageSimple({
                    label: 'Ảnh mặt sau CMND/CCCD',
                    name: 'image_identity_after',
                    error: 'Vui nhập ảnh mặt sau cmnd/cccd',
                    required: false
                });

                document = $('#document-image').uploadImageSimple({
                    label: 'Hình ảnh chứng từ hợp đồng',
                    name: 'documents',
                    error: 'Vui nhập ảnh ',
                    required: false,
                    multiple:true,
                    max: 4
                });


                flatpickr(__el.form.find('input[name="birthday"]'), {
                    allowInput: true,
                    enableTime: false,
                    dateFormat: "d/m/Y",
                    locale: 'vn'
                });

                flatpickr(__el.form.find('input[name="identity_date"]'), {
                    allowInput: true,
                    enableTime: false,
                    dateFormat: "d/m/Y",
                    locale: 'vn'
                });

                image_identity_after.setValue(null);
                image_identity_before.setValue(null);
                document.setValue(null);

                // Tải thông tin thành phố, quận, phường.
                $.transferData({
                    method: "GET",
                    url: __helper.url.urlPattern(__routeApi.location.provinces),
                    loadingEle : false,
                    success: (res) => {
                        __el.modal.find(".province").empty();
                        __el.modal.find(".province").append(`<option value=''>Chọn Tỉnh/Thành phố</option>`);
                        $.each(res.data, function(key, value) {
                            __el.modal.find(".province").append(`<option value='${value.id}'>${value.short_name}</option>`);
                        });
                    },
                });

                loadRoom();
                setDefaultForm();
            },
            __submitModalForm:function (e) {
                let data = __el.form.getObjectOfForm();
                data.room_id = roomData?.id ?? 0;
                data.checkPage = 'contract';

                if (!__el.form.get(0).checkValidity()) {
                    __el.form.get(0).classList.add('was-validated');
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Vui lòng nhập đầy đủ thông tin trước khi thực hiện",
                        icon: 'error',
                        confirmButtonColor: '#3c9e47',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                if(!data?.room_id){
                    Swal.fire({
                        title: 'Thông báo!',
                        text: `Vui lòng chọn một ${__current_block?.room_type_name ?? ''} để lập hợp đồng`,
                        icon: 'error',
                        confirmButtonColor: '#3c9e47',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                // Xử lý dịch vụ trước khi gửi lên server
                let priceItems = [];
                let current_price_item_form = __el.form?.getObjectOfForm()?.price_items;

                if (data.price_items && current_price_item_form) {
                    Object.keys(current_price_item_form).map((price_item_id) => {
                        let searchItem = __helper.array.findObjectInArray(price_item_id, 'id', block_price_item);
                        if (searchItem && parseInt(current_price_item_form[searchItem.id]?.is_selected)) {
                            if (searchItem.subtraction) {
                                searchItem.value = [0, 0];
                                searchItem.value[1] = parseInt(current_price_item_form[searchItem.id]['value'][1] ?? '0');
                                searchItem.value[0] = parseInt(current_price_item_form[searchItem.id]['value'][0] ?? '0');
                            } else {
                                searchItem.value = [0];
                                searchItem.value[0] = parseInt(current_price_item_form[searchItem.id]['value'][0] ?? '0');
                            }
                            priceItems.push(searchItem);
                        }
                    });
                    data.price_items = priceItems;
                } else {
                    data.price_items = null;
                }

                let assets = [];
                let current_asset_form = __el.form?.getObjectOfForm()?.assets;
                if (data.assets && current_asset_form) {
                    Object.keys(current_asset_form).map((asset_id) => {     
                        let searchItem = __helper.array.findObjectInArray(asset_id, 'id', block_asset);                   
                        if (parseInt(current_asset_form[asset_id]?.is_selected)) {
                            searchItem.quantity_room = 0;
                            searchItem.quantity_room = parseInt(current_asset_form[asset_id]['quantity']);
                            assets.push(searchItem);
                        }
                    });
                    data.assets = assets;
                } else {
                    data.assets = null;
                }

                // Thêm hình ảnh vào data
                data.image_identity_before = image_identity_before?.value ?? null;
                data.image_identity_after = image_identity_after?.value ?? null;
                data.documents = document.value ?? null;

                // Thêm chi tiết địa chỉ
                let arr_address = [
                    __el.modal.find(".address_detail").val().length > 0 ?  __el.modal.find(".address_detail").val() : null,
                    __el.modal.find(".ward option:selected").val() ? __el.modal.find(".ward option:selected").text() : null,
                    __el.modal.find(".district option:selected").val() ? __el.modal.find(".district option:selected").text() : null,
                    __el.modal.find(".province option:selected").val() ? __el.modal.find(".province option:selected").text() : null,
                ];
                var filteredArr = arr_address.filter(function (value) {
                    return value !== null;
                });

                data.address_component['address'] = filteredArr.join(', ');

                $.transferData({
                    method: "POST",
                    url: __helper.url.urlPattern(__routeApi.contract.store, {
                        room_id: data.room_id
                    }),
                    data,
                    success: function (res) {
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đóng'
                        }).then((result) => {
                            bootstrap.Modal.getInstance(__el.modal.get(0)).hide();

                            console.log(res.data);

                            res.data &&
                            window.contractTable &&
                            window.contractTable.addData([res.data] , true);
                        });
                    },
                    fail: function (res) {
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                })
            }
        });
    });
</script>
<!-- Modal deposit temp -->
<div class="modal fade" data-bs-backdrop="static"  id="priceItemSelect" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                <i data-feather="inbox"> </i>
                </div>
                <h5 class="modal-title">Chỉnh sửa dịch vụ sử dụng <span class="room-name">Tên phòng</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="price-item-selec-form" novalidate>
                    <div class="list-price-item-render price-items-checkout-layout">
                        
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="submit-price-item-select" class="btn btn-primary">
                    Áp dụng dịch vụ
                </button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function () {
        let __el = {
            price_item_render: $('#price-item-selec-form .list-price-item-render'),
            form: $('#price-item-selec-form'),
            modal: $("#priceItemSelect"),
            submit: $('#submit-price-item-select')
        };

        let cell = null;
        let roomData = null;
        let room_price_item_start = null;
        let room_price_item_save = null;

        let block_price_item = JSON.parse(JSON.stringify([{"id":23351,"name":"Ti\u1ec1n \u0111i\u1ec7n","type":"constant","unit":"kwh","price":1700,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"ele","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"KWh","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1},{"id":23352,"name":"Ti\u1ec1n n\u01b0\u1edbc","type":"constant","unit":"khoi","price":18000,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"water","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"Kh\u1ed1i","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1}]));

        new __modalForm(
            __el.modal.get(0),
            __el.form.get(0),
            __el.submit.get(0)
        ).start(null, {
            __openModalForm: function ({relatedTarget}) {
                cell = relatedTarget?.cell ?? null;
                roomData = relatedTarget?.cell?.getData() ?? null;
                room_price_item_start = JSON.parse(JSON.stringify(__preparePriceItems(roomData.price_items ?? null, roomData ?? null))) ?? [];

                __el.modal.find(".room-name").text(`"${roomData.name}"`);

                if(room_price_item_start){
                    
                    __el.price_item_render.html('');

                    Array.isArray(block_price_item) &&
                    block_price_item.length > 0 &&
                    block_price_item.map((item, key)=> {
                        let container = $(`<div class="item">`);
                        let checkNameContainer = $(`<div class="item-check-name">`);

                        let hasItem = true;    
                        let itemUse =  __helper.array.findObjectInArray(item.id, 'id', room_price_item_start);
                        if(!itemUse) {
                            itemUse = item;
                            hasItem = false;
                        }

                        let itemValue = __getDefaultPriceItemsValue(itemUse, roomData);

                        checkNameContainer.append(`<input class="form-check-input" type="hidden" value="${itemUse.id}" name="price_items[${itemUse.id}][id]">`);
                        checkNameContainer.append(`<input class="form-check-input" type="checkbox" id="check_price_item_select_${itemUse.id}" value="1" ${hasItem ? 'checked':''} name="price_items[${itemUse.id}][is_selected]">`);

                        if(itemUse.type === 'frame' && !__helper.checkType.isEmpty(itemUse.frames)){
                            checkNameContainer.append(`<label for="check_price_item_select_${itemUse.id}"><b>${itemUse.name}</b>`+
                                $.map(itemUse.frames, function(frame, key) {
                                    return `<div> ${ parseInt(key) !== 0 ? itemUse.frames[parseInt(key)-1]['volume'] : 0 } - ${frame.volume}, Giá: <b>${__format.currency(frame.price)}/${itemUse.unit_text}</b></div>`
                                }).join('')
                            + "</label>")
                        }else{
                            checkNameContainer.append(`<label for="check_price_item_select_${itemUse.id}"><b>${itemUse.name}</b> <p>Giá: <b>${__format.currency(itemUse.price)}</b> / ${itemUse.unit_text}</p> </label>`);
                        }

                        let valueContainer = $('<div class="item-value">');
                        if(itemUse.subtraction){
                            valueContainer.append(`<div class="input-group mb-2  "><input class="form-control" min="0" id="price_item_select_${itemUse.id}_0"  type="number" placeholder="Nhập số cũ" oninput="$(price_item_select_${itemUse.id}_1).val(this.value)" value="${itemValue[0] ?? ''}" name="price_items[${itemUse.id}][value][]"><label class="input-group-text" for="bill_price_item_${itemUse.id}_0">Chỉ số<br>hiện tại</label></div>`);
                            valueContainer.append(`<div class="input-group d-none"><input class="form-control" min="0" id="price_item_select_${itemUse.id}_1" type="number" placeholder="Nhập số mới" oninput="$(price_item_select_${item.id}_0).val(this.value)" value="${itemValue[1] ?? ''}" name="price_items[${itemUse.id}][value][]"> <label class="input-group-text" for="bill_price_item_${itemUse.id}_1">Số mới</label></div>`);
                        }else{
                            valueContainer.append(`<div class="input-group"><input class="form-control" min="0" type="number" id="price_item_select_${itemUse.id}" placeholder="Nhập giá trị" value="${itemValue[0] ?? ''}" name="price_items[${itemUse.id}][value][]"> <label class="input-group-text" for="bill_price_item_${itemUse.id}">${itemUse.unit_text}</label></div>`);
                        }
                        
                        __el.price_item_render.append(container.append(checkNameContainer).append(valueContainer));
                    });
                }else{
                    __el.price_item_render.html('<div class="text-center" style="color: red">Không có dịch vụ nào</div>');
                }
            },
            __submitModalForm: function (e) {
                let data = __el.form.getObjectOfForm();
                if (!__el.form.get(0).checkValidity()) {
                    __el.form.get(0).classList.add('was-validated');
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Vui lòng nhập đầy đủ thông tin trước khi thực hiện",
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                let priceItems = {
                    count: 0,
                    currentPriceItem: [],
                    total: 0
                };

                let current_price_item_form = __el.form?.getObjectOfForm()?.price_items;

                if(block_price_item && current_price_item_form){
                    Object.keys(current_price_item_form).map((price_item_id)=>{
                        let searchItem = __helper.array.findObjectInArray(price_item_id, 'id', block_price_item);
                        if(searchItem && parseInt(current_price_item_form[searchItem.id]?.is_selected)){

                            let valueDefault = __getDefaultPriceItemsValue(searchItem, roomData);
                            searchItem.value = valueDefault;

                            priceItems.count+=1;

                            if(searchItem.subtraction){
                                let subtraction = parseInt(__helper.convertStringToNumber(current_price_item_form[searchItem.id]['value'][1] ?? '0')) - parseInt(__helper.convertStringToNumber(current_price_item_form[searchItem.id]['value'][0] ?? '0'));

                                priceItems.total+= (subtraction > 0 ? subtraction:0) * searchItem.price;

                                searchItem.value[1] = parseInt(__helper.convertStringToNumber(current_price_item_form[searchItem.id]['value'][1] ?? '0'));
                                searchItem.value[0] = parseInt(__helper.convertStringToNumber(current_price_item_form[searchItem.id]['value'][0] ?? '0'));
                            }else{
                                priceItems.total+= parseInt(__helper.convertStringToNumber(current_price_item_form[searchItem.id]['value'][0] ?? '0')) * searchItem.price;

                                searchItem.value = [parseInt(__helper.convertStringToNumber(current_price_item_form[searchItem.id]['value'][0] ?? '0'))];
                            }

                            priceItems.currentPriceItem.push(searchItem);
                        }
                    });
                    room_price_item_save = priceItems.currentPriceItem;
                }else{
                    room_price_item_save = null;
                }

                let data_save = {
                    ...roomData,
                    price_items: room_price_item_save
                };

                $.transferData({
                    method: "POST",
                    url: __helper.url.urlPattern(__routeApi.room.update, {
                        room_id: roomData.id
                    }),
                    data: data_save,
                    textLoading: 'Đang lưu thông tin dịch vụ...',
                    success: function (res) {
                        Swal.fire({
                            title: 'Thành công!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đóng'
                        }).then((result)=>{
                            bootstrap.Modal.getInstance(__el.modal.get(0)).hide();

                            cell.getRow().update(data_save);
                        });
                    },
                    fail: (res)=>{
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            }
        });    
    });
</script>
<!-- Modal add new session -->
<div class="modal fade" data-bs-backdrop="static"  id="terminateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                    <i data-feather="log-out"> </i>
                </div>
                <h5 class="modal-title">Kết thúc hợp đồng - <span class="room-name">Tên phòng</span> </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="terminate-form" novalidate>
                    <input type="hidden" name="_token" value="CZqXP04OzKEuLEt01gkxMY2DrN3sCqnCK8eSZ2o4">                    <div class="row g-2">
                        <div class="terminate-setting">
                            <div class="col-12">
                                <div class="input-group">
                                    <div class="form-floating">
                                        <input type="text" class="form-control date-flat-picker"
                                            name="date_tick_terminate" id="date_terminate_form"
                                            placeholder="Ngày kết thúc hợp đồng"
                                            data-format="date" required>
                                        <label for="date_terminate_form">Ngày kết thúc hợp đồng</label>
                                    </div>
                                    <label class="input-group-text" for="date_terminate_form">
                                        <i data-feather="calendar"> </i>
                                    </label>
                                </div>
                                <div class="invalid-feedback">
                                    Vui lòng nhập này kết thúc hợp đồng
                                </div>
                            </div>
                            <div class="col-12 mt-2">
                                <div class="loz-alert info">
                                    <div class="icon flex-0">
                                        <i data-feather="info"> </i>
                                    </div>
                                    <div class="des flex-1">
                                        <b>Thông tin:</b>
                                        <p>- Kết thúc hợp đồng là hành động kết thúc khi khách muốn chuyển đi. Sau khi kết thúc bạn có thể "Lập hợp đồng" cho khách mới</p>
                                        <p>- Các thông tin như <b>Khách thuê, hợp đồng cũ</b> sẽ xóa bỏ để sẳn sàng cho hợp đồng mới.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="terminate-info">
                            <div class="info-cancel-terminate d-flex"
                                style="background-color: #ff572247; border: 1px solid #ff5722;border-radius: 5px; padding: 10px;">
                                <i data-feather="alert-triangle"> </i>
                                <div style="margin-left: 20px">
                                    <h6>Khách thuê đã báo kết thúc hợp đồng vào <span
                                            class="date-tick-terminate">00/00/0000</span> trước đó</h6>
                                    <p>Nhấn vào "kết thúc hợp đồng" để kết thúc ngay ngay bây giờ</p>
                                </div>
                            </div>
                        </div>

                        <div id="task-container"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="submit-terminate" class="btn btn-primary">
                    <i data-feather="plus"> </i>
                    Kết thúc
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal deposit temp -->
<style type="text/css">
    #billDetail .item.d-flex.justify-content-between {
        padding: 10px;
    }
    #billDetail .item.d-flex.justify-content-between:not(:last-child) {
        border-bottom: 0.5px solid #ccc;
    }
</style>
<div class="modal fade" data-bs-backdrop="static" id="billDetail" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                <i data-feather="file-text"> </i>
                </div>
                <h5 class="modal-title">Chi tiết hóa đơn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="position: relative; display: grid;">
                <div class="bill-detail-loading" style="position: absolute;
                width: 100%;
                height: 100%;
                background-color: #00000030;
                align-items: center;
                justify-content: center;
                display: flex;">
                    <div class="text-center" style="padding: 20px">
                        <img style="margin: auto" src="https://quanlytro.me/images/icons/loading.gif" alt="Đang tải..." width="50px"/>
                        <div>
                            <i class="loading_text" style="font-size: 13px; margin-top: -10px;">Đang tải thông báo...</i>
                        </div>
                    </div>
                </div>
                <form method="POST" class="needs-validation" id="bill-detail-form" novalidate>
                    <div class="row mt-2 bill-detail">
                        <div class="col-12">
                            <div style="border: 0.5px solid #ccc; border-radius: 10px;">
                                <div class="item d-flex justify-content-between">
                                    <span>Ngày tạo hóa đơn</span><b class="bill-date"></b>
                                </div>
                                <div class="item d-flex justify-content-between">
                                    <span>Ly do thu tiền</span><b class="bill-reason"></b>
                                </div>
                                <div class="item d-flex justify-content-between">
                                    <span>Số điện thoại liên hệ</span><b class="bill-phone"></b>
                                </div>
                                <div class="item d-flex justify-content-between">
                                    <span>Tình trạng</span><span style="background-color: #000" class="badge bill-status"></span>
                                </div>
                                <div class="item justify-content-between" style="padding: 10px; border-bottom: 0.5px solid #ccc;">
                                    <div class="d-flex justify-content-start" style="margin-bottom: 10px">
                                        <i style="margin-right: 5px" data-feather="file-text"> </i>
                                        <b>Danh mục tính tiền</b>
                                    </div>
                                    <div>
                                        <div class="item-bill-room-amount" style="background-color: #eee; margin-bottom: 10px; border-radius: 7px">
                                            <div class="item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div>Tiền thuê</div>
                                                    <div>
                                                        <b class="detail-room-amount">
                                                            30 ngày x 2.000.000đ
                                                        </b>
                                                    </div>
                                                </div>
                                                <b class="total_room_amount">2.200.000đ</b>
                                            </div>
                                        </div>

                                        <div class="item-bill-deposit" style="background-color: #eee; margin-bottom: 10px; border-radius: 7px">
                                            <div class="item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="label-deposit">Tiền cọc</div>
                                                </div>
                                                <b class="deposit_contract_amount">2.200.000đ</b>
                                            </div>
                                            <div class="item-bill-pre-deposit item d-flex justify-content-between align-items-center" style="font-size: 12px;
                                            color: gray;">
                                                <div>
                                                    <div class="label-pre-deposit">Tiền cọc đã thu trước</div>
                                                </div>
                                                <b class="pre_deposit_contract_amount">0 đ</b>
                                            </div>
                                        </div>
                                        
                                        <div class="item-bill-price-item" style="background-color: #eee; margin-bottom: 10px; border-radius: 7px">
                                            <div class="item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div>Tiền dịch vụ</div>
                                                </div>
                                                <b class="total_price_item">2.200.000đ</b>
                                            </div>
                                        </div>
                                        <div class="item-bill-addition" style="background-color: #eee; margin-bottom: 10px; border-radius: 7px">
                                            <div class="item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <div class="addition_text">Giảm trừ</div>
                                                </div>
                                                <b class="addition_value">2.200.000đ</b>
                                            </div>
                                        </div>
                                    </div>   
                                </div>

                                <div class="item d-flex justify-content-between">
                                    <span>Giá trị hóa đơn</span><b class="bill-value"></b>
                                </div>
                                <div class="item d-flex justify-content-between">
                                    <span class="bill-paid-total-text">Đã thu</span><b class="bill-paid-total"></b>
                                </div>
                                <div class="item d-flex justify-content-between">
                                    <span>Tổng số lần thu</span><b><b class="bill-count_pay_bill"></b> Lần</b>
                                </div>
                            </div>
                        </div>
                        <div class="bill-history">
                            <div class="col-12 mt-2 mb-2">
                                <div class="title-item-small">
                                    <b>Lịch sử thu tiền</b>
                                </div>
                            </div>
                            <div class="col-12">
                                <div style="border: 0.5px solid #ccc; border-radius: 10px;">
                                <div class="history-pay">
                                    
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                   
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        let __el ={
            modal_bill_detail: $("#billDetail")
        };
        
        __el.modal_bill_detail.get(0).addEventListener('shown.bs.modal', function (e) {
            if(!e?.relatedTarget?.bill_id){
                Swal.fire({
                    title: 'Thông báo!',
                    text: 'Không chỉ định thông tin hóa đơn!',
                    icon: 'error',
                    confirmButtonText: 'Đã hiểu'
                });
                return false;
            }

            $.transferData({
                method: "GET",
                url: __helper.url.urlPattern(__routeApi.bill.show, {
                    id: parseInt(e?.relatedTarget?.bill_id)
                }),
                loadingEle:__el.modal_bill_detail.find('.bill-detail-loading'),
                textLoading: 'Đang tải chi tiết hóa đơn...',
                success: (res) => {
                    let bill = res.data;
                    //@TODO: show price item....
                    __el.modal_bill_detail.find('.bill-date').text(bill.date_format);
                    // Xử lý tiền thuê nhà
                    if(bill.total_room_amount > 0){
                        __el.modal_bill_detail.find('.item-bill-room-amount').show();
                        __el.modal_bill_detail.find('.detail-room-amount').text(`${bill.total_day} ngày x ${__format.currency(bill.room_amount_unit)}`);
                        __el.modal_bill_detail.find('.total_room_amount').text(`${__format.currency(bill.total_room_amount)}`);
                    }else{
                        __el.modal_bill_detail.find('.item-bill-room-amount').hide();
                    }

                    // Xử lý tiền cọc
                    if(bill.deposit_contract_amount){
                        __el.modal_bill_detail.find('.item-bill-deposit').show();
                        if(bill.deposit_contract_amount > 0){
                            __el.modal_bill_detail.find('.label-deposit').text("Thu tiền cọc");
                            __el.modal_bill_detail.find('.deposit_contract_amount').text(__format.currency(bill.deposit_contract_amount));
                            
                        }else{
                            __el.modal_bill_detail.find('.label-deposit').text("Trả tiền cọc");
                            __el.modal_bill_detail.find('.deposit_contract_amount').text(`${__format.currency(bill.deposit_contract_amount)}`);
                        }
                    }else{
                        __el.modal_bill_detail.find('.item-bill-deposit').hide();
                    }

                       // Xử lý tiền cọc giữ chỗ
                       if(parseInt(bill.pre_deposit_contract_amount) > 0){
                        __el.modal_bill_detail.find('.item-bill-pre-deposit').show();
                        __el.modal_bill_detail.find('.label-pre-deposit').text("Tiền cọc đã thu trước");
                        __el.modal_bill_detail.find('.pre_deposit_contract_amount').text(__format.currency(bill.pre_deposit_contract_amount));
                    }else{
                        __el.modal_bill_detail.find('.item-bill-pre-deposit').hide();
                    }

                    // Xử lý tiền dịch vụ
                    if(bill.total_price_item > 0){
                        __el.modal_bill_detail.find('.item-bill-price-item').show();
                        __el.modal_bill_detail.find('.total_price_item').text(`${__format.currency(bill.total_price_item)}`);
                    }else{
                        __el.modal_bill_detail.find('.item-bill-price-item').hide();
                    }

                    // Xử lý tiền giảm trừ/cộng thêm
                    if(bill.addition != 0){
                        __el.modal_bill_detail.find('.item-bill-addition').show();
                        bill.addition === 1 ?  __el.modal_bill_detail.find('.addition_text').text('Cộng thêm') : __el.modal_bill_detail.find('.addition_text').text('Giảm trừ')
                        __el.modal_bill_detail.find('.addition_value').text(`${__format.currency(bill.addition_value)}`);
                    }else{
                        __el.modal_bill_detail.find('.item-bill-addition').hide();
                    }
                    
                    bill.total > 0 ? __el.modal_bill_detail.find('.bill-paid-total-text').text('Đã thu') : __el.modal_bill_detail.find('.bill-paid-total-text').text('Đã hoàn lại');
                    __el.modal_bill_detail.find('.bill-phone').text(bill?.room?.customers[0]?.phone);
                    __el.modal_bill_detail.find('.bill-value').text(__format.currency(bill.total));
                    __el.modal_bill_detail.find('.bill-paid-total').text(__format.currency(bill.paid_total));

                    __el.modal_bill_detail.find('.bill-reason').text(bill.reason);
                    __el.modal_bill_detail.find('.bill-count_pay_bill').text(bill.count_pay_bill);

                    if(bill.payBills.length > 0){
                        __el.modal_bill_detail.find('.bill-history').show();
                        $.each(bill.payBills, function(index, item) {
                            __el.modal_bill_detail.find('.history-pay').append(`
                            <div class="item d-flex justify-content-between">
                                <span>Ngày thu</span><span class="bill-pay-date">${item.created_at_format}</span>
                            </div>
                            <div class="item d-flex justify-content-between">
                                <span>Số tiền thu</span><span class="bill-pay-date">${__format.currency(item.paid_total)}</span>
                            </div>
                            `)
                        });
                    }else{
                        __el.modal_bill_detail.find('.bill-history').hide();
                    }
                },
            });
        });

        __el.modal_bill_detail.get(0).addEventListener('hide.bs.modal', function (e) {
            __el.modal_bill_detail.find('.history-pay .item').remove();
            __el.modal_bill_detail.find('.bill-date').text('');
        });
    });
</script>

<script type="text/javascript">
    $(document).ready(function() {
        let __el = {
            form: $('#terminate-form'),
            modal: $("#terminateModal"),
            submit: $("#submit-terminate"),
            modal_bill_detail: $("#billDetail")
        };

        let cell = null;
        let roomData = null;
        let tasks = [];
        let taskChecked = [];
        let modal_bill_detail = bootstrap.Modal.getInstance(__el.modal_bill_detail.get(0)) || new bootstrap.Modal(__el.modal_bill_detail.get(0), null);

        flatpickr(__el.form.find('input[name="date_tick_terminate"]'), {
            defaultDate: 'today',
            allowInput: true,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn'
        });

        const doTask = (action_name, key, data) => {
            if (!tasks?.length || tasks?.length === 0) {
                Swal.fire({
                    title: 'Thông báo lỗi!',
                    text: 'Không có công việc cần thực hiện',
                    icon: 'warning',
                    confirmButtonColor: '#3c9e47',
                    confirmButtonText: 'Đã hiểu'
                });
                return;
            }

            if (typeof tasks[key] === 'undefined' || (tasks[key] && tasks[key].done === 1)) {
                Swal.fire({
                    title: 'Thông báo lỗi!',
                    text: 'Công việc đã được thực hiện!',
                    icon: 'warning',
                    confirmButtonColor: '#3c9e47',
                    confirmButtonText: 'Đã hiểu'
                });
                return;
            }

            if (['bill_collect', 'bill_return'].includes(action_name)) {
                $.transferData({
                    url: __helper.url.urlPattern(__routeApi.billPay.store, {
                        bill_id: data.id
                    }),
                    method: 'POST',
                    textLoading: action_name === 'bill_collect' ? 'Đang thu tiền...' :
                        'Đang hoàn trả tiền...',
                    data: {
                        bill_id: data.id,
                        block_id: data.block_id,
                        room_id: data.room_id,
                        paid_amount: Math.abs(data.remain_total),
                        is_refund_amount: 1,
                        payment_method: 'cash',
                        type: action_name,
                    },
                    success: (res) => {
                        taskChecked.push(res.data.action);
                        tasks[key].done = 1;
                        renderTask(tasks);
                        //@TODO: Yêu cầu server trả lại room và cập nhật bảng
                    },
                    fail: (res) => {
                        Swal.fire({
                            title: 'Thông báo lỗi!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        });
                    },
                    error: (e) => {
                        Swal.fire({
                            title: 'Thông báo lỗi!',
                            text: e,
                            icon: 'error',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        });
                    },
                });
            } else if (['terminate_deposit_contract', 'bill_terminate', 'check_asset'].includes(action_name)) {
                taskChecked.push(action_name);
                tasks[key].done = 1;
                renderTask(tasks);
            } else {
                Swal.fire({
                    title: 'Thông báo lỗi!',
                    text: 'Đã có sự nhầm lẫn! Vui lòng báo cho nhà cung cấp dịch vụ để được khắc phục',
                    icon: 'error',
                    confirmButtonColor: '#3c9e47',
                    confirmButtonText: 'Đã hiểu'
                });
            }
        };

        const renderDataTaskItem = (action_name, data) => {
            if(!data){
                return $('<span></span>');
            }
            let container = $(`<div class="data">`);
            if (action_name === 'bill_collect') {
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Số tiền cần thu:</div><b>${__format.currency(data.remain_total)}</b></div>`
                    );
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Kỳ thu:</div><b>${data.month}/${data.year}</b></div>`
                    );
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Lý do phiếu thu:</div><b>${data.reason}</b></div>`
                    );
            }

            if (action_name === 'bill_return') {
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Số tiền hoàn</div><b>${__format.currency(data.remain_total)}</b></div>`
                    );
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Lý do</div><b>Hoàn tiền lại cho khách thuê</b></div>`
                    );
            }

            if (action_name === 'terminate_deposit_contract') {
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Người đặt cọc</div><b>${data.customer_name}</b></div>`
                    );
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Số tiền đặt cọc</div><b>${__format.currency(data.deposit_contract_amount)}</b></div>`
                    );
            }

            if (action_name === 'terminate_deposit_temp') {
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Người đặt cọc</div><b>${data.customer_name}</b></div>`
                    );
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Số tiền đặt cọc giữ chỗ</div><b>${__format.currency(data.deposit_temp_amount)}</b></div>`
                    );
            }

            if (action_name === 'debt_amount') {
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Số tiền khách thuê nợ</div><b>${__format.currency(data.debt_amount)}</b></div>`
                    );
            }

            if (action_name === 'my_debt_amount') {
                container.append(
                    `<div class="item d-flex justify-content-between"><div>Số tiền bạn nợ khách</div><b>${__format.currency(data.debt_amount)}</b></div>`
                    );
            }
            return container;
        };

        const renterButtomTaks = function(item, key){
            if(item.done !== 0)
                return $(`<span> </span>`);

            if(item.action === 'bill_terminate'){
                return $(`<div class="row g-2">`).append(
                            $(`<div class="col-md-5">`).append($(`<button type="button" class="btn btn-white" style="margin-top: 10px; width: 100%">${feather.icons['alert-circle'].toSvg({width: 20, height: 20})} ${item.name}</button>`).click((e) => {
                                doTask(item.action, key, item.data);
                                renderTask(tasks ?? null)
                            }))
                        ).append(
                            $(`<div class="col-md-7">`).append($(`<button type="button" class="btn btn-primary" style="margin-top: 10px; width: 100%">Tạo hóa đơn tháng cuối</button>`).click((e) => {
                                    e.preventDefault();

                                    var addBill = bootstrap.Modal.getInstance(document.getElementById('addBill')) ?? new bootstrap.Modal(document.getElementById('addBill'), null);
                                    
                                    let dataFrom = __el.form.getObjectOfForm();
                                    let date_tick_terminate = dataFrom?.date_tick_terminate ?? null;

                                    addBill.show({
                                        cell: cell,
                                        __type: 'terminate',
                                        reason_id: 3,
                                        date_to: date_tick_terminate ? (new Date(date_tick_terminate)).getTime() : null
                                    });

                                    bootstrap.Modal.getInstance(__el.modal.get(0)).hide();

                                    return false;
                            }))
                        );
            }else if(item.action === 'bill_collect'){
                return $(`<div class="row g-2">`).append(
                    $(`<div class="col-md-5">`).append($(`<button type="button" class="btn btn-white" style="margin-top: 10px; width: 100%">${feather.icons['file-text'].toSvg({width: 20, height: 20})} Xem</button>`).click((e) => {
                        e.preventDefault();

                        let date_tick_terminate = __el.form.find('input[name="date_tick_terminate"]').val();
                        let cellOld = cell;
                        let tasksOld = tasks;
                        let taskCheckedOld = taskChecked;

                        let showModal = function (e) {
                            __modalFormTerminate.show({
                                cell: cellOld,
                                tasks: tasksOld,
                                taskChecked: taskCheckedOld,
                                date_tick_terminate: date_tick_terminate
                            });
                            __el.modal_bill_detail.get(0).removeEventListener('hide.bs.modal', showModal);
                        };

                        let __modalFormTerminate = bootstrap.Modal.getInstance(__el.modal.get(0)) || new bootstrap.Modal(__el.modal.get(0), null);
                        __el.modal_bill_detail.get(0).addEventListener('hide.bs.modal', showModal);

                        __modalFormTerminate.hide();

                        modal_bill_detail.show({
                            bill_id: item.data.id
                        });
                        return false;
                    }))
                ).append(
                    $(`<div class="col-md-7">`).append($(`<button type="button" class="btn btn-primary" style="margin-top: 10px; width: 100%">${feather.icons['dollar-sign'].toSvg({width: 20, height: 20})} Thu tiền nhanh</button>`).click((e) => {
                        doTask(item.action, key, item.data);
                        renderTask(tasks ?? null) 
                    }))
                );
            }else{
                return $(`<button type="button" class="btn btn-primary" style="margin-top: 10px; width: 100%">${item.name}</button>`).click((e) => {
                            doTask(item.action, key, item.data);
                            renderTask(tasks ?? null)
                        });
            }    
        };

        const renderTask = function() {
            if(!tasks || (tasks && tasks.length===0)){
                __el.form.find('#task-container').html('<div>Không có việc cần</div>');
                return false;
            }
            __el.form.find('#task-container').html('');    
            __el.form.find('#task-container').append(
                    $(`<h5 class="title text-center mt-3">
                            Công việc cần làm trước khi kết thúc hợp đồng
                            <p>(${taskChecked.length}/${tasks.length})</p>
                       </h5>`)
            );
            tasks.map((item, key) => {
                __el.form.find('#task-container').append(
                    $(`<div class="task-item d-flex">`).append(
                        $(`<div class="flex-shrink-1">`).append(
                            item.done !== 1 ?
                            $(`<div class="icon doing">${feather.icons['x'].toSvg()}</div>`) :
                            $(`<div class="icon done">${feather.icons['check'].toSvg()}</div>`)
                        )
                    ).append(
                        $(`<div class="item flex-shrink-1" style="flex: 1">`).append(
                            $(`<h6 class="label">${item.label}</h6>${item.require ? '<p style="font-style: italic; color: red">Công việc bắt buộc thực hiện</p>': ''}`)
                        ).append(
                            $(`<p class="des">${item.description}</p>`)
                        ).append(
                            renderDataTaskItem(item.action, item.data)
                        ).append(
                            renterButtomTaks(item, key)
                        )
                    )
                );
            });
        };

        const loadTask = function() {
            $.transferData({
                url: __helper.url.urlPattern(__routeApi.terminate.tasks, {
                    room_id: roomData.id
                }),
                textLoading: 'Đang tải việc cần làm...',
                success: (res) => {
                    tasks = res?.data?.tasks ?? [];
                    renderTask();
                },
                fail: res => {
                    tasks = [];
                    Swal.fire({
                        title: 'Thông báo!',
                        text: res.message,
                        icon: 'error',
                        confirmButtonColor: '#3c9e47',
                        confirmButtonText: 'Đã hiểu'
                    })
                }
            });
        };

        new __modalForm(
            __el.modal.get(0),
            __el.form.get(0),
            __el.submit.get(0),
        ).start(null, {
            __openModalForm: function({relatedTarget}) {

                cell = relatedTarget?.cell ?? null;
                roomData = relatedTarget?.cell?.getData() ?? null;

                tasks = relatedTarget?.tasks ?? [];
                taskChecked = relatedTarget?.taskChecked ?? [];

                __el.form.find('.terminate-info').hide();
                __el.form.find('.terminate-setting').show();
                __el.form.find('input[name="date_tick_terminate"]').attr('readonly',false);
                __el.form.find('input[name="date_tick_terminate"]').get(0)._flatpickr.setDate(relatedTarget?.date_tick_terminate ?? new Date(), true, "d/m/Y");
                
                roomData &&
                __el.modal.find('.room-name').text(roomData.name);

                if(tasks?.length === 0){
                    loadTask();
                }
            },
            __closeModalForm: function() {
                tasks = [];
                taskChecked = [];
            },
            __submitModalForm: function(e) {
                let data = __el.form.getObjectOfForm();

                if (!__el.form.get(0).checkValidity()) {
                    __el.form.get(0).classList.add('was-validated');
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Vui lòng nhập đầy đủ thông tin trước khi thực hiện",
                        icon: 'error',
                        confirmButtonColor: '#3c9e47',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return;
                }

                if (tasks?.length > 0 && taskChecked.length !== tasks.length) {
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Phải hoàn thành các công việc trước khi thực hiện",
                        icon: 'error',
                        confirmButtonColor: '#3c9e47',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return;
                }

                data.type = 'terminate';
                data.room_id = roomData.id;
                data.taks = tasks;
                data.taskChecked = taskChecked;

                $.transferData({
                    method: "POST",
                    url: __helper.url.urlPattern(__routeApi.terminate.store, {
                        room_id: data.room_id
                    }),
                    data: data,
                    success: function(res) {
                        Swal.fire({
                            title: 'Thành công!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        }).then((result) => {
                            bootstrap.Modal.getInstance(__el.modal.get(0))
                            .hide();
                            res.data && cell &&
                                cell.getRow().update(res.data);
                        });
                    },
                    fail: function(res) {
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            }
        });
    });
</script>
<!-- Modal add new session -->
<div class="modal fade" data-bs-backdrop="static"  id="extendModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                <i data-feather="log-out"> </i>
                </div>
                <h5 class="modal-title">Gia han hợp đồng - <span class="room-name">Tên phòng</span> </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="extend-form" novalidate>
                    <input type="hidden" name="_token" value="CZqXP04OzKEuLEt01gkxMY2DrN3sCqnCK8eSZ2o4">                    <div class="row g-2">
                 
                            <div class="col-6">
                                <div class="input-group">
                                    <div class="form-floating">
                                        <input type="text" class="form-control date-flat-picker"
                                            name="date_contract" id="date_contract"
                                            placeholder="Gia hạn đền ngày"
                                            data-format="date" required>
                                        <label for="date_contract">Ngày gia hạn</label>
                                    </div>
                                    <label class="input-group-text" for="date_contract">
                                        <i data-feather="calendar"> </i>
                                    </label>
                                </div>
                                <div class="invalid-feedback">
                                    Vui lòng nhập ngày gia hạn
                                </div>
                            </div>

                            <div class="col-6">
                                <div class="input-group">
                                    <div class="form-floating">
                                        <input type="text" class="form-control date-flat-picker"
                                            name="date_terminate" id="date_terminate"
                                            placeholder="Gia hạn đền ngày"
                                            data-format="date" required>
                                        <label for="date_terminate">Gia hạn đến</label>
                                    </div>
                                    <label class="input-group-text" for="date_terminate">
                                        <i data-feather="calendar"> </i>
                                    </label>
                                </div>
                                <div class="invalid-feedback">
                                    Vui lòng nhập ngày muốn gia hạn
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="input-group">
                                    <div class="form-floating">
                                        <input type="text" class="form-control currency" name="room_amount" id="room_amount"
                                               data-format="numeric" min="0"
                                               placeholder="Nhập giá thuê" required>
                                        <label for="room_amount">Giá thuê (đ)</label>
                                        <div class="invalid-feedback">
                                            Vui lòng nhập giá thuê
                                        </div>
                                    </div>
                                </div>
                            </div>
                      
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="submit-extend" class="btn btn-primary">
                    <i data-feather="plus"> </i>
                    Gia hạn
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        let __el = {
            form: $('#extend-form'),
            modal: $("#extendModal"),
            submit: $("#submit-extend")
        };

        let cell = null;
        let roomData = null;

        flatpickr(__el.form.find('input[name="date_terminate"]'), {
            defaultDate: 'today',
            allowInput: true,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn',
            minDate: new Date().fp_incr(+1),
        });

        
        flatpickr(__el.form.find('input[name="date_contract"]'), {
            defaultDate: 'today',
            allowInput: true,
            enableTime: false,
            dateFormat: "d/m/Y",
            locale: 'vn',
            defaultDate:'today',
        });

        let oldDate = __format.dateVn(new Date());

        new __modalForm(
            __el.modal.get(0),
            __el.form.get(0),
            __el.submit.get(0),
        ).start(null, {
            __openModalForm: function({relatedTarget}) {

                cell = relatedTarget?.cell ?? null;
                roomData = relatedTarget?.cell?.getData() ?? null;
                __el.form.find('input[name="room_amount"]').val(roomData.room_amount);
                __el.modal.find('.modal-title').text(
                    `Gia hạn hợp đồng - ${roomData.name}`);
            },
            __closeModalForm: function() {
            },
            __submitModalForm: function(e) {
                let data = __el.form.getObjectOfForm();

                if (!__el.form.get(0).checkValidity()) {
                    __el.form.get(0).classList.add('was-validated');
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Vui lòng nhập đầy đủ thông tin trước khi thực hiện",
                        icon: 'error',
                        confirmButtonColor: '#3c9e47',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return;
                }

                data.contract_id = roomData.contract_id;

                $.transferData({
                    method: "POST",
                    url: __helper.url.urlPattern(__routeApi.contract.extend, {
                        block_id: roomData.block_id
                    }),
                    data: data,
                    success: function(res) {
                        Swal.fire({
                            title: 'Thành công!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        }).then((result) => {
                            bootstrap.Modal.getInstance(__el.modal.get(0))
                            .hide();
                            res.data && cell &&
                                cell.getRow().update(res.data);
                        });
                    },
                    fail: function(res) {
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            }
        });
    });
</script>
<!-- Modal deposit temp -->
<div class="modal fade" data-bs-backdrop="static"  id="documentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                    <i data-feather="image"> </i>
                </div>
                <h5 class="modal-title">Chỉnh sửa chứng từ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="document-form" novalidate>
                    <div class="row mt-2">
                        <div class="col-12 mt-2">
                            <div id="document" class="image-upload-simple">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="submit-document-form" class="btn btn-primary">
                    Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
         $('#document').uploadImageSimple({
            label: 'Hình ảnh chứng từ hợp đồng',
            name: 'documents',
            error: 'Vui nhập ảnh ',
            required: false,
            multiple:true,
            max: 3
        });
    })
</script>
<!-- Modal deposit temp -->
<div class="modal fade" data-bs-backdrop="static"  id="assetSelect" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                <i data-feather="inbox"> </i>
                </div>
                <h5 class="modal-title">Thông tin tài sản <span class="room-name">Tên phòng</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="asset-select-form" novalidate>
                    <div class="list-asset-render asset-checkout-layout">
                        
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="submit-asset-select" class="btn btn-primary">
                    Áp dụng tài sản
                </button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function () {
        let __el = {
            asset_render: $('#asset-select-form .list-asset-render'),
            form: $('#asset-select-form'),
            modal: $("#assetSelect"),
            submit: $('#submit-asset-select')
        };

        let cell = null;
        let contractData = null;
        let api = null;

        let block_asset = JSON.parse(JSON.stringify(null));

        new __modalForm(
            __el.modal.get(0),
            __el.form.get(0),
            __el.submit.get(0)
        ).start(null, {
            __openModalForm: function ({relatedTarget}) {
                cell = relatedTarget?.cell ?? null;
                page_use = relatedTarget?.page_use ?? null;
                data = relatedTarget?.cell?.getData() ?? null;
                if(page_use === 'rooms'){
                    room_asset = data.asset 
                    __el.modal.find(".room-name").text(`"${data.name}"`);

                    api = __helper.url.urlPattern(__routeApi.room.update, {
                        room_id:  parseInt(data.id)
                    })
                }else{
                    room_asset = data.room.asset
                    __el.modal.find(".room-name").text(`"${data.room.name}"`);

                    api = __helper.url.urlPattern(__routeApi.contract.update, {
                        contract_id: parseInt(data.id)
                    })
                }
                
                if(block_asset){
                    __el.asset_render.html('');

                    Array.isArray(block_asset) &&
                    block_asset.length > 0 &&
                    block_asset.map((item, key)=> {
                        let container = $(`<div class="item">`);
                        let checkNameContainer = $(`<div class="item-check-name">`);

                        let itemUse =  __helper.array.findObjectInArray(item.id, 'id', room_asset);

                        let hasItem = false;
                        let itemValue = 1;
                            
                        if(itemUse){
                            hasItem = true;
                            itemValue = itemUse.data.quantity
                        }else{
                            itemUse = item;
                        }

                        checkNameContainer.append(`<input class="form-check-input" type="hidden" value="${itemUse.id}" name="assets[${itemUse.id}][id]">`);
                        checkNameContainer.append(`<input class="form-check-input" type="checkbox" id="check_asset_select_${itemUse.id}" value="1"  ${hasItem ? 'checked':''} name="assets[${itemUse.id}][is_selected]">`);
                        checkNameContainer.append(`<label for="check_asset_select_${itemUse.id}"><b>${itemUse.name}</b><p>Giá: <b>${__format.currency(itemUse.amount)}</b> / ${itemUse.unit}</p></label>`);

                        let valueContainer = $('<div class="item-value">');
                        valueContainer.append(`<div class="input-group"><input class="form-control" min="0" type="number" id="asset_select_${itemUse.id}" placeholder="Nhập số lương" value="${itemValue}" name="assets[${itemUse.id}[quantity]"><label class="input-group-text" for="bill_price_item_${item.id}">Số lượng</label></div>`);

                        __el.asset_render.append(container.append(checkNameContainer).append(valueContainer));
                    });
                }else{
                    __el.asset_render.html('<div class="text-center" style="color: red">Không có tài sản nào!. Vui lòng tạo tài sản ở menu Quản lý tài sản</div>');
                }
            },
            __submitModalForm: function (e) {
                let assets = [];
                let current_asset_form = __el.form?.getObjectOfForm()?.assets;
                
                if (block_asset && current_asset_form) {
                    Object.keys(current_asset_form).map((asset_id) => {     
                        let searchItem = __helper.array.findObjectInArray(asset_id, 'id', block_asset);    
                                       
                        if (parseInt(current_asset_form[asset_id]?.is_selected)) {
                            searchItem.quantity_room = 0;
                            searchItem.quantity_room = parseInt(current_asset_form[asset_id]['quantity']);
                            assets.push(searchItem);
                        }
                    });
                    data.assets = assets;
                } else {
                    data.assets = null;
                }
                
                $.transferData({
                    method: "POST",
                    url: api,
                    data: data,
                    success: (res) => {
                        Swal.fire({
                            title: 'Thao tác thành công!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonText: 'Đã hiểu'
                        }).then((result)=>{
                            bootstrap.Modal.getInstance(__el.modal.get(0)).hide();
                            if (res.data && cell) {
                                cell.getRow().update(res.data);
                            }
                        });
                    },
                    fail: (res) => {
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'warning',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            }
        });    
    });
</script>
                </div>
            </div>
            <!-- Modal manage block -->
 <div class="modal fade" id="manageBlock" tabindex="-1" aria-labelledby="manageBlockLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-header--sticky">
                <i style="margin-right: 15px" data-feather="home"> </i>
                <h5 class="modal-title" id="manageBlockLabel">
                    Danh sách nhà trọ của bạn
                    <p style="font-size: 14px; font-weight: normal; font-style: italic; margin: 0">Tới 1 nhà trọ và quản lý</p>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
            </div>
            <div class="modal-body">
                                    <div class="item-feature active d-flex align-items-center justify-content-between mb-2">
                        <div class="info" style="flex: 1">
                            <h6>Nhà trọ ASUS</h6>
                            <p>63, An Tịnh, Trảng Bàng, Tây Ninh</p>
                        </div>

                                                                                    <div class="btn-round disabled btn-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="Không thể xóa nhà trọ đang thao tác">
                                    <i data-feather="trash-2"> </i>
                                </div>
                                                                            
                                                <div class="btn-round btn-edit"
                                data-bs-toggle="modal"
                                data-bs-target="#addBlock"
                                data-block='{"id":7081,"name":"ASUS","name_full":"Nh\u00e0 tr\u1ecd ASUS","user_id":8151,"category":0,"category_name":"Nh\u00e0 tr\u1ecd","category_name_short":"Nh\u00e0 tr\u1ecd","room_type":"room","room_type_name":"ph\u00f2ng","type":"floors","room_total":6,"count_floor":2,"area":15,"room_amount":36,"ele_amount":0,"water_amount":0,"price_items_cache":[{"id":23351,"name":"Ti\u1ec1n \u0111i\u1ec7n","type":"constant","unit":"kwh","price":1700,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"ele","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"KWh","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1},{"id":23352,"name":"Ti\u1ec1n n\u01b0\u1edbc","type":"constant","unit":"khoi","price":18000,"rooms":[{"id":102158,"name":"Ph\u00f2ng 1","sort":null,"value":102158,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102159,"name":"Ph\u00f2ng 2","sort":null,"value":102159,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102160,"name":"Ph\u00f2ng 3","sort":null,"value":102160,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102161,"name":"Ph\u00f2ng 4","sort":null,"value":102161,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102162,"name":"Ph\u00f2ng 5","sort":null,"value":102162,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"},{"id":102163,"name":"Ph\u00f2ng 6","sort":null,"value":102163,"status":"is_empty","group_id":null,"priority":null,"circle_day":null,"room_amount":null,"status_text":"\u0110ang tr\u1ed1ng","circle_month":null,"active_status":"pending_create_bill","priority_text":"Kh\u00f4ng x\u00e1c \u0111\u1ecbnh","customer_count":null,"active_status_text":"Ch\u1edd k\u1ef3 thu t\u1edbi"}],"value":null,"frames":[],"status":"is_active","history":null,"user_id":8151,"block_id":7081,"category":"water","type_text":"Theo gi\u00e1 tr\u1ecb c\u1ed1 \u0111\u1ecbnh","unit_text":"Kh\u1ed1i","is_default":1,"status_text":"\u0110ang s\u1eed d\u1ee5ng","subtraction":1}],"circle_order":6,"deadline_bill":10,"bill_setting":{"note":{"content":null},"enable_qr":1,"payment_default":"cash","show_circle_day":0,"single_send_zalo":0,"template_bill_zalo":1,"enable_rounding_money":1,"extract_receipt_expense":0},"app_renter_setting":{"allow_update_car":1,"default_password":123456789,"allow_close_clock":0,"auto_create_account":0,"allow_ticket_contract":1,"allow_update_customer":1},"room_group":[{"id":1,"name":"T\u1ea7ng tr\u1ec7t","index":0,"label":"T\u1ea7ng tr\u1ec7t","value":1},{"id":2,"name":"T\u1ea7ng 1","index":1,"label":"T\u1ea7ng 1","value":2}],"max_member":1,"open_door":null,"close_door":null,"rule":null,"extension":null,"data_log":{"menu_label":{"pay_bill":0,"room_list":"0\/6","new_session":6,"deposit_request":6,"terminate_contract":0}},"setting":{"car_function":1,"post_function":1,"agent_function":1,"asset_function":1,"price_item_ele":3,"price_item_wifi":0,"price_item_trash":0,"price_item_water":3,"task_job_function":1,"send_sms_when_create_bill":1,"contract_document_function":0},"province_id":72,"district_id":712,"ward_id":25732,"address_component":{"address":"63, An T\u1ecbnh, Tr\u1ea3ng B\u00e0ng, T\u00e2y Ninh","ward_id":"25732","position":{"latitude":"10.7829132","longitude":"106.6961898"},"district_id":"712","province_id":"72","address_detail":"63"},"address":"63, An T\u1ecbnh, Tr\u1ea3ng B\u00e0ng, T\u00e2y Ninh","latitude":10.7829132,"longitude":106.6961898,"auto_create_room":1,"post_ids":[]}'>
                            <div style="width: 100%; height: 100%; align-items: center;
                            display: inherit;
                            text-align: center;
                            justify-content: center; color: #000" data-bs-toggle="tooltip" data-bs-placement="top" title="Chỉnh sửa Nhà trọ">
                                <i data-feather="edit"> </i>
                            </div>
                        </div>
                                               
                        <a class="btn-round btn-go-to"
                           data-bs-toggle="tooltip" data-bs-placement="top" title="Tới quản lý Nhà trọ"
                           href="/quan-ly/nha-tro/7081">
                            <i data-feather="arrow-right"> </i>
                        </a>
                    </div>
                            </div>
        </div>
    </div>
</div>
 <script type="text/javascript">
     $(document).ready(function() {
         $("#manageBlock .btn-edit").click(function(e){
             let ModalAddBlock = $($(this).data('bsTarget'));
             ModalAddBlock &&
             ModalAddBlock.data('block', $(this).data('block'));
         });

         $("#manageBlock .btn-delete").click(function(e){
             Swal.fire({
                 title: 'Thông báo!',
                 text: "Bạn có chắc chắn muốn xóa nhà trọ",
                 icon: 'warning',
                 showCancelButton: true,
                 cancelButtonColor: '#d33',
                 confirmButtonColor: '#3085d6',
                 confirmButtonText: 'Vâng! tôi muốn xóa',
                 cancelButtonText: 'Không xóa'
             }).then((result) => {
                 if (result.isConfirmed) {
                    $.transferData({
                        method: "GET",
                        url: __helper.url.urlPattern(__routeApi.block.delete, {
                                block_id : parseInt($(this).data('id')) }),
                        success: (res) => {
                            Swal.fire({
                                title: 'Thành công!',
                                text: res.message,
                                icon: 'success',
                                confirmButtonColor: '#3c9e47',
                                confirmButtonText: 'Đóng'
                            }).then((result) => {
                                window.location.href = "/quan-ly";
                            });
                        }
                    });
                 }
             });
         });
     });
 </script>
                <!-- Modal add block -->
<div class="modal fade" data-bs-backdrop="static"  id="addBlock" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div style="margin-right: 15px;outline: 0;box-shadow: 0 0 0 .25rem rgb(76 175 80 / 16%);opacity: 1;border-radius: 100%;width: 36px;height: 36px;justify-content: center;align-items: center;display: flex;background-color: #b1e1b8;">
                <i data-feather="home"> </i>
                </div>
                <h5 class="modal-title">Thêm nhà trọ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
            </div>
            <div class="modal-body">
                <form method="POST" class="needs-validation" id="add-block-form" novalidate>
                    <input type="hidden" name="_token" value="CZqXP04OzKEuLEt01gkxMY2DrN3sCqnCK8eSZ2o4">                    <div class="row g-3">
                        <div class="col-12">
                            <div class="title-item-small">
                                <b>Thông tin:</b>
                                <i class="des">Các thông tin nhà trọ cơ bản</i>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-floating">
                                <select data-format="numeric" id="category" name="category" class="form-select form-control" required>
                                                                                                                        <option value="0">Nhà trọ</option>
                                                                                    <option value="1">Ký túc xá/sleepbox</option>
                                                                                    <option value="2">Chung cư mini</option>
                                                                                    <option value="5">Tòa nhà chung cư</option>
                                                                                    <option value="3">Nhà nguyên căn</option>
                                                                                    <option value="4">Văn phòng cho thuê</option>
                                                                                                            </select>
                                <label for="category">Loại nhà trọ</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating">
                                <input type="text" class="form-control" name="name" id="name" required
                                    placeholder="Tên nhà trọ">
                                <label for="name">Tên nhà trọ</label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập tên nhà trọ
                                </div>
                            </div>
                        </div>

                        <div class="col-6 mt-2 invisible d-none">
                                                                                                <div class="form-check">
                                        <input class="form-check-input" type="radio" id="room_type_room" name="room_type" value="room">
                                        <label class="form-check-label" for="room_type_room">
                                            <b>Thuê theo phòng</b>
                                            <p>Tính tiền thuê theo phòng</p>
                                        </label>
                                    </div>
                                                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="room_type_bed" name="room_type" value="bed">
                                        <label class="form-check-label" for="room_type_bed">
                                            <b>Thuê theo giường</b>
                                            <p>Tính tiền theo giường</p>
                                        </label>
                                    </div>
                                                                                    </div>

                        <div class="col-12">
                            <div class="title-item-small">
                                <b>Chọn phương thức khởi tạo dữ liệu</b>
                                <i class="des">Chọn 1 trong 3 phương thức tạo khởi tạo dữ liệu</i>
                            </div>
                        </div>
                        <div class="col-12 mt-2 type-input-room hide-when-edit d-flex" style="text-align: center;">
                            <style type="text/css">
                                .type-input-room .item{
                                    width: 100%;
                                    border: 1px solid #ccc;
                                    margin: 5px;
                                    padding: 5px;
                                    border-radius: 10px;
                                }
                            </style>
                            <div class="item">
                                <div class="form-check form-check-inline">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="auto_create_room" id="enable" checked value="1">
                                    <label class="form-check-label" for="enable">
                                        <b>Tạo dữ liệu <span class="room_type_name">phòng</span> tự động </b>
                                    </label>
                                </div>
                            </div> 
                            <div class="item">  
                                <div class="form-check form-check-inline">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="auto_create_room" id="excel" value="2">
                                    <label class="form-check-label" for="excel">
                                        <b>Tạo dữ liệu <span class="room_type_name">phòng</span> từ Excel</b>
                                    </label>
                                </div>
                            </div>
                            <div class="item">
                                <div class="form-check form-check-inline">
                                    <input data-format="numeric" class="form-check-input" type="radio" name="auto_create_room" id="disable" value="0">
                                    <label class="form-check-label" for="disable">
                                        <b>Tạo dữ liệu <span class="room_type_name">phòng</span> thủ công </b>
                                    </label>
                                </div>
                            </div>    
                        </div>

                        <div class="col-12 mt-2 info-auto-create-room-enable">
                            <div class="loz-alert info mt-2 mb-2">
                                <div class="icon flex-0">
                                    <i data-feather="info" size="20"> </i>
                                </div>
                                <div class="des flex-1">
                                    <b>Ghi chú:</b> Vui lòng chọn số tầng và nhập số <span class="room_type_name">phòng</span> để hệ thống tự động tạo dữ liệu <span class="room_type_name">phòng</span> cho bạn
                                </div>
                            </div>
                        </div>

                        <div class="col-12 mt-2 d-none info-auto-create-room-disable">
                            <div class="loz-alert warning mt-2 mb-2">
                                <div class="icon flex-0">
                                    <i data-feather="info" size="20"> </i>
                                </div>
                                <div class="des flex-1">
                                    <b>Ghi chú:</b> Bạn phải thực hiện tạo dữ liệu cho từng <span class="room_type_name">phòng</span> bằng thủ công.
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-none import-from-excel-layout">
                            <style type="text/css">
                                .stepProgress {
                                    position: relative;
                                    padding-left: 45px;
                                    list-style: none;
                                }
                                .stepProgress::before {
                                    display: inline-block;
                                    content: '';
                                    position: absolute;
                                    top: 0;
                                    left: 15px;
                                    width: 10px;
                                    height: 100%;
                                    border-left: 2px solid #CCC;
                                }
                                .stepProgress-item {
                                    position: relative;
                                    counter-increment: list;
                                }
                                .stepProgress-item:not(:last-child) {
                                    padding-bottom: 20px;
                                }
                                .stepProgress-item::before {
                                    display: inline-block;
                                    content: '';
                                    position: absolute;
                                    left: -30px;
                                    height: 100%;
                                    width: 10px;
                                }
                                .stepProgress-item::after {
                                    content: '';
                                    display: inline-block;
                                    position: absolute;
                                    top: 0;
                                    left: -39px;
                                    width: 20px;
                                    height: 20px;
                                    border: 2px solid #CCC;
                                    border-radius: 50%;
                                    background-color: #FFF;
                                }
                            </style>
                            <ul class="stepProgress">
                                <li class="stepProgress-item">Bước 1: Tải file mẫu</li>
                                <li class="stepProgress-item">Bước 2: Nhập dữ liệu của bạn vào file mẫu</li>
                                <li class="stepProgress-item">Bước 3: Upload file mẫu lên để nhập liệu</li>
                            </ul>
                            <div class="row g-2">
                                <div class="col-6 mt-2 import-excel">
                                    <div class="image-upload-simple" style="height: 100px;">
                                        <input type="file" style="display: none" id="file-excel"  accept=".xlsx">
                                        <div class="container-upload " id="import-excel-trigger" style="border: 2px dashed #ccc;">
                                            <div class="placeholder __add-more-imge" style="display: grid;cursor: pointer !important;width: 100%;align-items: center;justify-content: center;height: 100%;margin:-10px;">
                                                <div class="icon-upload" style="margin:auto"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload-cloud"><polyline points="16 16 12 12 8 16"></polyline><line x1="12" y1="12" x2="12" y2="21"></line><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path><polyline points="16 16 12 12 8 16"></polyline></svg>
                                                </div>
                                                <label style="text-decoration:underline" id="text-import">File Excel cần nhập dữ liệu</label>
                                            </div>
                                        </div>
                                        <div class="invalid-feedback"> Vui lòng chọn file Excel</div>
                                    </div>
                                </div>
                                <div class="col-6 mt-2 download-template-excel">
                                    <a href="/download-template-excel" style=" color: inherit;">
                                        <div class="image-upload-simple" style="height: 100px;">
                                            <div class="container-upload " id="download-excel-trigger" style="border: 2px dashed #ccc;">
                                                <div class="placeholder __add-more-imge" style="display: grid;cursor: pointer !important;width: 100%;align-items: center;justify-content: center;height: 100%;margin:-10px;">
                                                    <div class="icon-upload" style="margin:auto">
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="main-grid-item-icon" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                                            <polyline points="8 17 12 21 16 17" />
                                                            <line x1="12" x2="12" y1="12" y2="21" />
                                                            <path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29" />
                                                        </svg>
                                                    </div>
                                                    <label style="text-decoration:underline" id="text-download">Tải file Excel mẫu</label>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                
                                </div>
                            </div>
                        </div>

                        <div class="col-6 mt-2 count_floor">
                            <div class="form-floating">
                                <select data-format="numeric" id="count_floor" name="count_floor" class="form-select form-control" required>
                                                                                                                        <option value="1">Tầng trệt (không có tầng)</option>
                                                                                    <option value="2">2 tầng (Gồm 1 trệt + 1 tầng)</option>
                                                                                    <option value="3">3 tầng (Gồm 1 trệt + 2 tầng)</option>
                                                                                    <option value="4">4 tầng (Gồm 1 trệt + 3 tầng)</option>
                                                                                    <option value="5">5 tầng (Gồm 1 trệt + 4 tầng)</option>
                                                                                    <option value="6">6 tầng (Gồm 1 trệt + 5 tầng)</option>
                                                                                    <option value="7">7 tầng (Gồm 1 trệt + 6 tầng)</option>
                                                                                    <option value="8">8 tầng (Gồm 1 trệt + 7 tầng)</option>
                                                                                                            </select>
                                <label for="count_floor">Loại nhà trọ</label>
                            </div>
                        </div>
                       
                        <div class="col-6 mt-2 total-room">
                            <div class="form-floating">
                                <input data-format="numeric" type="text" class="form-control" name="room_total" id="room_total" placeholder="Số phòng/giường" required>
                                <label for="room_total">Số <span class="room_type_name">phòng</span></label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập tổng số <span class="room_type_name">phòng</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="title-item-small">
                                <b>Địa chỉ:</b>
                                <i class="des">Giúp cho khách thuê của bạn có thể tìm thấy nhà trọ của bạn dễ
                                    dàng hơn</i>
                            </div>
                        </div>
                        <div class="col-12">
                            <div id="block_address" class="address_component_container row g-2">
    <div class="col-6 mt-2">
        <div class="form-floating">
            <select data-format="numeric" name="address_component[province_id]" class="form-select form-control province" required>
                <option value="">Tỉnh/Thành phố</option>
            </select>
            <label for="province">Chọn Tỉnh/Thành phố</label>
            <div class="invalid-feedback">
                Vui lòng chọn thành phố
            </div>
        </div>
    </div>
    <div class="col-6 mt-2">
        <div class="form-floating">
            <select data-format="numeric" name="address_component[district_id]" class="form-select form-control district" required>
                <option value="">Quận/Huyện</option>
            </select>
            <label for="district">Chọn Quận/Huyện</label>
            <div class="invalid-feedback">
                Vui lòng chọn quận hoặc huyện
            </div>
        </div>
    </div>
    <div class="col-12 mt-2">
        <div class="form-floating">
            <select data-format="numeric" name="address_component[ward_id]" class="form-select form-control ward" required>
                <option value="">Phường/Xã</option>
            </select>
            <label for="ward">Chọn Phường/Xã</label>
            <div class="invalid-feedback">
                Vui lòng chọn phường hoặc xã
            </div>
        </div>
    </div>
    <div class="col-12 mt-2">
        <div class="form-floating">
            <input type="text" class="form-control address_detail" name="address_component[address_detail]"
                placeholder="ví dụ: 122 - Đường Nguyễn Duy Trinh" required>
            <label for="address_detail">Địa chỉ chi tiết. Ví dụ: 122 - Đường Nguyễn Duy Trinh</label>
            <div class="invalid-feedback">
                Vui lòng nhập địa chỉ chi tiết
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        let __el = {
            province: $("#block_address").find(".province"),
            district: $("#block_address").find(".district"), 
            ward    : $("#block_address").find(".ward"),

            address_detail : $("#block_address").find(".address_detail"),
            address_show_container: $("#block_address").find(".address-detail-show-container"),  
            address_show: $("#block_address").find(".address-detail-show"),   
        };

        function getAddressFull(){
            let arrayText = [
                __el.address_detail.val(),
                __el.ward.find('option:selected').text().trim(),
                __el.district.find('option:selected').text().trim(),
                __el.province.find('option:selected').text().trim() 
            ];
            if(arrayText[0].lengh!=='' && arrayText[1].lengh!=='' && arrayText[2].lengh!=='' && arrayText[2].lengh!==''){
                __el.address_show_container.show();
                __el.address_show.text(arrayText.join(', '));
            }else{
                __el.address_show_container.hide();
            }
        }

        __el.address_detail.keyup((e)=>{
            getAddressFull();
        });

        __el.province.change(function(){
            __el.district.empty();
            __el.ward.empty();

            $.transferData({
                url: __helper.url.urlPattern(__routeApi.location.showProvince, {
                        id : parseInt($(this).val())
                    }),
                method: 'GET',
                success:function(res){
                     __el.district.append(`<option value=''>Quận/Huyện</option>`);
                    $.each(res.data.districts, function(key, value) {
                        __el.district.append(`<option value='${value.id}'>${value.name}</option>`);
                    });
                    getAddressFull();
                }
            });

        });

        __el.district.change(function(){
            __el.ward.empty();
            $.transferData({
                url: __helper.url.urlPattern(__routeApi.location.showDistrict, {
                        id : parseInt($(this).val())
                    }),
                method: 'GET',
                success:function(res){
                    __el.ward.append(`<option value=''>Phường/Xã</option>`);
                    $.each(res.data.wards, function(key, value) {
                        __el.ward.append(`<option value='${value.id}'>${value.name}</option>`);
                    });
                    getAddressFull();
                }
            });
        });

        __el.ward.change(function(){
            getAddressFull();
        });
    });
</script> 

                        </div>
                       
                        <div class="col-12 mt-2 text-center" style="display: none">
                            <div style="border: 1px solid #ccc; border-radius: 5px; padding: 10px">
                                <i data-feather="map-pin"></i>
                                <input type="hidden" required value="10.7829132" class="form-control" name="address_component[position][latitude]" id="address_component[position][latitude]">
                                <input type="hidden" required value="106.6961898" class="form-control" name="address_component[position][longitude]" id="address_component[position][longitude]">
                                <div class="invalid-feedback">
                                    Vui lòng thêm vị trí nhà trọ
                                </div>
                                <b>Vị trí nhà trọ</b>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="title-item-small">
                                <b>Thông tin cơ bản:</b>
                                <i class="des not-edit">Thông tin diện tích, giá thuê, số lượng thành viên</i>
                                <i class="des note" style="color:red; display: none"> <b>*Các thông tin dưới đây chỉ áp dụng cho lúc tạo nhà trọ tự động và khởi tạo đăng tin cho thuê</b></i>
                            </div>
                        </div>

                        <div class="col-6 hide-when-not-room">
                            <div class="form-floating">
                                <input data-format="numeric" type="text" class="form-control" name="area" id="area" value="15" required placeholder="Nhập diện tích">
                                <label for="area">Diện tích (m2)</label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập diện tích
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating">
                                <input data-format="numeric" type="text" class="form-control" name="room_amount" id="room_amount" placeholder="Giá thuê" required>
                                <label for="room_amount">Giá thuê trung bình (đ)</label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập giá thuê
                                </div>
                            </div>
                        </div>

                        <div class="col-12 hide-when-not-room">
                            <div class="form-floating">
                                <select data-format="numeric" id="max_member" name="max_member" class="form-select form-control">
                                                                                                                        <option value="1">1 người ở</option>
                                                                                    <option value="2">2 người ở</option>
                                                                                    <option value="3">3 người ở</option>
                                                                                    <option value="4">4 người ở</option>
                                                                                    <option value="5">5-6 người ở</option>
                                                                                    <option value="6">7-10 người ở</option>
                                                                                    <option value="0">Không giới hạn</option>
                                                                                                            </select>
                                <label for="max_member">Tối đa người ở / <span class="room_type_name">phòng</span></label>
                            </div>
                        </div>

                        <div class="col-12 hide-when-edit">
                            <div class="title-item-small">
                                <b>Cài đặt dịch vụ:</b>
                                <i class="des">Thiết lập các dịch vụ khi khách thuê sử dụng khi thuê</i>
                            </div>
                        </div>

                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-floating">
                                <select data-format="numeric" id="setting[price_item_ele]" name="setting[price_item_ele]" class="form-select form-control">
                                    <option value="0">Miễn phí/Không sử dụng</option>
                                    <option value="1">Tính theo người</option>
                                    <option value="2">Tính theo tháng</option>
                                    <option value="3" selected>Tính theo đồng hồ (phổ biến)</option>
                                </select>
                                <label for="setting[price_item_ele]">Dịch vụ điện</label>
                            </div>
                        </div>
                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-floating">
                                <select data-format="numeric" id="setting[price_item_water]" name="setting[price_item_water]" class="form-select form-control">
                                    <option value="0">Miễn phí/Không sử dụng</option>
                                    <option value="1">Tính theo người</option>
                                    <option value="2">Tính theo tháng</option>
                                    <option value="3" selected>Tính theo đồng hồ (phổ biến)</option>
                                </select>
                                <label for="setting[price_item_water]">Dịch vụ nước</label>
                            </div>
                        </div>
                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-floating">
                                <select data-format="numeric" id="setting[price_item_trash]" name="setting[price_item_trash]" class="form-select form-control">
                                    <option value="0">Miễn phí/Không sử dụng</option>
                                    <option value="1">Tính theo người</option>
                                    <option value="2">Tính theo tháng</option>
                                </select>
                                <label for="setting[price_item_trash]">Dịch vụ rác</label>
                            </div>
                        </div>

                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-floating">
                                <select data-format="numeric" id="setting[price_item_wifi]" name="setting[price_item_wifi]" class="form-select form-control">
                                    <option value="0">Miễn phí/Không sử dụng</option>
                                    <option value="1">Tính theo người</option>
                                    <option value="2">Tính theo tháng</option>
                                </select>
                                <label for="setting[price_item_wifi]">Dịch vụ wifi/internet</label>
                            </div>
                        </div>

                        <div class="col-12 hide-when-edit">
                            <div class="title-item-small">
                                <b>Cài đặt tính năng:</b>
                                <i class="des">Thiết lập các tính năng cho nhà trọ</i>
                            </div>
                        </div>

                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" value="1" id="setting[asset_function]" name="setting[asset_function]"
                                       checked>
                                <label class="form-check-label" for="setting[asset_function]">
                                    <b>Quản lý tài sản</b>
                                    <p>Quản lý tài sản khách thuê sử dụng</p>
                                </label>
                            </div>
                        </div>

                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" value="1" id="setting[car_function]" name="setting[car_function]" checked>
                                <label class="form-check-label" for="setting[car_function]">
                                    <b>Quản lý xe</b>
                                    <p>Các thông tin xe của khách thuê</p>
                                </label>
                            </div>
                        </div>

                        <div class="col-6 mt-2">
                            <div class="form-check form-switch">
                                <input data-format="numeric" class="form-check-input" type="checkbox" value="1" id="setting[agent_function]" name="setting[agent_function]" checked>
                                <label class="form-check-label" for="setting[agent_function]">
                                    <b>Quản lý mô giới</b>
                                    <p>Các thông tin về mô giới</p>
                                </label>
                            </div>
                        </div>
                
                        <div class="col-6 mt-2">
                            <div class="form-check form-switch">
                                <input data-format="numeric" class="form-check-input" type="checkbox" value="1" id="setting[post_function]" name="setting[post_function]" checked>
                                <label class="form-check-label" for="setting[post_function]">
                                    <b>Quản lý tin đăng</b>
                                    <p>Các thông tin về tin đăng</p>
                                </label>
                            </div>
                        </div>

                        <div class="col-6 mt-2 hide-when-edit">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" value="1" id="setting[send_sms_when_create_bill]" name="setting[send_sms_when_create_bill]"
                                    checked>
                                <label class="form-check-label" for="setting[send_sms_when_create_bill]">
                                    <b>Gửi tin nhắn tự động cho khách thuê</b>
                                    <p>Giửi tin nhắn SMS tự động cho khách thuê sau khi lập phiếu</p>
                                </label>
                            </div>

                        </div>

                        <div class="col-12">
                            <div class="title-item-small">
                                <b>Cài đặt cho phiếu thu (hóa đơn):</b>
                                <i class="des">Thiết lập cho hóa đơn khi bạn lập hóa đơn tiền thuê cho khách
                                    thuê</i>
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="form-floating">
                                <input data-format="numeric" type="text" class="form-control" id="circle_order" name="circle_order" placeholder="Ngày lập hóa đơn"  min="1" max="31" required>
                                <label for="circle_order">Ngày lập hóa đơn và trong khoảng 1 đến 31</label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập ngày lập hóa đơn
                                </div>
                            </div>
                            <div class="loz-alert info mt-2 mb-2">
                                <div class="icon flex-0">
                                    <i data-feather="info" size="20"> </i>
                                </div>
                                <div class="des flex-1">
                                    <b>Thông tin:</b> Khi đến ngày lập hóa đơn hệ thống sẽ nhắc nhở qua
                                    thông báo
                                </div>
                            </div>
                            <p>
                                - Là ngày lập hóa đơn tiền điện, nước...<br>
                                - Nhập một ngày trong tháng. Nếu không nhập mặc định là cuối tháng.
                            </p>
                        </div>

                        <div class="col-6">
                            <div class="form-floating">
                                <input data-format="numeric" type="text" class="form-control" id="deadline_bill" name="deadline_bill"
                                    placeholder="Ngày lập hóa đơn" min="1" max="20" required>
                                <label for="deadline_bill">Hạn đóng tiền</label>
                                <div class="invalid-feedback">
                                    Vui lòng nhập hạn đóng tiền và trong khoảng 1 đến 20 ngày
                                </div>
                            </div>
                            <div class="loz-alert info mt-2 mb-2">
                                <div class="icon flex-0">
                                    <i data-feather="info" size="20"> </i>
                                </div>
                                <div class="des flex-1">
                                    <b>Thông tin:</b> Khi khách đóng tiền không đúng thời hạn hệ thống sẽ nhắc nhở
                                </div>
                            </div>
                            <p>
                                <b>Ví dụ:</b> Bạn lập phiếu ngày 01 và hạn đóng tiền thuê trọ ở đây là 5 ngày thì ngày 05
                                sẽ là ngày hết hạn
                            </p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer--sticky">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="submit-block" class="btn btn-primary">
                    <i data-feather="plus"> </i>
                    Thêm nhà trọ
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function(){
        var __el = {
            form    : $('#add-block-form'),
            modal   : $("#addBlock"),
            submit  : $('#submit-block'),
            province: $("#province"),
            district: $("#district"),
            ward    : $("#ward"),

        };

        let dataBlock =  null;

        const excelFile = (file)=> {
            try {
                var reader = new FileReader();
                reader.readAsBinaryString(file);
                reader.onload = function(e) {
            
                    var data = e.target.result;

                    var workbook = XLSX.read(data, {
                        type : 'binary',
                        UTC  : false
                    });

                    if(workbook.SheetNames && workbook.SheetNames.length!==0){
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                        if (jsonData.length !== 0) {
                            let header = jsonData[0];
                            let data = [];
                            jsonData.forEach((row, rowIndex) => {
                                if(row.length!==0 && rowIndex !== 0){
                                    data[rowIndex] = []
                                    row.forEach((value, colIndex) => {
                                        let header = jsonData[0][colIndex];
                                        data[rowIndex].push({
                                            colIndex: colIndex,
                                            name: header,
                                            value: value
                                        });
                                    })
                                }
                            
                            })

                            $.transferData({
                                method: "POST",
                                url: __helper.url.urlPattern(__routeApi.checkDataFromFile),
                                data : {
                                    data_excel: data
                                },
                                success: (res) => {
                                    __el.form.find('#count_floor').val(res.data.count_floor).change();
                                    Swal.fire({
                                        title: 'Thành công!',
                                        text: res.message,
                                        icon: 'success',
                                        confirmButtonColor: '#3c9e47',
                                        confirmButtonText: 'Đóng'
                                    });
                                },
                                fail: (res) => {
                                    Swal.fire({
                                        title: 'Dữ liệu không chính xác',
                                        html: res.message,
                                        icon: 'error',
                                        confirmButtonText: 'Đã hiểu'
                                    });

                                    $('#file-excel').val('');
                                    $('#text-import').text('Chưa có tệp nào được chọn');
                                }
                            });
                        }
                    }
                }
            }catch(e){
                console.error(e);
            }
        }

        const changeRoomType = (room_type)=>{
            if(room_type ==='room'){
                __el.form.find('input[name="room_total"]').attr('placeholder', 'Nhập số phòng');
                __el.form.find('.room_type_name').text('phòng');
                __el.form.find('.hide-when-not-room').show();

            }else{
                __el.form.find('input[name="room_total"]').attr('placeholder', 'Nhập số giường');
                __el.form.find('.room_type_name').text('giường');
                __el.form.find('.hide-when-not-room').hide();
            }
        };

        __el.form.find("#import-excel-trigger").on("click", function() {
            __el.form.find("#file-excel").click();
        });
        
        __el.modal.find("#province").change(function(){
            __el.modal.find("#district").empty();
            __el.modal.find("#ward").empty();

            $.transferData({
                url: __helper.url.urlPattern(__routeApi.location.showProvince, {
                        id : parseInt($(this).val())
                    }),
                method: 'GET',
                loadingEle:false,
                success:function(res){
                    __el.modal.find("#district").append(`<option value=''>Chọn Quận/Huyện</option>`);
                    $.each(res.data.districts, function(key, value) {
                        __el.modal.find("#district").append(`<option value='${value.id}'>${value.name}</option>`);
                    });
                }
            });

        });

        __el.modal.find("#district").change(function(){
            __el.modal.find("#ward").empty();
            $.transferData({
                url: __helper.url.urlPattern(__routeApi.location.showDistrict, {
                        id : parseInt($(this).val())
                    }),
                method: 'GET',
                loadingEle:false,
                success:function(res){
                    __el.modal.find("#ward").append(`<option value=''>Chọn Phường/Xã</option>`);
                    $.each(res.data.wards, function(key, value) {
                        __el.modal.find("#ward").append(`<option value='${value.id}'>${value.name}</option>`);
                    });
                }
            });
        });


        __el.form.on("change","#file-excel", function(e) {
            var file = e.target.files[0];
            if (file) {
                __el.form.find("#text-import").text(file.name)
                excelFile(file);
            } else {
                alert("Vui lòng chọn file excel để tiếp tục!");
            }
        });

        __el.form.on('change', 'input[name="room_type"]', function (e) {
            changeRoomType($(this).val())
        });

        __el.form.on('change', 'select[name="category"]', function (e) {
            if($(this).val() == 1)
                __el.form.find('#room_type_bed').prop('checked', true).change();
            else
                __el.form.find('#room_type_room').prop('checked', true).change();
                
        });

        __el.form.on('change', 'input[name="auto_create_room"]', function (e) {
            if (__el.form.find("#disable").is(':checked')) {
                __el.form.find("#file-excel").removeAttr('required'); 
                __el.form.find("#room_total").removeAttr('required');

                __el.form.find("#room_total").attr("disabled", true);
                __el.form.find("#room_total").val(0);

                __el.form.find('.total-room').removeClass("d-none");
                __el.form.find('.count_floor').removeClass("d-none");   
                __el.form.find('.import-from-excel-layout').addClass("d-none");  
                __el.form.find(".info-auto-create-room-enable").addClass("d-none");
                __el.form.find(".info-auto-create-room-disable").removeClass("d-none");
                __el.form.find('.total-room').addClass("d-none");
                __el.form.find('.count_floor').addClass("d-none");  

                __el.form.find('#file-excel').val('');
                __el.form.find('#text-import').text('File Excel cần nhập dữ liệu');

            } else if (__el.form.find("#enable").is(':checked')) {
                __el.form.find("#room_total").attr('required', 'required');
                __el.form.find("#file-excel").removeAttr('required');   

                __el.form.find("#room_total").removeAttr("disabled");
                __el.form.find("#room_total").val('');

                __el.form.find('.total-room').removeClass("d-none");
                __el.form.find('.count_floor').removeClass("d-none");   
                __el.form.find(".info-auto-create-room-enable").removeClass("d-none");
                __el.form.find(".info-auto-create-room-disable").addClass("d-none");

                __el.form.find('.import-from-excel-layout').addClass("d-none"); 

                __el.form.find('#file-excel').val('');
                __el.form.find('#text-import').text('File Excel cần nhập dữ liệu');

            } else if (__el.form.find("#excel").is(':checked')) {
                __el.form.find('.total-room').addClass("d-none");
                __el.form.find('.count_floor').addClass("d-none");    
                __el.form.find(".info-auto-create-room-enable").addClass("d-none");
                __el.form.find('.import-from-excel-layout').removeClass("d-none");     
                __el.form.find(".info-auto-create-room-disable").addClass("d-none");
                __el.form.find("#room_total").removeAttr('required');  
                 
                __el.form.find("#file-excel").attr('required', 'required');    
            }
        });

        __el.form.on('change', '#room_total', function (e) {
            if(parseInt($(this).val()) === 0){
                __el.form.find('#auto_create_room').prop('checked', false);
                __el.form.find("#auto_create_room").attr("disabled", true);
            }else{
                __el.form.find('#auto_create_room').prop('checked', true);
                __el.form.find("#auto_create_room").removeAttr("disabled");
            }
        });

        
        new __modalForm(
            __el.modal.get(0),
            __el.form.get(0),
            __el.submit.get(0)
        ).start(null, {
            __openModalForm: function () {
                __el.form.get(0).reset();
                dataBlock = __el.modal.data('block');
                __el.modal.find('.title-disable').remove();
                __el.modal.find('input[name="count_floor"]').remove();
                __el.modal.find("#province").empty();
                __el.modal.find("#district").empty();
                __el.modal.find("#ward").empty();
                if(dataBlock){
                    __el.modal.find('.count_floor').before(`
                    <div class="col-12 title-disable">
                        <div class="title-item-small">
                            <b>Thông tin không thể chỉnh sửa:</b>
                            <i class="des">Các thông tin dưới đây không thể được chỉnh sửa</i>
                        </div>
                    </div>`);
                    __el.modal.find('.not-edit').hide();
                    __el.modal.find('.note').show();
                    __el.modal.find('#count_floor').attr("disabled", true);
                    __el.modal.find('#count_floor').after(`<input type="hidden" data-format="numeric" class="form-control" name="count_floor" placeholder="Số phòng/giường" value="${dataBlock.count_floor}">`);
                    __el.modal.find('#room_total').attr("readonly", true);
                    __el.modal.find('.hide-when-edit').addClass("d-none");
                    
                    $.transferData({
                        method: "POST",
                        url: __helper.url.urlPattern(__routeApi.location.init),
                        data: {
                            'province_id': dataBlock.province_id,
                            'district_id': dataBlock.district_id,
                            'ward_id': dataBlock.ward_id,
                        },
                        loadingEle:false,
                        success: (res) => {
                            $.each(res.data.provinces, function(key, province) {
                                __el.modal.find(".province").append(`<option value='${province.id}'>${province.short_name}</option>`);
                                if(parseInt(province.id) === parseInt(dataBlock.province_id))
                                    $(`.province option[value=${province.id}]`).prop('selected', true);
                            });

                            $.each(res.data.districts, function(key, district) {
                                __el.modal.find(".district").append(`<option value='${district.id}'>${district.name}</option>`);
                                if(parseInt(district.id) === parseInt(dataBlock.district_id))
                                    $(`.district option[value=${district.id}]`).prop('selected', true);
                            });

                            $.each(res.data.wards, function(key, ward) {
                                __el.modal.find(".ward").append(`<option value='${ward.id}'>${ward.name}</option>`);
                                if(parseInt(ward.id) === parseInt(dataBlock.ward_id))
                                    $(`.ward option[value=${ward.id}]`).prop('selected', true);
                            });
                        },
                    });

                    __el.modal.find('.modal-title').text(`Chỉnh sửa ${dataBlock.category_name} ${dataBlock.name}`);
                    __el.modal.find('.modal-footer .btn-primary').text(`Chỉnh sửa ${dataBlock.category_name}`);
                    __el.form.setObjectToForm(dataBlock);
                    changeRoomType(dataBlock.room_type);
                }else{
                    __el.modal.find('.not-edit').show();
                    __el.modal.find('.note').hide();
                    __el.modal.find('input[name="count_floor"]').remove();
                    __el.modal.find('.title-disable').remove();
                    __el.modal.find('#count_floor').attr("disabled", false);
                    __el.modal.find('#room_total').attr("readonly", false);
                    __el.form.find('input[name="room_type"]').val(['room']);
                    __el.modal.find('.hide-when-edit').removeClass("d-none");
                    changeRoomType('room');

                    __el.modal.find(".district").empty();
                    __el.modal.find(".ward").empty();
                    if(!__el.modal.find(".province option[value='79']").length){
                        $.transferData({
                            method: "GET",
                            url: __helper.url.urlPattern(__routeApi.location.provinces),
                            loadingEle:false,
                            success: (res) => {
                                __el.modal.find(".province").empty();
                                __el.modal.find(".province").append(`<option value=''>Chọn Tỉnh/Thành phố</option>`);
                                $.each(res.data, function(key, value) {
                                    __el.modal.find(".province").append(`<option value='${value.id}'>${value.short_name}</option>`);
                                });
                            },
                        });
                    }
                }
            },
            __closeModalForm: function () {
                __el.form.get(0).reset();
                __el.form.get(0).classList.remove('was-validated');

                __el.modal.data('block', null);

                __el.modal.find('.modal-title').text("Thêm nhà trọ");
                __el.modal.find('.modal-footer .btn-primary').text("Thêm nhà trọ");
                __el.modal.find('input[name="auto_create_room"][value="1"]').prop('checked', true).change();
            },
            __submitModalForm: function(e){
                let data = __el.form.getObjectOfForm();
                if (!__el.form.get(0).checkValidity()) {
                    __el.form.get(0).classList.add('was-validated');
                    Swal.fire({
                        title: 'Thông báo!',
                        text: "Vui lòng nhập đầy đủ thông tin trước khi thực hiện",
                        icon: 'error',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return false;
                }

                if(parseInt(__el.form.find('input[name="auto_create_room"]:checked').val()) === 2){}
                    data.file = $("#file-excel")[0].files[0]
     
                data.address_component['address'] = ([
                    __el.modal.find(".address_detail").val(),
                    __el.modal.find(".ward option:selected").val() ? __el.modal.find(".ward option:selected").text() : '',
                    __el.modal.find(".district option:selected").val() ? __el.modal.find(".district option:selected").text() : '',
                    __el.modal.find(".province option:selected").val() ? __el.modal.find(".province option:selected").text() : '',
                ]).join(', ');

                let url  = !dataBlock ? __helper.url.urlPattern(__routeApi.block.create) : __helper.url.urlPattern(__routeApi.block.update, {
                    block_id : parseInt(dataBlock.id)
                });
  
                $.transferForm({
                    method: "POST",
                    url,
                    data ,
                    success: function(res) {
                        Swal.fire({
                            title: 'Thành công!',
                            text: res.message,
                            icon: 'success',
                            confirmButtonColor: '#3c9e47',
                            confirmButtonText: 'Đóng'
                        }).then((result) => {
                            window.location.href = "/quan-ly";
                        });
                    },
                    fail:(res)=>{
                        Swal.fire({
                            title: 'Thông báo!',
                            text: res.message,
                            icon: 'error',
                            confirmButtonText: 'Đã hiểu'
                        });
                    }
                });
            },
        });
    });
</script>
    </div>
    <div class="text-center mt-5"><span style="color: #727272; font-style: italic;">Copyright @ <strong style="color: #000">HPT-NTMT</strong> 2020</span></div>
<div class="text-center"><p style="color: #727272; font-style: italic;">Version <strong style="color: #000">1.3.8</strong></p></div>
<div class="zalo-container fix item-contact">
    <a id="zalo-btn"
       href="https://zalo.me/0965227453"
       target="_blank" rel="noopener">
        <div class="animated_zalo infinite zoomIn_zalo cmoz-alo-circle"></div>
        <div class="animated_zalo infinite pulse_zalo cmoz-alo-circle-fill"></div>
        <span>
            <img width="100%"
                   src="https://quanlytro.me/images/icons/zalo-icon-white.webp"
                   alt="Liên hệ với LOZIDO - Quản lý nhà cho thuê qua Zalo">
        </span>
    </a>
</div>

<script>
    feather.replace();

    $(document).ready(function () {
        $(document).find('input[data-format="numeric"][type="text"]').map((key, element) => {
            element.addEventListener('keyup', e => {
                let value = $(element).val();
                let number = __helper.convertStringToNumber(value);
                let newVal = __format.currencyInput(number);
                
                $(element).val(value ==='' ? '': isNaN(number) ? '': newVal);
            });
        });

        $(document).find('input[data-format="stringNumber"]').map((key, element) => {
            element.addEventListener('keyup', e => {
                $(element).val(__format.phone($(element).val()));
            });
        });

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        setTimeout(() => {
                $.transferData({
                    url: __helper.url.urlPattern(__routeApi.notification.all,{
                        page: 1
                    }),
                    loadingEle:false,
                    success: (res) => {
                        $('.count-notification').text(res?.data?.unread_count ?? 0);
                        res?.data?.notifications?.length > 0 &&
                        $(".notication-dropdown").html('') &&
                        res.data.notifications.map((notification)=>{
                            $(".notication-dropdown").append($(`
                                <li style="cursor: pointer" class="item-notication d-flex align-items-center">
                                        <div class="icon ${!notification?.read_at ? 'not-read':''}">
                                            <i data-feather="bell" size="20"></i>
                                        </div>
                                        <div class="content">
                                            <div class="des">
                                                <b>
                                                    ${notification?.data?.title ?? ''}
                                                </b>
                                                <p>${notification?.data?.body ?? ''}</p>
                                            </div>
                                            <div class="time">${notification?.created_at ?? ''}</div>
                                        </div>
                                </li>
                            `).click((e)=>{
                                Swal.fire({
                                    title: 'Thông báo!',
                                    text: "Tính năng đi đến thông báo đang phát triển. Hệ thống sẽ hoàn thành sớm!",
                                    icon: 'warning',
                                    confirmButtonText: 'Đã hiểu'
                                });
                            }));
                        });
                        feather.replace();
                    },
                    fail:(res)=>{

                    }
            });
        }, 5000);
       
    });
</script>
</body>
</html>
